<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>æˆ‘ä»¬çš„æ•…äº‹</title>
<style>
:root{
  --pc:#7a9a8a;--pd:#5d7a6a;--pl:#a8c5b5;
  --bg:#f0f5f2;--bg2:#e5ebe8;
  --cb:rgba(255,255,255,.92);--tc:#3d3d3d;--ts:#888;
  --ss:0 2px 8px rgba(0,0,0,.06);--sm:0 4px 16px rgba(0,0,0,.1);
  --sl:0 8px 30px rgba(0,0,0,.15);
  --rs:12px;--rm:18px;--rl:24px;
}
[data-theme="red"]{--pc:#c9897a;--pd:#a8685d;--pl:#e5b5a8;--bg:#f8f0ee;--bg2:#f0e5e2}
[data-theme="yellow"]{--pc:#b0a06a;--pd:#8a7a44;--pl:#d5c58a;--bg:#f8f5ea;--bg2:#f0ebda}
[data-theme="white"]{--pc:#9a9a9a;--pd:#707070;--pl:#c5c5c5;--bg:#f8f8f8;--bg2:#f0f0f0}
[data-theme="black"]{--pc:#6a6a6a;--pd:#444;--pl:#8a8a8a;--bg:#ececec;--bg2:#e0e0e0}
[data-theme="green"]{--pc:#7a9a8a;--pd:#5d7a6a;--pl:#a8c5b5;--bg:#f0f5f2;--bg2:#e5ebe8}
[data-theme="blue"]{--pc:#7a8fa8;--pd:#5d6f85;--pl:#a8bdd5;--bg:#eef2f8;--bg2:#e2e8f0}
[data-theme="purple"]{--pc:#9a82ab;--pd:#755d8a;--pl:#c5aed5;--bg:#f4f0f8;--bg2:#eae5f0}
[data-night="true"]{
  --bg:#1a1d21;--bg2:#22262b;--cb:rgba(35,38,45,.95);
  --tc:#ccc;--ts:#777;
  --ss:0 2px 8px rgba(0,0,0,.2);--sm:0 4px 16px rgba(0,0,0,.3);
  --sl:0 8px 30px rgba(0,0,0,.4);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow-x:hidden}
body{
  font-family:-apple-system,"PingFang SC","Microsoft YaHei","Helvetica Neue",sans-serif;
  min-height:100vh;color:var(--tc);line-height:1.8;
  background-color:var(--bg);background-size:cover;
  background-position:center;background-attachment:fixed;
  transition:background-color .4s,color .4s;
}
.lock-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(160deg,var(--bg),var(--bg2),var(--bg));display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9500;transition:transform .6s cubic-bezier(.4,0,.1,1),opacity .6s}
.lock-screen.hiding{transform:translateY(-100%);opacity:0}
.lock-screen.hidden{display:none}
.lock-icon{font-size:48px;margin-bottom:20px;opacity:.6}
.lock-title{font-size:22px;color:var(--pd);margin-bottom:8px;font-weight:400;letter-spacing:2px}
.lock-subtitle{font-size:13px;color:var(--pc);margin-bottom:30px;opacity:.7}
.lock-input-wrap{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.lock-input{width:200px;padding:12px 18px;border:2px solid var(--pl);border-radius:25px;font-size:15px;text-align:center;background:var(--cb);color:var(--tc);outline:none;letter-spacing:4px;font-family:inherit}
.lock-input:focus{border-color:var(--pc)}
.lock-input.error{border-color:#e57373;animation:lkS .4s}
@keyframes lkS{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.lock-submit{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--pc),var(--pd));border:none;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:var(--ss)}
.lock-submit:active{transform:scale(.92)}
.lock-error-msg{font-size:12px;color:#e57373;height:18px}
.cover-page{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(160deg,var(--bg),var(--bg2),var(--bg));display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9000;touch-action:pan-y;transition:transform .7s cubic-bezier(.4,0,.1,1),opacity .7s;overflow:hidden}
.cover-page.hiding{transform:translateY(-100%);opacity:0}
.cover-page.hidden{display:none}
.particles-canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.particle-switcher{position:absolute;top:20px;right:15px;display:flex;gap:6px;z-index:10;flex-wrap:wrap;justify-content:flex-end;max-width:200px}
.particle-btn{background:var(--cb);border:2px solid transparent;width:38px;height:38px;border-radius:50%;font-size:16px;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;box-shadow:var(--ss)}
.particle-btn.active{background:var(--pc);border-color:#fff;transform:scale(1.1)}
.cover-title{font-size:42px;font-weight:300;letter-spacing:6px;color:var(--pd);margin-bottom:16px;text-align:center;padding:0 20px;position:relative;z-index:5}
.cover-subtitle{font-size:15px;color:var(--pc);margin-bottom:80px;opacity:.8;letter-spacing:3px;position:relative;z-index:5}
.cover-author{position:absolute;bottom:120px;left:30px;font-size:13px;color:var(--pc);opacity:.5;z-index:5}
.swipe-area{position:absolute;bottom:0;left:0;right:0;height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;z-index:5}
.swipe-hint{display:flex;flex-direction:column;align-items:center;color:var(--pc);animation:fUp 2.5s ease-in-out infinite}
.swipe-arrow{width:22px;height:22px;border-left:2.5px solid var(--pc);border-top:2.5px solid var(--pc);transform:rotate(45deg);margin-bottom:14px;opacity:.7}
.swipe-text{font-size:13px;opacity:.6;letter-spacing:2px}
.swipe-bar{position:absolute;bottom:25px;left:50%;transform:translateX(-50%);width:45px;height:4px;background:var(--pc);border-radius:2px;opacity:.35}
@keyframes fUp{0%,100%{transform:translateY(0);opacity:.7}50%{transform:translateY(-14px);opacity:1}}
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(160deg,var(--bg),var(--bg2));display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}
.loading-overlay.show{display:flex}
.loading-overlay.hiding{opacity:0}
.loading-title{font-size:42px;font-weight:300;color:var(--pd);margin-bottom:16px;letter-spacing:4px}
.loading-text{font-size:14px;color:var(--pc)}
.loading-dots::after{content:'';animation:ld 1.5s infinite}
@keyframes ld{0%,20%{content:''}40%{content:'.'}60%{content:'..'}80%,100%{content:'...'}}
</style>
<style>
.author-mark{position:fixed;font-size:11px;color:var(--pc);opacity:.4;z-index:50;pointer-events:none;letter-spacing:1px}
.author-mark.tl{top:12px;left:12px}.author-mark.br{bottom:68px;right:12px}
.main-page{display:none}.main-page.show{display:block}
.top-controls{position:fixed;top:10px;right:10px;z-index:50;display:none;gap:8px}
.top-controls.show{display:flex}
.ctrl-btn{background:var(--cb);border:none;padding:8px 14px;border-radius:22px;font-size:12px;color:var(--pd);cursor:pointer;box-shadow:var(--ss);backdrop-filter:blur(10px);font-family:inherit}
.ctrl-btn:active{transform:scale(.94)}
.theme-btn{width:38px;height:38px;padding:0;display:flex;align-items:center;justify-content:center;font-size:17px;border-radius:50%}
.music-player{background:var(--cb);border-radius:var(--rl);padding:18px 20px;margin-bottom:22px;box-shadow:var(--sm);display:flex;align-items:center;gap:18px;backdrop-filter:blur(10px)}
.disc-box{position:relative;width:72px;height:72px;flex-shrink:0}
.disc{width:72px;height:72px;border-radius:50%;background:conic-gradient(from 0deg,#1a1a1a,#333,#1a1a1a,#2a2a2a,#1a1a1a);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,.25),inset 0 0 15px rgba(0,0,0,.3);position:relative;overflow:hidden}
.disc::before{content:'';position:absolute;width:100%;height:100%;background:repeating-radial-gradient(circle,transparent 0,transparent 3px,rgba(255,255,255,.02) 3px,rgba(255,255,255,.02) 5px)}
.disc.playing{animation:dSp 6s linear infinite}
@keyframes dSp{to{transform:rotate(360deg)}}
.disc-center{width:32px;height:32px;border-radius:50%;background:#f0f0f0;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;z-index:2;cursor:pointer;border:2px solid #e0e0e0}
.disc-center img{width:100%;height:100%;object-fit:cover}
.disc-center .disc-ph{font-size:11px;color:#aaa}
.music-info{flex:1;min-width:0}
.music-title{font-size:14px;color:var(--pd);margin-bottom:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:500}
.music-ctrls{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.mbtn{background:linear-gradient(135deg,var(--pc),var(--pd));border:none;width:34px;height:34px;border-radius:50%;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.mbtn:active{transform:scale(.92)}
.mbtn.sm{width:28px;height:28px;font-size:10px;background:var(--pl);box-shadow:none}
.mprog{flex:1;height:4px;background:rgba(0,0,0,.08);border-radius:2px;overflow:hidden;cursor:pointer}
.mprog-bar{height:100%;background:linear-gradient(90deg,var(--pl),var(--pc));width:0%;border-radius:2px;transition:width .2s linear}
.mtime{font-size:11px;color:var(--ts);min-width:35px;text-align:right}
.mlist-btn{background:none;border:1px solid var(--pl);padding:5px 14px;border-radius:16px;font-size:12px;color:var(--pc);cursor:pointer;font-family:inherit}
.ovm{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.45);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.ovm.open{display:flex}
.ovm-c{background:var(--cb);border-radius:var(--rl);padding:24px;width:90%;max-width:400px;max-height:85vh;overflow-y:auto;box-shadow:var(--sl);animation:mIn .3s;color:var(--tc)}
@keyframes mIn{from{opacity:0;transform:translateY(20px) scale(.95)}to{opacity:1;transform:none}}
.ovm-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;padding-bottom:12px;border-bottom:1px solid rgba(0,0,0,.06)}
.ovm-h h3{font-size:17px;color:var(--pd);font-weight:600}
.ovm-x{background:rgba(0,0,0,.05);border:none;width:30px;height:30px;border-radius:50%;font-size:18px;color:var(--ts);cursor:pointer;display:flex;align-items:center;justify-content:center}
.mi{display:flex;align-items:center;padding:12px 14px;border-radius:var(--rs);margin-bottom:8px;background:var(--bg);gap:10px}
.mi.active{background:var(--pc);color:#fff}
.mi-idx{font-size:13px;font-weight:600;opacity:.5;width:20px;text-align:center}
.mi-nm{flex:1;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mi-btn{background:none;border:none;width:28px;height:28px;border-radius:50%;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--ts)}
.madd-btn{width:100%;padding:16px;border:2px dashed var(--pl);border-radius:var(--rs);background:none;color:var(--pc);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit}
.madd-btn:disabled{opacity:.4;cursor:not-allowed}
.container{max-width:500px;margin:0 auto;padding:16px;padding-top:50px;padding-bottom:100px}
.header{text-align:center;padding:36px 20px 28px;border-radius:var(--rl);margin-bottom:16px;box-shadow:var(--sm);background:var(--cb);background-size:cover;background-position:center;position:relative;overflow:hidden;backdrop-filter:blur(10px)}
.hd-bg{position:absolute;top:10px;right:10px;background:rgba(255,255,255,.75);border:none;padding:5px 12px;border-radius:16px;font-size:11px;color:var(--pd);cursor:pointer;z-index:2}
.header h1{font-size:26px;color:var(--pd);margin-bottom:8px;font-weight:500;letter-spacing:2px;position:relative;z-index:1}
.header p{color:var(--pc);font-size:14px;position:relative;z-index:1}
.ed{outline:none;border:none;border-radius:6px;transition:background .3s}
.ed:focus{background:rgba(122,154,138,.12);padding:2px 6px}
.quote-box{background:linear-gradient(145deg,var(--bg),var(--bg2));border-radius:var(--rm);padding:28px 24px;margin-bottom:20px;text-align:center;position:relative;box-shadow:var(--ss)}
.quote-box::before{content:'\201C';font-size:54px;color:var(--pc);opacity:.2;position:absolute;top:8px;left:22px;font-family:Georgia,serif;line-height:1}
.quote-box p{font-size:15px;color:var(--pd);font-style:italic;position:relative;z-index:1;line-height:1.9}
.quote-box .author{margin-top:12px;font-size:13px;color:var(--pc);opacity:.8}
.nb{background:var(--cb);border-radius:var(--rm);padding:22px;margin-bottom:20px;box-shadow:var(--ss);border-left:4px solid var(--pc);backdrop-filter:blur(10px)}
.nb-t{font-size:17px;color:var(--pd);margin-bottom:14px;padding-bottom:10px;border-bottom:1px dashed var(--pl);font-weight:500}
.nb-c{font-size:14px;min-height:60px;line-height:2}
.nb-d{font-size:12px;color:var(--pl);margin-top:14px;text-align:right}
</style>
<style>
.section-title{color:var(--pd);margin:28px 0 18px;font-size:19px;font-weight:500;letter-spacing:1px}
.photo-card{background:var(--cb);border-radius:var(--rl);overflow:hidden;margin-bottom:22px;box-shadow:var(--sm)}
.photo-wrap{position:relative;cursor:pointer;overflow:hidden}
.photo-wrap img{width:100%;height:220px;object-fit:cover;display:block;background:linear-gradient(135deg,#e8e8e8,#f5f5f5);transition:transform .3s}
.photo-wrap:active img{transform:scale(1.02)}
.photo-wrap .up-hint{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(93,122,106,.65);display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;opacity:0;transition:opacity .3s}
.photo-wrap:hover .up-hint,.photo-wrap:active .up-hint{opacity:1}
.up-hint span{font-size:36px;margin-bottom:8px}
.photo-card .caption{padding:18px 20px;text-align:center}
.photo-card .caption h3{font-size:15px;color:var(--pd);margin-bottom:6px;font-weight:500}
.photo-card .caption p{font-size:13px;color:var(--ts)}
input[type="file"]{display:none}
.cal-card{background:linear-gradient(140deg,var(--pc),var(--pd));border-radius:var(--rl);padding:28px 24px;margin-bottom:22px;text-align:center;color:#fff;box-shadow:var(--sl);position:relative;overflow:hidden}
.cal-card::before{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:rgba(255,255,255,.08);border-radius:50%}
.cal-card .days-count{font-size:52px;font-weight:200;margin:12px 0;letter-spacing:2px}
.cal-card .days-label{font-size:14px;opacity:.9;letter-spacing:2px}
.cal-card .start-date{font-size:12px;opacity:.65;margin-top:10px}
.cal-card .date-picker{margin-top:14px}
.cal-card .date-picker input{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);padding:8px 16px;border-radius:20px;color:#fff;font-size:14px;outline:none;font-family:inherit}
.cal-card .date-picker input::-webkit-calendar-picker-indicator{filter:invert(1)}
.album-book{background:linear-gradient(145deg,#8b7355,#6b5344);border-radius:var(--rs);padding:18px;margin-bottom:22px;box-shadow:var(--sl);cursor:pointer;transition:transform .3s}
.album-book:active{transform:scale(.97)}
.album-cover{background:linear-gradient(145deg,#a08060,#8b7355);border-radius:8px;padding:35px 20px;text-align:center;border:2px solid rgba(196,168,130,.6);position:relative}
.album-cover h2{color:#f5e6d3;font-size:22px;margin-bottom:8px;font-weight:400;letter-spacing:4px}
.album-cover p{color:#e8d5c4;font-size:13px}
.album-cover .book-spine{position:absolute;left:0;top:0;bottom:0;width:12px;background:linear-gradient(90deg,#4a3525,#6b5344);border-radius:8px 0 0 8px}
.nav-cards{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:22px}
.nav-card{background:var(--cb);border-radius:var(--rm);padding:22px 16px;text-align:center;box-shadow:var(--ss);cursor:pointer;transition:transform .2s;backdrop-filter:blur(10px)}
.nav-card:active{transform:translateY(-3px);box-shadow:var(--sm)}
.nav-card .icon{font-size:32px;margin-bottom:10px}
.nav-card h3{color:var(--pd);font-size:15px;margin-bottom:4px;font-weight:500}
.nav-card p{color:var(--ts);font-size:12px}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:1000;overflow-y:auto}
.modal.open{display:block}
.modal-box{max-width:500px;margin:0 auto;min-height:100vh;background:linear-gradient(160deg,var(--bg),var(--bg2))}
.modal-hd{background:var(--cb);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;box-shadow:var(--ss);backdrop-filter:blur(15px)}
.modal-hd h3{font-size:17px;color:var(--pd);font-weight:600}
.close-m{background:rgba(0,0,0,.05);border:none;width:32px;height:32px;border-radius:50%;font-size:20px;color:var(--ts);cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-bd{padding:18px;padding-bottom:30px}
.album-modal .modal-box{max-width:100%;background:#1a1a1a;background-size:cover;background-position:center}
.album-modal .modal-hd{background:rgba(255,255,255,.92)}
.album-modal .hd-left{display:flex;align-items:center;gap:10px}
.album-modal .abg-btn{background:var(--bg);border:none;padding:6px 14px;border-radius:16px;font-size:12px;color:var(--pd);cursor:pointer}
.album-modal .modal-bd{padding:24px 18px 100px;min-height:calc(100vh - 60px);display:flex;flex-direction:column;align-items:center}
.album-page{display:none;width:100%;max-width:320px}
.album-page.active{display:block}
.polaroid{background:#fff;padding:10px 10px 40px;margin-bottom:18px;box-shadow:0 4px 18px rgba(0,0,0,.25);position:relative;cursor:pointer;transition:transform .3s}
.polaroid:nth-child(odd){transform:rotate(-1.5deg)}
.polaroid:nth-child(even){transform:rotate(1.2deg)}
.polaroid:active{transform:rotate(0) scale(1.02)!important}
.polaroid img{width:100%;height:170px;object-fit:cover;display:block;background:#f0f0f0}
.polaroid .up-ov{position:absolute;top:10px;left:10px;right:10px;bottom:40px;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;color:#fff;font-size:32px;opacity:0;transition:opacity .3s}
.polaroid:hover .up-ov,.polaroid:active .up-ov{opacity:1}
.album-nav{position:fixed;bottom:28px;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:0 24px;z-index:100}
.album-nav .nav-btn{background:rgba(255,255,255,.92);border:none;width:46px;height:46px;border-radius:50%;font-size:16px;color:var(--pd);cursor:pointer;box-shadow:var(--sm);display:flex;align-items:center;justify-content:center}
.album-nav .nav-btn:disabled{opacity:.3;cursor:not-allowed}
.album-nav .page-ind{background:rgba(255,255,255,.92);padding:8px 20px;border-radius:20px;font-size:13px;color:var(--pd)}
</style>
<style>
.wish-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px}
.wish-bottle{background:linear-gradient(180deg,rgba(220,240,255,.5),rgba(180,220,255,.6));border-radius:16px 16px 28px 28px;padding:18px 12px;text-align:center;position:relative;min-height:115px;cursor:pointer;border:2px solid rgba(180,220,255,.5);box-shadow:var(--ss);display:flex;flex-direction:column;align-items:center;justify-content:center}
.wish-bottle::before{content:'';position:absolute;top:-8px;left:50%;transform:translateX(-50%);width:26px;height:12px;background:linear-gradient(180deg,#a08060,#8b7355);border-radius:4px 4px 2px 2px}
.wish-bottle .b-icon{font-size:28px;margin-bottom:6px}
.wish-bottle .b-status{font-size:11px;color:#666;line-height:1.4}
.wish-bottle.ready{animation:bG 2s ease-in-out infinite;border-color:#ffd700;background:linear-gradient(180deg,rgba(255,250,220,.6),rgba(255,235,180,.7))}
@keyframes bG{0%,100%{box-shadow:0 0 12px rgba(255,215,0,.2)}50%{box-shadow:0 0 22px rgba(255,215,0,.5)}}
.add-wish{background:rgba(255,255,255,.5);border:2px dashed var(--pl);border-radius:16px 16px 28px 28px;padding:18px 12px;text-align:center;min-height:115px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--pc)}
.add-wish span{font-size:26px;margin-bottom:4px}.add-wish p{font-size:12px}
.btn-row{display:flex;gap:10px}
.btn-p{flex:1;padding:12px;border:none;border-radius:var(--rs);font-size:14px;cursor:pointer;font-family:inherit;background:linear-gradient(135deg,var(--pc),var(--pd));color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1)}
.btn-p:active{transform:scale(.97)}.btn-p:disabled{opacity:.5;cursor:not-allowed}
.btn-s{flex:1;padding:12px;border:none;border-radius:var(--rs);font-size:14px;cursor:pointer;font-family:inherit;background:rgba(0,0,0,.05);color:var(--ts)}
.wm-body h3{text-align:center;color:var(--pd);margin-bottom:20px;font-size:18px;font-weight:500}
.wm-body textarea{width:100%;height:110px;border:1.5px solid rgba(0,0,0,.1);border-radius:var(--rs);padding:14px;font-size:14px;resize:none;margin-bottom:16px;font-family:inherit;line-height:1.8;background:var(--bg);color:var(--tc)}
.wm-body textarea:focus{outline:none;border-color:var(--pc)}
.wm-body label{display:block;font-size:13px;color:var(--ts);margin-bottom:8px}
.wm-body input[type="date"]{width:100%;padding:10px 14px;border:1.5px solid rgba(0,0,0,.1);border-radius:var(--rs);font-size:14px;margin-bottom:20px;font-family:inherit;color:var(--tc);background:var(--bg)}
.wv-body{text-align:center}
.wv-body .wv-text{font-size:15px;color:var(--pd);padding:22px;background:var(--bg);border-radius:var(--rs);margin-bottom:16px;line-height:1.9;text-align:left}
.wv-body .wv-date{font-size:12px;color:var(--ts);margin-bottom:20px}
.mood-box{background:var(--cb);border-radius:var(--rm);padding:20px;box-shadow:var(--ss)}
.mood-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.mood-hd h4{color:var(--pd);font-size:16px;font-weight:500}
.mood-pg{font-size:12px;color:var(--ts);background:var(--bg);padding:4px 12px;border-radius:12px}
.mood-legend{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-bottom:14px}
.mood-legend-item{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--ts)}
.mood-legend-color{width:10px;height:10px;border-radius:50%}
.mood-scroll{overflow-x:auto;margin-bottom:14px;-webkit-overflow-scrolling:touch;padding-bottom:5px}
.mood-chart{display:flex;align-items:flex-end;height:190px;min-width:max-content;padding:8px 4px;gap:6px}
.mood-bar{width:28px;display:flex;flex-direction:column;align-items:center}
.mood-bar-fill{width:18px;border-radius:9px 9px 4px 4px;min-height:4px}
.mood-bar-fill.m1{background:linear-gradient(180deg,#ef9a9a,#e57373)}
.mood-bar-fill.m2{background:linear-gradient(180deg,#ffcc80,#ffb74d)}
.mood-bar-fill.m3{background:linear-gradient(180deg,#fff59d,#fff176)}
.mood-bar-fill.m4{background:linear-gradient(180deg,#c5e1a5,#aed581)}
.mood-bar-fill.m5{background:linear-gradient(180deg,#81d4fa,#4fc3f7)}
.mood-bar-date{font-size:9px;color:var(--ts);margin-top:6px;writing-mode:vertical-rl;height:38px}
.mood-pgs{display:flex;justify-content:center;gap:8px;margin-top:12px;margin-bottom:14px}
.mood-pg-btn{padding:7px 16px;border:1.5px solid var(--pl);background:var(--cb);border-radius:18px;font-size:12px;color:var(--pc);cursor:pointer;font-family:inherit}
.mood-pg-btn.active{background:var(--pc);color:#fff;border-color:var(--pc)}
.mood-pg-btn:disabled{opacity:.3;cursor:not-allowed}
.mood-add{width:100%;padding:13px;background:var(--bg);border:none;border-radius:var(--rs);color:var(--pc);font-size:14px;cursor:pointer;font-family:inherit}
.mood-add:disabled{opacity:.4;cursor:not-allowed}
.mood-sel{display:flex;justify-content:center;gap:10px;padding:18px 0}
.mood-opt{width:50px;height:50px;border-radius:50%;border:3px solid transparent;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:var(--ss);transition:transform .2s}
.mood-opt.selected{transform:scale(1.2);border-color:var(--pc)}
.mood-opt[data-m="1"]{background:#ffebee}
.mood-opt[data-m="2"]{background:#fff3e0}
.mood-opt[data-m="3"]{background:#fffde7}
.mood-opt[data-m="4"]{background:#f1f8e9}
.mood-opt[data-m="5"]{background:#e1f5fe}
.sticky-wall{background:linear-gradient(145deg,#d4a574,#c4956a);border-radius:var(--rm);padding:18px;margin-bottom:22px;min-height:180px;box-shadow:inset 0 2px 10px rgba(0,0,0,.1),var(--ss)}
.sticky-box{display:flex;flex-wrap:wrap;gap:10px}
.sticky-note{width:calc(50% - 5px);min-height:95px;padding:12px;border-radius:4px;box-shadow:2px 3px 8px rgba(0,0,0,.15);position:relative;font-size:13px;color:#333}
.sticky-note.yellow{background:linear-gradient(135deg,#fff9c4,#fff59d)}
.sticky-note.pink{background:linear-gradient(135deg,#fce4ec,#f8bbd0)}
.sticky-note.blue{background:linear-gradient(135deg,#e1f5fe,#b3e5fc)}
.sticky-note.green{background:linear-gradient(135deg,#e8f5e9,#c8e6c9)}
.sticky-note .del-s{position:absolute;top:4px;right:6px;background:none;border:none;color:rgba(0,0,0,.25);cursor:pointer;font-size:16px}
.sticky-note .s-text{outline:none;min-height:55px;line-height:1.7}
.sticky-note .s-author{font-size:10px;color:rgba(0,0,0,.3);text-align:right;margin-top:4px}
.add-sticky{width:calc(50% - 5px);min-height:95px;border:2px dashed rgba(139,105,20,.4);border-radius:4px;background:rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;cursor:pointer;color:rgba(139,105,20,.7);font-size:14px}
</style>
<style>
.timeline{position:relative;padding-left:28px}
.timeline::before{content:"";position:absolute;left:7px;top:0;bottom:0;width:2px;background:linear-gradient(180deg,var(--pc),var(--pl))}
.tl-item{position:relative;margin-bottom:22px;background:var(--cb);padding:18px;border-radius:var(--rs);box-shadow:var(--ss)}
.tl-item::before{content:"";position:absolute;left:-25px;top:22px;width:10px;height:10px;background:var(--pc);border-radius:50%;border:3px solid var(--bg);box-shadow:0 0 0 2px var(--pc)}
.tl-item .date{font-size:12px;color:var(--pc);margin-bottom:6px}
.tl-item .title{font-size:15px;color:var(--tc);margin-bottom:8px;font-weight:500}
.tl-item .desc{font-size:13px;color:var(--ts);line-height:1.8}
.tl-item .del-item{position:absolute;top:8px;right:10px;background:none;border:none;color:#ddd;cursor:pointer;font-size:18px}
.add-item{background:var(--cb);border:2px dashed var(--pl);border-radius:var(--rs);padding:28px;text-align:center;cursor:pointer;color:var(--pc);margin-left:28px}
.add-item span{font-size:28px;display:block;margin-bottom:8px}
.nb-entry{background:var(--cb);border-radius:var(--rm);padding:22px;margin-bottom:18px;box-shadow:var(--ss);border-left:4px solid var(--pc)}
.nb-entry .entry-hd{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.nb-entry .entry-date{font-size:12px;color:var(--pc);background:var(--bg);padding:4px 12px;border-radius:14px}
.nb-entry .del-entry{background:none;border:none;color:#ddd;cursor:pointer;font-size:18px}
.nb-entry .entry-title{font-size:17px;color:var(--pd);margin-bottom:14px;padding-bottom:10px;border-bottom:1px dashed var(--pl);font-weight:500}
.nb-entry .entry-content{font-size:14px;min-height:80px;white-space:pre-wrap;line-height:2}
.nb-entry .entry-author{font-size:11px;color:var(--ts);text-align:right;margin-top:6px;opacity:.6}
.word-count{font-size:11px;color:var(--ts);text-align:right;margin-top:10px;opacity:.6}
.cl-prog{background:var(--bg);border-radius:20px;height:8px;margin-bottom:20px;overflow:hidden}
.cl-prog-bar{height:100%;background:linear-gradient(90deg,var(--pl),var(--pc));border-radius:20px;transition:width .4s}
.cl-stats{text-align:center;font-size:13px;color:var(--ts);margin-bottom:18px}
.cl-item{display:flex;align-items:flex-start;gap:12px;padding:14px;background:var(--cb);border-radius:var(--rs);margin-bottom:10px;box-shadow:var(--ss)}
.cl-item.done{opacity:.6}
.cl-cb{width:24px;height:24px;border:2px solid var(--pl);border-radius:50%;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-top:2px;background:var(--cb)}
.cl-cb.checked{background:var(--pc);border-color:var(--pc);color:#fff;font-size:12px}
.cl-info{flex:1;min-width:0}
.cl-text{font-size:14px;color:var(--tc);outline:none;min-height:20px;line-height:1.6}
.cl-item.done .cl-text{text-decoration:line-through;color:var(--ts)}
.cl-done-date{font-size:11px;color:var(--pc);margin-top:4px}
.cl-del{background:none;border:none;color:#ddd;cursor:pointer;font-size:16px;flex-shrink:0}
.voice-list{display:flex;flex-direction:column;gap:12px}
.voice-item{background:var(--cb);border-radius:var(--rs);padding:16px;box-shadow:var(--ss);display:flex;align-items:center;gap:14px}
.v-play{width:44px;height:44px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,var(--pc),var(--pd));border:none;color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.v-play.playing{animation:vP 1.5s ease-in-out infinite}
@keyframes vP{0%,100%{box-shadow:0 0 0 0 rgba(122,154,138,.4)}50%{box-shadow:0 0 0 10px rgba(122,154,138,0)}}
.v-info{flex:1;min-width:0}
.v-title{font-size:14px;color:var(--tc);font-weight:500;margin-bottom:4px;outline:none}
.v-meta{font-size:11px;color:var(--ts)}
.v-prog{height:3px;background:rgba(0,0,0,.06);border-radius:2px;margin-top:6px;overflow:hidden}
.v-prog-bar{height:100%;background:var(--pc);width:0%}
.v-del{background:none;border:none;color:#ddd;cursor:pointer;font-size:16px;flex-shrink:0}
.rec-area{background:var(--cb);border-radius:var(--rm);padding:28px;text-align:center;margin-top:16px;box-shadow:var(--ss)}
.rec-btn{width:70px;height:70px;border-radius:50%;border:none;background:linear-gradient(135deg,#e57373,#ef5350);color:#fff;font-size:28px;cursor:pointer;margin:0 auto 14px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(229,115,115,.4)}
.rec-btn.recording{animation:recP 1s ease-in-out infinite;background:linear-gradient(135deg,#ef5350,#d32f2f)}
@keyframes recP{0%,100%{box-shadow:0 0 0 0 rgba(229,115,115,.4)}50%{box-shadow:0 0 0 15px rgba(229,115,115,0)}}
.rec-status{font-size:13px;color:var(--ts);margin-bottom:6px}
.rec-time{font-size:24px;color:var(--pd);font-weight:300;letter-spacing:2px}
.voice-empty{text-align:center;padding:30px;color:var(--ts);font-size:13px}
</style>
<style>
.set-sec{background:var(--cb);border-radius:var(--rm);padding:6px 0;margin-bottom:16px;box-shadow:var(--ss);overflow:hidden}
.set-item{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;cursor:pointer;transition:background .2s;border-bottom:1px solid rgba(0,0,0,.04)}
.set-item:last-child{border-bottom:none}
.set-item:active{background:rgba(0,0,0,.03)}
.set-item-l{display:flex;align-items:center;gap:14px}
.set-icon{font-size:20px;width:28px;text-align:center}
.set-txt h4{font-size:14px;color:var(--tc);font-weight:500;margin-bottom:2px}
.set-txt p{font-size:11px;color:var(--ts)}
.set-item-r{display:flex;align-items:center;gap:8px}
.set-val{font-size:12px;color:var(--ts)}
.set-arrow{font-size:14px;color:#ccc}
.toggle{width:48px;height:26px;background:rgba(0,0,0,.1);border-radius:13px;position:relative;cursor:pointer;transition:background .3s}
.toggle.on{background:var(--pc)}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .3s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.toggle.on::after{transform:translateX(22px)}
.set-input-g{margin-bottom:18px}
.set-input-g label{display:block;font-size:13px;color:var(--ts);margin-bottom:8px}
.set-input{width:100%;padding:11px 14px;border:1.5px solid rgba(0,0,0,.1);border-radius:var(--rs);font-size:14px;font-family:inherit;background:var(--bg);color:var(--tc);outline:none}
.set-input:focus{border-color:var(--pc)}
.set-hint{font-size:11px;color:var(--ts);margin-top:6px;line-height:1.5}
.set-danger{background:rgba(229,115,115,.08);border-radius:var(--rm);padding:6px 0;margin-bottom:16px;overflow:hidden}
.set-danger .set-item h4{color:#e57373}
.set-danger .set-icon{color:#e57373}
.agent-card{background:var(--cb);border-radius:var(--rs);padding:16px;margin-bottom:10px;box-shadow:var(--ss);display:flex;align-items:center;gap:14px;cursor:pointer}
.agent-avatar{width:44px;height:44px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,var(--pl),var(--pc));display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff}
.agent-info{flex:1;min-width:0}
.agent-nm{font-size:14px;font-weight:500;color:var(--tc);margin-bottom:2px}
.agent-desc{font-size:11px;color:var(--ts);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.agent-act{background:none;border:none;width:28px;height:28px;border-radius:50%;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--ts)}
.add-agent{width:100%;padding:16px;border:2px dashed var(--pl);border-radius:var(--rs);background:none;color:var(--pc);font-size:14px;cursor:pointer;font-family:inherit;margin-top:10px}
.wb-card{background:var(--cb);border-radius:var(--rs);padding:14px 16px;margin-bottom:10px;box-shadow:var(--ss)}
.wb-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.wb-nm{font-size:14px;font-weight:500;color:var(--tc)}
.wb-badge{font-size:10px;padding:2px 8px;border-radius:10px;background:var(--bg);color:var(--pc)}
.wb-badge.global{background:rgba(255,193,7,.15);color:#f9a825}
.wb-content{font-size:12px;color:var(--ts);line-height:1.6;max-height:60px;overflow:hidden}
.wb-acts{display:flex;gap:6px;margin-top:8px;justify-content:flex-end}
.mem-card{background:var(--cb);border-radius:var(--rs);padding:16px;margin-bottom:10px;box-shadow:var(--ss);border-left:3px solid var(--pc)}
.mem-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.mem-nm{font-size:13px;font-weight:500;color:var(--pd)}
.mem-content{font-size:13px;color:var(--ts);line-height:1.7;max-height:80px;overflow:hidden}
.api-status{padding:12px 16px;border-radius:var(--rs);margin-bottom:16px;font-size:13px;display:flex;align-items:center;gap:8px}
.api-status.connected{background:rgba(76,175,80,.1);color:#4caf50}
.api-status.disconnected{background:rgba(244,67,54,.1);color:#f44336}
.api-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.api-status.connected .api-dot{background:#4caf50}
.api-status.disconnected .api-dot{background:#f44336}
.model-sel{width:100%;padding:11px 14px;border:1.5px solid rgba(0,0,0,.1);border-radius:var(--rs);font-size:14px;font-family:inherit;background:var(--bg);color:var(--tc);cursor:pointer}
.model-list{max-height:200px;overflow-y:auto;margin-bottom:16px}
.model-item{padding:10px 14px;border-radius:8px;margin-bottom:4px;cursor:pointer;font-size:13px;color:var(--tc)}
.model-item.selected{background:var(--pc);color:#fff}
.auto-sch{background:var(--bg);border-radius:var(--rs);padding:14px;margin-bottom:16px}
.auto-sch-label{font-size:13px;color:var(--ts);margin-bottom:10px}
.auto-opts{display:flex;flex-wrap:wrap;gap:8px}
.auto-opt{padding:7px 14px;border:1.5px solid var(--pl);border-radius:18px;font-size:12px;color:var(--pc);cursor:pointer;background:var(--cb);font-family:inherit}
.auto-opt.active{background:var(--pc);color:#fff;border-color:var(--pc)}
</style>
<style>
/* ä¼ å‘¼æœº */
.pager{
  position:relative;width:100%;max-width:340px;margin:0 auto;
  background:linear-gradient(145deg,#2a2a2a,#1a1a1a);
  border-radius:20px;padding:14px;
  box-shadow:0 8px 32px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.05);
  border:2px solid #333;
}
.pager-screen{
  background:#0a1a0a;border-radius:12px;padding:12px;
  min-height:340px;max-height:400px;overflow-y:auto;
  border:2px solid #1a2a1a;position:relative;
  background-size:cover;background-position:center;
  display:flex;flex-direction:column;
}
.pager-screen::-webkit-scrollbar{width:3px}
.pager-screen::-webkit-scrollbar-thumb{background:rgba(0,255,0,.3);border-radius:2px}
.pager-msgs{flex:1;display:flex;flex-direction:column;gap:8px;padding-bottom:4px}
.pager-msg{
  max-width:80%;padding:8px 12px;border-radius:10px;font-size:13px;
  line-height:1.6;word-break:break-word;animation:pmIn .3s;
}
@keyframes pmIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.pager-msg.user{align-self:flex-end;background:rgba(0,180,80,.25);color:#a0ffb0;border-bottom-right-radius:4px}
.pager-msg.char{align-self:flex-start;background:rgba(0,100,50,.2);color:#80e8a0;border-bottom-left-radius:4px}
.pager-msg .msg-time{font-size:9px;opacity:.5;margin-top:4px;display:block}
.pager-typing{align-self:flex-start;padding:8px 12px;color:rgba(0,255,0,.4);font-size:12px}
.pager-input-area{display:flex;gap:8px;margin-top:10px}
.pager-input{
  flex:1;background:#111;border:1.5px solid #2a3a2a;border-radius:10px;
  padding:10px 14px;color:#a0ffb0;font-size:13px;outline:none;
  font-family:inherit;resize:none;min-height:38px;max-height:80px;
}
.pager-input::placeholder{color:rgba(0,255,0,.25)}
.pager-input:focus{border-color:rgba(0,255,0,.4)}
.pager-send{
  width:38px;height:38px;border-radius:50%;border:none;
  background:linear-gradient(135deg,#0a6030,#0a4020);
  color:#a0ffb0;font-size:16px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 2px 8px rgba(0,0,0,.3);align-self:flex-end;
}
.pager-send:active{transform:scale(.92)}
.pager-recv{
  width:38px;height:38px;border-radius:50%;border:none;
  background:linear-gradient(135deg,#604000,#402a00);
  color:#ffd080;font-size:14px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 2px 8px rgba(0,0,0,.3);align-self:flex-end;
}
.pager-recv:active{transform:scale(.92)}
.pager-recv:disabled{opacity:.3;cursor:not-allowed}
.pager-recv.has-reply{animation:recvG 1.5s ease-in-out infinite}
@keyframes recvG{0%,100%{box-shadow:0 0 0 0 rgba(255,180,0,.3)}50%{box-shadow:0 0 0 8px rgba(255,180,0,0)}}
.pager-hd{display:flex;justify-content:space-between;align-items:center;padding:6px 4px 10px}
.pager-title{color:#a0ffb0;font-size:13px;font-weight:500;letter-spacing:1px}
.pager-bg-btn{background:rgba(0,255,0,.1);border:1px solid rgba(0,255,0,.2);padding:3px 10px;border-radius:10px;font-size:10px;color:rgba(0,255,0,.5);cursor:pointer}
.pager-clear{background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.2);padding:3px 10px;border-radius:10px;font-size:10px;color:rgba(255,100,100,.5);cursor:pointer}
/* æ‰‹å†Œ */
.manual-c{font-size:13px;color:var(--ts);line-height:2}
.manual-c h4{color:var(--pd);font-size:15px;margin:20px 0 10px;padding-bottom:6px;border-bottom:1px dashed var(--pl)}
.manual-c p{margin-bottom:10px}
.manual-c ul{padding-left:20px;margin-bottom:12px}
.manual-c li{margin-bottom:6px}
.manual-c .hl{background:var(--bg);padding:10px 14px;border-radius:8px;margin:10px 0;border-left:3px solid var(--pc)}
/* åº•éƒ¨ */
.bottom-bar{position:fixed;bottom:0;left:0;right:0;background:var(--cb);padding:10px 16px;padding-bottom:max(10px,env(safe-area-inset-bottom));box-shadow:0 -2px 15px rgba(0,0,0,.08);display:none;justify-content:center;gap:8px;z-index:100;backdrop-filter:blur(15px)}
.bottom-bar.show{display:flex}
.bot-btn{background:linear-gradient(135deg,var(--pc),var(--pd));color:#fff;border:none;padding:10px 18px;border-radius:22px;font-size:13px;cursor:pointer;font-family:inherit;box-shadow:0 2px 10px rgba(0,0,0,.1)}
.bot-btn:active{transform:scale(.95)}
.bot-btn.sec{background:var(--cb);color:var(--pc);border:1.5px solid var(--pl);box-shadow:none}
.toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.78);color:#fff;padding:14px 28px;border-radius:var(--rs);font-size:14px;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;backdrop-filter:blur(8px)}
.toast.show{opacity:1}
.auto-save{position:fixed;top:14px;left:50%;transform:translateX(-50%);background:var(--pc);color:#fff;padding:5px 16px;border-radius:16px;font-size:12px;z-index:2000;opacity:0;transition:opacity .3s;pointer-events:none}
.auto-save.show{opacity:1}
.wish-notif{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#ffd700,#ffb347);color:#4a3000;padding:12px 22px;border-radius:var(--rm);box-shadow:0 4px 22px rgba(255,215,0,.35);z-index:3000;display:none;align-items:center;gap:10px;cursor:pointer;animation:wN 2.5s ease-in-out infinite;white-space:nowrap}
.wish-notif.show{display:flex}
@keyframes wN{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.03)}}
</style>
</head>
<body data-theme="green" data-night="false">
  <div class="lock-screen hidden" id="lockScreen">
  <div class="lock-icon">ğŸ”’</div>
  <div class="lock-title">æˆ‘ä»¬çš„æ•…äº‹</div>
  <div class="lock-subtitle">è¯·è¾“å…¥å¯†ç </div>
  <div class="lock-input-wrap">
    <input class="lock-input" id="lockInput" type="password" placeholder="è¾“å…¥å¯†ç " maxlength="20" autocomplete="off">
    <button class="lock-submit" id="lockSubmit">â†’</button>
  </div>
  <div class="lock-error-msg" id="lockError"></div>
</div>

<div class="cover-page" id="coverPage">
  <canvas class="particles-canvas" id="particlesCanvas"></canvas>
  <div class="particle-switcher">
    <button class="particle-btn active" data-type="rain">ğŸŒ§ï¸</button>
    <button class="particle-btn" data-type="sakura">ğŸŒ¸</button>
    <button class="particle-btn" data-type="meteor">ğŸŒ </button>
    <button class="particle-btn" data-type="leaves">ğŸ‚</button>
    <button class="particle-btn" data-type="snow">â„ï¸</button>
  </div>
  <div class="cover-title">æˆ‘ä»¬çš„æ•…äº‹</div>
  <div class="cover-subtitle">è®°å½•å±äºæˆ‘ä»¬çš„æ¯ä¸€åˆ»</div>
  <div class="cover-author">by å¿ƒç”°</div>
  <div class="swipe-area" id="swipeArea">
    <div class="swipe-hint"><div class="swipe-arrow"></div><div class="swipe-text">ä¸Šæ»‘æˆ–ç‚¹å‡»è¿›å…¥</div></div>
    <div class="swipe-bar"></div>
  </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-title">å¿ƒç”°</div>
  <div class="loading-text">æ­£åœ¨å¯¼å…¥æ•°æ®<span class="loading-dots"></span></div>
</div>

<div class="wish-notif" id="wishNotif"><span>ğŸ‰</span><span>æœ‰æ„¿æœ›å¯ä»¥æ‰“å¼€å•¦!</span></div>

<div class="main-page" id="mainPage">
  <div class="author-mark tl">by å¿ƒç”°</div>
  <div class="author-mark br">å¿ƒç”°</div>
  <div class="top-controls" id="topControls">
    <button class="ctrl-btn theme-btn" id="themeBtn">ğŸ¨</button>
    <button class="ctrl-btn" id="bgBtn">èƒŒæ™¯</button>
    <input type="file" id="bgInput" accept="image/*">
  </div>
  <div class="auto-save" id="autoSave">å·²è‡ªåŠ¨ä¿å­˜</div>
  
  <div class="container">
    <div class="header" id="headerBox">
      <button class="hd-bg" id="hdBgBtn">æ¢èƒŒæ™¯</button>
      <input type="file" id="hdBgInput" accept="image/*">
      <h1 class="ed" contenteditable="true" data-key="mainTitle">æˆ‘ä»¬çš„æ•…äº‹</h1>
      <p class="ed" contenteditable="true" data-key="subTitle1">ç‡•ä¸– & è°¢è”šå®‰</p>
      <p class="ed" contenteditable="true" data-key="subTitle2">ä»ç›¸é‡åˆ°ç›¸å®ˆ</p>
    </div>

    <div class="music-player">
      <div class="disc-box">
        <div class="disc" id="musicDisc">
          <div class="disc-center" id="discCenter">
            <img id="discImg" src="" style="display:none">
            <span class="disc-ph" id="discPh">+</span>
          </div>
        </div>
        <input type="file" id="discImgInput" accept="image/*">
      </div>
      <div class="music-info">
        <div class="music-title" id="musicTitle">æœªé€‰æ‹©éŸ³ä¹</div>
        <div class="music-ctrls">
          <button class="mbtn sm" id="prevMusicBtn">â®</button>
          <button class="mbtn" id="playPauseBtn">â–¶</button>
          <button class="mbtn sm" id="nextMusicBtn">â­</button>
          <div class="mprog" id="musicProg"><div class="mprog-bar" id="musicProgBar"></div></div>
          <span class="mtime" id="musicTime">0:00</span>
        </div>
        <button class="mlist-btn" id="musicListBtn">åˆ—è¡¨ (0/5)</button>
      </div>
    </div>
    <audio id="audioPlayer"></audio>

    <div class="quote-box">
      <p class="ed" contenteditable="true" data-key="quote">æœ‰ä½ åœ¨,æˆ‘è§‰å¾—è¿™ä¸ªå®¶æ˜¯æ´»çš„ã€‚</p>
      <div class="author">â€”â€” <span class="ed" contenteditable="true" data-key="quoteAuthor">è°¢è”šå®‰</span></div>
    </div>

    <div class="nb">
      <div class="nb-t">ç¬¬ä¸€æ¬¡è§é¢</div>
      <div class="nb-c ed" contenteditable="true" data-key="note1">é‚£å¤©é˜³å…‰å¾ˆå¥½,ä»–ç©¿ç€ç™½å¤§è¤‚ç«™åœ¨çª—è¾¹ã€‚å£°éŸ³å¾ˆè½»,åƒæ€•æƒŠæ‰°ä»€ä¹ˆä¼¼çš„ã€‚</div>
      <div class="nb-d ed" contenteditable="true" data-key="note1Date">2024å¹´ æŸæœˆæŸæ—¥</div>
    </div>

    <div class="photo-card">
      <div class="photo-wrap" id="mainPhotoWrap">
        <img id="mainImg" src="">
        <div class="up-hint"><span>+</span><p>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</p></div>
      </div>
      <input type="file" id="mainPhotoInput" accept="image/*">
      <div class="caption">
        <h3>æˆ‘ä»¬çš„åˆç…§</h3>
        <p class="ed" contenteditable="true" data-key="mainCaption">è®°å½•æœ€ç¾å¥½çš„ç¬é—´</p>
      </div>
    </div>

    <div class="cal-card">
      <div class="days-label">æˆ‘ä»¬å·²ç»ç›¸è¯†</div>
      <div class="days-count" id="daysCount">0</div>
      <div class="days-label">å¤©</div>
      <div class="start-date" id="startDateText">é€‰æ‹©ç›¸é‡æ—¥æœŸ</div>
      <div class="date-picker"><input type="date" id="startDateInput"></div>
    </div>

    <h2 class="section-title">æˆ‘ä»¬çš„ç›¸å†Œ</h2>
    <div class="album-book" id="albumBook">
      <div class="album-cover">
        <div class="book-spine"></div>
        <h2>ç›¸å†Œ</h2>
        <p>ç‚¹å‡»æ‰“å¼€ Â· å…±10é¡µ</p>
      </div>
    </div>

    <h2 class="section-title">æ›´å¤šå†…å®¹</h2>
    <div class="nav-cards">
      <div class="nav-card" id="timelineCard"><div class="icon">ğŸ“…</div><h3>æ—¶é—´çº¿</h3><p>è®°å½•é‡è¦æ—¶åˆ»</p></div>
      <div class="nav-card" id="notebookCard"><div class="icon">ğŸ“–</div><h3>ç¬”è®°æœ¬</h3><p>å†™ä¸‹æƒ³è¯´çš„è¯</p></div>
      <div class="nav-card" id="wishCard"><div class="icon">ğŸ¾</div><h3>è®¸æ„¿ç“¶</h3><p>å°å­˜ç¾å¥½æ„¿æœ›</p></div>
      <div class="nav-card" id="moodCard"><div class="icon">ğŸ“ˆ</div><h3>å¿ƒæƒ…æ›²çº¿</h3><p>è®°å½•æ¯æ—¥å¿ƒæƒ…</p></div>
      <div class="nav-card" id="checklistCard"><div class="icon">âœ…</div><h3>æƒ…ä¾£æ¸…å•</h3><p>ä¸€èµ·å®Œæˆçš„äº‹</p></div>
      <div class="nav-card" id="voiceCard"><div class="icon">ğŸ™ï¸</div><h3>è¯­éŸ³ä¿¡ç®±</h3><p>å½•ä¸‹æƒ³è¯´çš„è¯</p></div>
    </div>

    <h2 class="section-title">ä¾¿ç­¾å¢™</h2>
    <div class="sticky-wall">
      <div class="sticky-box" id="stickyBox">
        <div class="add-sticky" id="addStickyBtn">+ æ·»åŠ ä¾¿ç­¾</div>
      </div>
    </div>

    <div class="nb">
      <div class="nb-t">ç»™æœªæ¥çš„æˆ‘ä»¬</div>
      <div class="nb-c ed" contenteditable="true" data-key="note2">ä¸ç®¡ä»¥åå‘ç”Ÿä»€ä¹ˆ,æˆ‘éƒ½æƒ³è®°ä½ç°åœ¨çš„æ„Ÿè§‰ã€‚è°¢è°¢ä½ ,è”šå®‰ã€‚</div>
      <div class="nb-d ed" contenteditable="true" data-key="note2Date">å†™äºæŸä¸ªå®‰é™çš„å¤œæ™š</div>
    </div>
  </div>

  <div class="bottom-bar" id="bottomBar">
    <button class="bot-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>
    <button class="bot-btn sec" id="pagerBtn">ğŸ“Ÿ ä¼ å‘¼æœº</button>
    <button class="bot-btn sec" id="manualBtn">ğŸ“˜ æ‰‹å†Œ</button>
  </div>
</div>
<!-- éŸ³ä¹åˆ—è¡¨å¼¹çª— -->
<div class="ovm" id="musicListModal">
  <div class="ovm-c">
    <div class="ovm-h"><h3>éŸ³ä¹åˆ—è¡¨</h3><button class="ovm-x" id="closeMusicList">Ã—</button></div>
    <div id="musicListBox"></div>
    <button class="madd-btn" id="addMusicBtn">+ æ·»åŠ éŸ³ä¹</button>
    <input type="file" id="musicFileInput" accept="audio/*">
  </div>
</div>

<!-- ç›¸å†Œå¼¹çª— -->
<div class="modal album-modal" id="albumModal">
  <div class="modal-box" id="albumBox">
    <div class="modal-hd">
      <div class="hd-left">
        <button class="abg-btn" id="albumBgBtn">æ¢èƒŒæ™¯</button>
        <input type="file" id="albumBgInput" accept="image/*">
      </div>
      <h3>ç›¸å†Œ</h3>
      <button class="close-m" id="closeAlbumBtn">Ã—</button>
    </div>
    <div class="modal-bd"><div id="albumPages"></div></div>
    <div class="album-nav">
      <button class="nav-btn" id="prevPageBtn">â—€</button>
      <span class="page-ind" id="pageInfo">1/10</span>
      <button class="nav-btn" id="nextPageBtn">â–¶</button>
    </div>
  </div>
</div>

<!-- æ—¶é—´çº¿å¼¹çª— -->
<div class="modal" id="timelineModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>æ—¶é—´çº¿</h3><button class="close-m" id="closeTimelineBtn">Ã—</button></div>
    <div class="modal-bd">
      <div class="timeline" id="timelineBox"></div>
      <div class="add-item" id="addTimelineBtn"><span>+</span><p>æ·»åŠ æ—¶é—´èŠ‚ç‚¹</p></div>
    </div>
  </div>
</div>

<!-- ç¬”è®°æœ¬å¼¹çª— -->
<div class="modal" id="notebookModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>ç¬”è®°æœ¬</h3><button class="close-m" id="closeNotebookBtn">Ã—</button></div>
    <div class="modal-bd">
      <div id="notebookBox"></div>
      <div class="add-item" id="addNotebookBtn"><span>+</span><p>å†™æ–°æ—¥è®°</p></div>
    </div>
  </div>
</div>

<!-- è®¸æ„¿ç“¶å¼¹çª— -->
<div class="modal" id="wishModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>è®¸æ„¿ç“¶</h3><button class="close-m" id="closeWishBtn">Ã—</button></div>
    <div class="modal-bd"><div class="wish-grid" id="wishGrid"></div></div>
  </div>
</div>

<!-- å¿ƒæƒ…å¼¹çª— -->
<div class="modal" id="moodModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>å¿ƒæƒ…æ›²çº¿</h3><button class="close-m" id="closeMoodBtn">Ã—</button></div>
    <div class="modal-bd">
      <div class="mood-box">
        <div class="mood-hd"><h4>å¿ƒæƒ…è®°å½•</h4><span class="mood-pg" id="moodPgInfo">ç¬¬1é¡µ</span></div>
        <div class="mood-legend">
          <div class="mood-legend-item"><div class="mood-legend-color" style="background:#e57373"></div>å¾ˆå·®</div>
          <div class="mood-legend-item"><div class="mood-legend-color" style="background:#ffb74d"></div>ä¸å¥½</div>
          <div class="mood-legend-item"><div class="mood-legend-color" style="background:#fff176"></div>ä¸€èˆ¬</div>
          <div class="mood-legend-item"><div class="mood-legend-color" style="background:#aed581"></div>ä¸é”™</div>
          <div class="mood-legend-item"><div class="mood-legend-color" style="background:#4fc3f7"></div>å¾ˆæ£’</div>
        </div>
        <div class="mood-scroll"><div class="mood-chart" id="moodChart"></div></div>
        <div class="mood-pgs" id="moodPgsNav"></div>
        <button class="mood-add" id="addMoodBtn">è®°å½•ä»Šå¤©çš„å¿ƒæƒ…</button>
      </div>
    </div>
  </div>
</div>

<!-- æ¸…å•å¼¹çª— -->
<div class="modal" id="checklistModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>æƒ…ä¾£æ¸…å•</h3><button class="close-m" id="closeChecklistBtn">Ã—</button></div>
    <div class="modal-bd">
      <div class="cl-stats" id="clStats">å·²å®Œæˆ 0/0</div>
      <div class="cl-prog"><div class="cl-prog-bar" id="clProgBar"></div></div>
      <div id="checklistBox"></div>
      <div class="add-item" id="addChecklistBtn"><span>+</span><p>æ·»åŠ æ¸…å•</p></div>
    </div>
  </div>
</div>

<!-- è¯­éŸ³å¼¹çª— -->
<div class="modal" id="voiceModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>è¯­éŸ³ä¿¡ç®±</h3><button class="close-m" id="closeVoiceBtn">Ã—</button></div>
    <div class="modal-bd">
      <div class="voice-list" id="voiceList"></div>
      <div class="rec-area">
        <div class="rec-status" id="recStatus">ç‚¹å‡»å½•éŸ³</div>
        <div class="rec-time" id="recTime">0:00</div>
        <button class="rec-btn" id="recBtn">ğŸ™ï¸</button>
      </div>
    </div>
  </div>
</div>
<!-- ä¼ å‘¼æœºå¼¹çª— -->
<div class="modal" id="pagerModal">
  <div class="modal-box" style="background:#111">
    <div class="modal-hd" style="background:rgba(20,30,20,.95)">
      <h3 style="color:#a0ffb0">ğŸ“Ÿ ä¼ å‘¼æœº</h3>
      <button class="close-m" id="closePagerBtn" style="color:#a0ffb0">Ã—</button>
    </div>
    <div class="modal-bd" style="display:flex;justify-content:center;padding-top:24px">
      <div class="pager">
        <div class="pager-hd">
          <span class="pager-title" id="pagerCharName">ä¼ å‘¼æœº</span>
          <div style="display:flex;gap:6px">
            <button class="pager-bg-btn" id="pagerBgBtn">èƒŒæ™¯</button>
            <input type="file" id="pagerBgInput" accept="image/*" style="display:none">
            <button class="pager-clear" id="pagerClearBtn">æ¸…ç©º</button>
          </div>
        </div>
        <div class="pager-screen" id="pagerScreen">
          <div class="pager-msgs" id="pagerMsgs"></div>
        </div>
        <div class="pager-input-area">
          <textarea class="pager-input" id="pagerInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
          <button class="pager-send" id="pagerSendBtn">â†‘</button>
          <button class="pager-recv" id="pagerRecvBtn" title="æ¥æ”¶å›å¤" disabled>ğŸ“¥</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ä½¿ç”¨æ‰‹å†Œå¼¹çª— -->
<div class="modal" id="manualModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>ğŸ“˜ ä½¿ç”¨æ‰‹å†Œ</h3><button class="close-m" id="closeManualBtn">Ã—</button></div>
    <div class="modal-bd"><div class="manual-c" id="manualContent"></div></div>
  </div>
</div>

<!-- è®¾ç½®å¼¹çª— -->
<div class="modal" id="settingsModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>è®¾ç½®</h3><button class="close-m" id="closeSettingsBtn">Ã—</button></div>
    <div class="modal-bd">
      <div class="set-sec">
        <div class="set-item" id="setNightMode">
          <div class="set-item-l"><span class="set-icon">ğŸŒ™</span><div class="set-txt"><h4>å¤œé—´æŠ¤çœ¼</h4><p>é™ä½äº®åº¦</p></div></div>
          <div class="toggle" id="nightToggle"></div>
        </div>
        <div class="set-item" id="setFont">
          <div class="set-item-l"><span class="set-icon">ğŸ”¤</span><div class="set-txt"><h4>è‡ªå®šä¹‰å­—ä½“</h4><p>TTFé“¾æ¥</p></div></div>
          <div class="set-item-r"><span class="set-val" id="fontStatus">é»˜è®¤</span><span class="set-arrow">â€º</span></div>
        </div>
        <div class="set-item" id="setPassword">
          <div class="set-item-l"><span class="set-icon">ğŸ”</span><div class="set-txt"><h4>é”å±å¯†ç </h4><p>è®¾ç½®è®¿é—®å¯†ç </p></div></div>
          <div class="set-item-r"><span class="set-val" id="passwordStatus">æœªè®¾ç½®</span><span class="set-arrow">â€º</span></div>
        </div>
      </div>
      <div class="set-sec">
        <div class="set-item" id="setAgents">
          <div class="set-item-l"><span class="set-icon">ğŸ¤–</span><div class="set-txt"><h4>è‡ªå®šä¹‰æ™ºèƒ½ä½“</h4><p>AIè§’è‰²</p></div></div>
          <div class="set-item-r"><span class="set-val" id="agentCount">0ä¸ª</span><span class="set-arrow">â€º</span></div>
        </div>
        <div class="set-item" id="setMasks">
          <div class="set-item-l"><span class="set-icon">ğŸ­</span><div class="set-txt"><h4>è‡ªå®šä¹‰é¢å…·</h4><p>ç”¨æˆ·èº«ä»½</p></div></div>
          <div class="set-item-r"><span class="set-val" id="maskCount">0ä¸ª</span><span class="set-arrow">â€º</span></div>
        </div>
        <div class="set-item" id="setWorldbook">
          <div class="set-item-l"><span class="set-icon">ğŸ“š</span><div class="set-txt"><h4>ä¸–ç•Œä¹¦</h4><p>è®¾å®šå’ŒçŸ¥è¯†</p></div></div>
          <div class="set-item-r"><span class="set-val" id="wbCount">0æ¡</span><span class="set-arrow">â€º</span></div>
        </div>
        <div class="set-item" id="setMemory">
          <div class="set-item-l"><span class="set-icon">ğŸ§ </span><div class="set-txt"><h4>æ ¸å¿ƒè®°å¿†</h4><p>æ™ºèƒ½ä½“ä¸“å±è®°å¿†</p></div></div>
          <div class="set-item-r"><span class="set-val" id="memCount">0æ¡</span><span class="set-arrow">â€º</span></div>
        </div>
        <div class="set-item" id="setAPI">
          <div class="set-item-l"><span class="set-icon">ğŸ”‘</span><div class="set-txt"><h4>APIè®¾ç½®</h4><p>AIæ¥å£é…ç½®</p></div></div>
          <div class="set-item-r"><span class="set-val" id="apiStatusText">æœªé…ç½®</span><span class="set-arrow">â€º</span></div>
        </div>
      </div>
      <div class="set-sec">
        <div class="set-item" id="setCtxRange">
          <div class="set-item-l"><span class="set-icon">ğŸ“‹</span><div class="set-txt"><h4>çŸ­æœŸè®°å¿†èŒƒå›´</h4><p>å‘é€ç»™AIçš„ä¸Šä¸‹æ–‡æ—¶é—´</p></div></div>
          <div class="set-item-r"><span class="set-val" id="ctxRangeText">å…¨éƒ¨</span><span class="set-arrow">â€º</span></div>
        </div>
        <div class="set-item" id="setPagerMem">
          <div class="set-item-l"><span class="set-icon">ğŸ’¬</span><div class="set-txt"><h4>ä¼ å‘¼æœºå¯¹è¯è®°å¿†</h4><p>è®°ä½æœ€è¿‘Næ¡å¯¹è¯</p></div></div>
          <div class="set-item-r"><span class="set-val" id="pagerMemText">20æ¡</span><span class="set-arrow">â€º</span></div>
        </div>
        <div class="set-item" id="setAutoClean">
          <div class="set-item-l"><span class="set-icon">ğŸ§¹</span><div class="set-txt"><h4>æ—§æ•°æ®æ¸…ç†</h4><p>è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®</p></div></div>
          <div class="set-item-r"><span class="set-val" id="autoCleanText">å…³é—­</span><span class="set-arrow">â€º</span></div>
        </div>
      </div>
      <div class="set-sec">
        <div class="set-item" id="setExport">
          <div class="set-item-l"><span class="set-icon">ğŸ“¤</span><div class="set-txt"><h4>å¯¼å‡ºæ•°æ®</h4><p>å¤‡ä»½</p></div></div>
          <div class="set-item-r"><span class="set-arrow">â€º</span></div>
        </div>
        <div class="set-item" id="setImport">
          <div class="set-item-l"><span class="set-icon">ğŸ“¥</span><div class="set-txt"><h4>å¯¼å…¥æ•°æ®</h4><p>æ¢å¤</p></div></div>
          <div class="set-item-r"><span class="set-arrow">â€º</span></div>
          <input type="file" id="importInput" accept=".json" style="display:none">
        </div>
      </div>
      <div class="set-danger">
        <div class="set-item" id="setClear">
          <div class="set-item-l"><span class="set-icon">ğŸ—‘ï¸</span><div class="set-txt"><h4>æ¸…ç©ºæ‰€æœ‰æ•°æ®</h4><p>ä¸å¯æ¢å¤</p></div></div>
          <div class="set-item-r"><span class="set-arrow">â€º</span></div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- AIç®¡ç†å¼¹çª— -->
<div class="modal" id="agentModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>æ™ºèƒ½ä½“</h3><button class="close-m" id="closeAgentBtn">Ã—</button></div>
    <div class="modal-bd"><div id="agentList"></div><button class="add-agent" id="addAgentBtn">+ æ–°å»º</button></div>
  </div>
</div>

<div class="modal" id="maskModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>é¢å…·</h3><button class="close-m" id="closeMaskBtn">Ã—</button></div>
    <div class="modal-bd"><div id="maskList"></div><button class="add-agent" id="addMaskBtn">+ æ–°å»º</button></div>
  </div>
</div>

<div class="modal" id="wbModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>ä¸–ç•Œä¹¦</h3><button class="close-m" id="closeWbBtn">Ã—</button></div>
    <div class="modal-bd"><div id="wbList"></div><button class="add-agent" id="addWbBtn">+ æ–°å»º</button></div>
  </div>
</div>

<div class="modal" id="memModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>æ ¸å¿ƒè®°å¿†</h3><button class="close-m" id="closeMemBtn">Ã—</button></div>
    <div class="modal-bd"><div id="memList"></div><button class="add-agent" id="addMemBtn">+ æ–°å»º</button></div>
  </div>
</div>

<div class="modal" id="apiModal">
  <div class="modal-box">
    <div class="modal-hd"><h3>APIè®¾ç½®</h3><button class="close-m" id="closeApiBtn">Ã—</button></div>
    <div class="modal-bd">
      <div class="api-status disconnected" id="apiStatusBar"><div class="api-dot"></div><span>æœªè¿æ¥</span></div>
      <div class="set-input-g"><label>APIåœ°å€:</label><input class="set-input" id="apiUrlInput" placeholder="https://api.openai.com/v1"></div>
      <div class="set-input-g"><label>APIå¯†é’¥:</label><input class="set-input" id="apiKeyInput" type="password" placeholder="sk-..."></div>
      <div class="btn-row" style="margin-bottom:18px"><button class="btn-p" id="fetchModelsBtn">æ‹‰å–æ¨¡å‹</button></div>
      <div class="set-input-g"><label>é€‰æ‹©æ¨¡å‹:</label><div class="model-list" id="modelList"></div><input class="set-input" id="modelNameInput" placeholder="æˆ–æ‰‹åŠ¨è¾“å…¥" style="margin-top:8px"></div>
      <div class="set-input-g"><label>å‘å¸ƒæ™ºèƒ½ä½“:</label><select class="model-sel" id="pubAgentSelect"><option value="">é€‰æ‹©</option></select></div>
      <div class="auto-sch"><div class="auto-sch-label">è‡ªåŠ¨å‘å¸ƒé¢‘ç‡:</div><div class="auto-opts" id="autoIntervalOpts">
        <button class="auto-opt" data-iv="0">å…³é—­</button>
        <button class="auto-opt" data-iv="login">æ¯æ¬¡ä¸Šçº¿</button>
        <button class="auto-opt" data-iv="600000">10åˆ†é’Ÿ</button>
        <button class="auto-opt" data-iv="1800000">30åˆ†é’Ÿ</button>
        <button class="auto-opt" data-iv="3600000">1å°æ—¶</button>
      </div></div>
      <div class="btn-row" style="margin-bottom:12px"><button class="btn-p" id="saveApiBtn">ä¿å­˜</button></div>
      <div class="btn-row"><button class="btn-p" id="manualPubBtn" style="background:linear-gradient(135deg,#ff9800,#e65100)">æ‰‹åŠ¨AIå‘å¸ƒ</button></div>
    </div>
  </div>
</div>

<!-- å°å¼¹çª— -->
<div class="ovm" id="wishCreateModal">
  <div class="ovm-c"><div class="wm-body">
    <h3>ğŸ¾ è®¸æ„¿</h3>
    <textarea id="wishText" placeholder="å†™ä¸‹æ„¿æœ›..."></textarea>
    <label>å¼€å¯æ—¥æœŸ:</label>
    <input type="date" id="wishOpenDate">
    <div class="btn-row"><button class="btn-s" id="cancelWishBtn">å–æ¶ˆ</button><button class="btn-p" id="saveWishBtn">å°å­˜</button></div>
  </div></div>
</div>

<div class="ovm" id="wishViewModal">
  <div class="ovm-c"><div class="wm-body">
    <h3>ğŸ‰ æ„¿æœ›</h3>
    <div class="wv-body">
      <div class="wv-text" id="wishViewText"></div>
      <div class="wv-date" id="wishViewDate"></div>
      <div class="btn-row"><button class="btn-s" id="closeWishViewBtn">å…³é—­</button><button class="btn-p" id="deleteWishBtn">åˆ é™¤</button></div>
    </div>
  </div></div>
</div>

<div class="ovm" id="moodSelModal">
  <div class="ovm-c"><div class="wm-body">
    <h3>ä»Šå¤©å¿ƒæƒ…å¦‚ä½•?</h3>
    <div class="mood-sel">
      <div class="mood-opt" data-m="1">ğŸ˜¢</div>
      <div class="mood-opt" data-m="2">ğŸ˜”</div>
      <div class="mood-opt" data-m="3">ğŸ˜</div>
      <div class="mood-opt" data-m="4">ğŸ˜Š</div>
      <div class="mood-opt" data-m="5">ğŸ˜„</div>
    </div>
    <div class="btn-row"><button class="btn-s" id="cancelMoodBtn">å–æ¶ˆ</button><button class="btn-p" id="saveMoodBtn">ä¿å­˜</button></div>
  </div></div>
</div>

<div class="ovm" id="fontModal">
  <div class="ovm-c"><div class="wm-body">
    <h3>ğŸ”¤ å­—ä½“</h3>
    <div class="set-input-g"><label>TTFé“¾æ¥:</label><input class="set-input" id="fontUrlInput" type="url" placeholder="https://...font.ttf"><div class="set-hint">ç•™ç©ºæ¢å¤é»˜è®¤ã€‚</div></div>
    <div class="btn-row"><button class="btn-s" id="cancelFontBtn">å–æ¶ˆ</button><button class="btn-p" id="saveFontBtn">åº”ç”¨</button></div>
  </div></div>
</div>

<div class="ovm" id="passwordModal">
  <div class="ovm-c"><div class="wm-body">
    <h3>ğŸ” å¯†ç </h3>
    <div class="set-input-g"><label>æ–°å¯†ç :</label><input class="set-input" id="newPwdInput" type="password" maxlength="20"></div>
    <div class="set-input-g"><label>ç¡®è®¤:</label><input class="set-input" id="confirmPwdInput" type="password" maxlength="20"><div class="set-hint">ç•™ç©ºä¿å­˜=æ¸…é™¤ã€‚</div></div>
    <div class="btn-row"><button class="btn-s" id="cancelPwdBtn">å–æ¶ˆ</button><button class="btn-p" id="savePwdBtn">ä¿å­˜</button></div>
  </div></div>
</div>

<div class="ovm" id="agentEditModal">
  <div class="ovm-c"><div class="wm-body">
    <h3 id="agentEditTitle">æ™ºèƒ½ä½“</h3>
    <div class="set-input-g"><label>åç§°:</label><input class="set-input" id="agentNameInput" placeholder="å¦‚: è°¢è”šå®‰"></div>
    <div class="set-input-g"><label>å¯¹ç”¨æˆ·ç§°å‘¼:</label><input class="set-input" id="agentCallInput" placeholder="å¦‚: ç‡•ä¸–"></div>
    <div class="set-input-g"><label>è§’è‰²è®¾å®š:</label><textarea class="set-input" id="agentPromptInput" style="height:140px;resize:vertical;line-height:1.7" placeholder="æ€§æ ¼ã€èƒŒæ™¯..."></textarea></div>
    <input type="hidden" id="agentEditId">
    <div class="btn-row"><button class="btn-s" id="cancelAgentEditBtn">å–æ¶ˆ</button><button class="btn-p" id="saveAgentEditBtn">ä¿å­˜</button></div>
  </div></div>
</div>

<div class="ovm" id="maskEditModal">
  <div class="ovm-c"><div class="wm-body">
    <h3 id="maskEditTitle">é¢å…·</h3>
    <div class="set-input-g"><label>åç§°:</label><input class="set-input" id="maskNameInput"></div>
    <div class="set-input-g"><label>å¯¹å¯¹æ–¹ç§°å‘¼:</label><input class="set-input" id="maskCallInput"></div>
    <div class="set-input-g"><label>è§’è‰²è®¾å®š:</label><textarea class="set-input" id="maskPromptInput" style="height:120px;resize:vertical;line-height:1.7"></textarea></div>
    <div class="set-input-g"><label>å…³è”æ™ºèƒ½ä½“:</label><select class="model-sel" id="maskAgentSelect"><option value="">ä¸å…³è”</option></select></div>
    <input type="hidden" id="maskEditId">
    <div class="btn-row"><button class="btn-s" id="cancelMaskEditBtn">å–æ¶ˆ</button><button class="btn-p" id="saveMaskEditBtn">ä¿å­˜</button></div>
  </div></div>
</div>

<div class="ovm" id="wbEditModal">
  <div class="ovm-c"><div class="wm-body">
    <h3 id="wbEditTitle">ä¸–ç•Œä¹¦</h3>
    <div class="set-input-g"><label>åç§°:</label><input class="set-input" id="wbNameInput"></div>
    <div class="set-input-g"><label>å†…å®¹:</label><textarea class="set-input" id="wbContentInput" style="height:140px;resize:vertical;line-height:1.7"></textarea></div>
    <div class="set-input-g"><label>ç»‘å®š:</label><select class="model-sel" id="wbAgentSelect"><option value="">å…¨å±€</option></select></div>
    <input type="hidden" id="wbEditId">
    <div class="btn-row"><button class="btn-s" id="cancelWbEditBtn">å–æ¶ˆ</button><button class="btn-p" id="saveWbEditBtn">ä¿å­˜</button></div>
  </div></div>
</div>

<div class="ovm" id="memEditModal">
  <div class="ovm-c"><div class="wm-body">
    <h3 id="memEditTitle">æ ¸å¿ƒè®°å¿†</h3>
    <div class="set-input-g"><label>å…³è”æ™ºèƒ½ä½“:</label><select class="model-sel" id="memAgentSelect"><option value="">è¯·é€‰æ‹©</option></select></div>
    <div class="set-input-g"><label>æ ‡é¢˜:</label><input class="set-input" id="memTitleInput"></div>
    <div class="set-input-g"><label>å†…å®¹:</label><textarea class="set-input" id="memContentInput" style="height:160px;resize:vertical;line-height:1.7" placeholder="æ™ºèƒ½ä½“éœ€è¦æ°¸è¿œè®°ä½çš„ä¿¡æ¯..."></textarea><div class="set-hint">æ ¸å¿ƒè®°å¿†=æœ€é«˜ä¼˜å…ˆçº§ã€‚</div></div>
    <input type="hidden" id="memEditId">
    <div class="btn-row"><button class="btn-s" id="cancelMemEditBtn">å–æ¶ˆ</button><button class="btn-p" id="saveMemEditBtn">ä¿å­˜</button></div>
  </div></div>
</div>

<div class="ovm" id="ctxRangeModal">
  <div class="ovm-c"><div class="wm-body">
    <h3>ğŸ“‹ çŸ­æœŸè®°å¿†èŒƒå›´</h3>
    <div class="set-hint" style="margin-bottom:16px">é€‰æ‹©å‘é€ç»™AIçš„ä¸Šä¸‹æ–‡æ—¶é—´èŒƒå›´ã€‚</div>
    <div class="auto-opts" id="ctxRangeOpts" style="justify-content:center;margin-bottom:20px">
      <button class="auto-opt" data-rg="0">å…¨éƒ¨</button>
      <button class="auto-opt" data-rg="7">è¿‘ä¸€å‘¨</button>
      <button class="auto-opt" data-rg="30">è¿‘ä¸€ä¸ªæœˆ</button>
      <button class="auto-opt" data-rg="90">è¿‘ä¸‰ä¸ªæœˆ</button>
    </div>
    <div class="btn-row"><button class="btn-p" id="saveCtxRangeBtn">ä¿å­˜</button></div>
  </div></div>
</div>

<div class="ovm" id="pagerMemModal">
  <div class="ovm-c"><div class="wm-body">
    <h3>ğŸ’¬ å¯¹è¯è®°å¿†æ¡æ•°</h3>
    <div class="set-input-g"><label>è®°ä½æœ€è¿‘å‡ æ¡å¯¹è¯(å‘é€ç»™AI):</label><input class="set-input" id="pagerMemInput" type="number" min="5" max="100" value="20"><div class="set-hint">èŒƒå›´5-100ï¼Œé»˜è®¤20æ¡ã€‚</div></div>
    <div class="btn-row"><button class="btn-p" id="savePagerMemBtn">ä¿å­˜</button></div>
  </div></div>
</div>

<div class="ovm" id="autoCleanModal">
  <div class="ovm-c"><div class="wm-body">
    <h3>ğŸ§¹ æ—§æ•°æ®æ¸…ç†</h3>
    <div class="set-hint" style="margin-bottom:16px">è‡ªåŠ¨æ¸…ç†æŒ‡å®šæ—¶é—´ä¹‹å‰çš„ç¬”è®°ã€ä¾¿ç­¾ã€å¿ƒæƒ…è®°å½•ã€‚</div>
    <div class="auto-opts" id="autoCleanOpts" style="justify-content:center;margin-bottom:20px">
      <button class="auto-opt" data-cl="0">å…³é—­</button>
      <button class="auto-opt" data-cl="30">1ä¸ªæœˆå‰</button>
      <button class="auto-opt" data-cl="90">3ä¸ªæœˆå‰</button>
      <button class="auto-opt" data-cl="180">åŠå¹´å‰</button>
      <button class="auto-opt" data-cl="365">ä¸€å¹´å‰</button>
    </div>
    <div class="btn-row"><button class="btn-s" id="cancelCleanBtn">å–æ¶ˆ</button><button class="btn-p" id="saveCleanBtn">ä¿å­˜</button></div>
  </div></div>
</div>

<div class="toast" id="toast"></div>
<script>
(function(){
'use strict';

// ===== å…¨å±€å˜é‡ =====
var curPage=0,totalPages=10,photosPerPage=3;
var stickyColors=['yellow','pink','blue','green'],stickyCount=0;
var autoSaveTimer=null,hasUnsaved=false;
var themes=['green','red','yellow','white','black','blue','purple'],themeIdx=0;
var musicList=[],curMusic=0,isPlaying=false;
var wishList=[],curWish=null;
var moodData={pages:[[],[],[]],curPage:0},selMood=null;
var particleType='rain',particles=[],animId=null;
var checklistData=[],voiceList=[];
var mediaRec=null,audioChunks=[],recTimer=null,recSec=0;
var curVoice=null,vAudio=new Audio();
var agents=[],masks=[],worldbooks=[],memories=[];
var apiCfg={url:'',key:'',model:'',pubAgent:'',autoInterval:0};
var modelsList=[],autoPubTimer=null;
var pagerChat=[],pagerBg='',pagerMemCount=20;
var ctxRange=0,autoCleanDays=0;

// ===== å·¥å…·å‡½æ•° =====
function $(id){return document.getElementById(id)}
function toast(m){var t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},1800)}
function showAS(){var s=$('autoSave');s.classList.add('show');setTimeout(function(){s.classList.remove('show')},1200)}
function showLoad(){$('loadingOverlay').classList.add('show')}
function hideLoad(){var o=$('loadingOverlay');o.classList.add('hiding');setTimeout(function(){o.classList.remove('show','hiding')},500)}
function mark(){hasUnsaved=true}
function trigAS(){if(autoSaveTimer)clearTimeout(autoSaveTimer);autoSaveTimer=setTimeout(function(){saveAll();showAS();hasUnsaved=false},1000)}
function getToday(){var d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function todayDot(){var d=new Date();return d.getFullYear()+'.'+String(d.getMonth()+1).padStart(2,'0')+'.'+String(d.getDate()).padStart(2,'0')}
function fmtT(s){if(!s||isNaN(s))return'0:00';return Math.floor(s/60)+':'+(Math.floor(s%60)<10?'0':'')+Math.floor(s%60)}
function uid(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}
function getNow(){var d=new Date();return d.getHours()+':'+(d.getMinutes()<10?'0':'')+d.getMinutes()}

function compImg(f,mw,q,cb){
  var r=new FileReader();
  r.onload=function(e){
    var img=new Image();
    img.onload=function(){
      var c=document.createElement('canvas'),w=img.width,h=img.height;
      if(w>mw){h=Math.round(h*mw/w);w=mw}
      c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
      cb(c.toDataURL('image/jpeg',q));
    };
    img.onerror=function(){cb(e.target.result)};
    img.src=e.target.result;
  };
  r.readAsDataURL(f);
}

function hFile(inp,mw,q,cb){if(inp.files&&inp.files[0])compImg(inp.files[0],mw,q,cb);inp.value=''}

function changeTheme(){
  themeIdx=(themeIdx+1)%themes.length;
  var t=themes[themeIdx];
  document.body.setAttribute('data-theme',t);
  localStorage.setItem('currentTheme',t);
  mark();trigAS();
  toast({green:'ç»¿',red:'çº¢',yellow:'é»„',white:'ç™½',black:'é»‘',blue:'è“',purple:'ç´«'}[t]);
}

function loadTheme(){var s=localStorage.getItem('currentTheme');if(s&&themes.indexOf(s)>-1){document.body.setAttribute('data-theme',s);themeIdx=themes.indexOf(s)}}
function loadNight(){if(localStorage.getItem('nightMode')==='true')document.body.setAttribute('data-night','true')}

function applyFont(u){
  removeFont();
  var s=document.createElement('style');s.id='cfS';
  s.textContent='@font-face{font-family:"CF";src:url("'+u+'") format("truetype")}body,.ed,.s-text,.nb-c,.entry-content,.cl-text,.v-title,.lock-input,.set-input,.wm-body textarea,.model-sel,.pager-input,.pager-msg{font-family:"CF",-apple-system,"PingFang SC","Microsoft YaHei",sans-serif !important}';
  document.head.appendChild(s);
}
function removeFont(){var el=document.getElementById('cfS');if(el)el.remove()}
function loadFont(){var u=localStorage.getItem('customFontUrl');if(u)applyFont(u)}

function updateDays(){
  var sd=localStorage.getItem('loveStartDate');
  if(!sd){$('daysCount').textContent='0';$('startDateText').textContent='é€‰æ‹©ç›¸é‡æ—¥æœŸ';return}
  var s=new Date(sd),t=new Date();t.setHours(0,0,0,0);s.setHours(0,0,0,0);
  $('daysCount').textContent=Math.max(0,Math.floor((t-s)/864e5));
  $('startDateText').textContent='ä» '+sd;
  $('startDateInput').value=sd;
}

function bindE(el){
  el.querySelectorAll('[contenteditable="true"]').forEach(function(e){
    e.addEventListener('blur',function(){mark();trigAS()});
    e.addEventListener('input',mark);
  });
}

function updateSelects(){
  ['maskAgentSelect','wbAgentSelect','pubAgentSelect','memAgentSelect'].forEach(function(sid){
    var sel=$(sid);if(!sel)return;
    var v=sel.value,ft=sel.options[0]?sel.options[0].text:'';
    sel.innerHTML='<option value="">'+ft+'</option>';
    agents.forEach(function(a){var o=document.createElement('option');o.value=a.id;o.textContent=a.name;sel.appendChild(o)});
    sel.value=v;
  });
  $('agentCount').textContent=agents.length+'ä¸ª';
}

function isWithinRange(dateStr,days){
  if(!days||days<=0)return true;
  var d=new Date(dateStr.replace(/\./g,'-'));if(isNaN(d))return true;
  var cutoff=new Date();cutoff.setDate(cutoff.getDate()-days);
  return d>=cutoff;
}

function closeModal(m){m.classList.remove('open');document.body.style.overflow=''}
function openModal(m){m.classList.add('open');document.body.style.overflow='hidden'}

// ===== ç²’å­ç³»ç»Ÿ =====
function initParticles(){
  var cv=$('particlesCanvas'),cx=cv.getContext('2d');
  function rs(){cv.width=innerWidth;cv.height=innerHeight}
  rs();addEventListener('resize',rs);

  function cp(ry){
    var p={x:0,y:0,vx:0,vy:0,sz:0,op:1,rt:0,rs:0,sw:0,ln:0},w=cv.width,h=cv.height;
    switch(particleType){
      case'rain':p.x=Math.random()*w*1.2;p.y=ry?Math.random()*h:-Math.random()*80;p.vx=-0.8;p.vy=7+Math.random()*5;p.sz=0.8+Math.random()*1.5;p.op=0.3+Math.random()*0.3;break;
      case'sakura':p.x=Math.random()*w*1.2;p.y=ry?Math.random()*h:-Math.random()*40;p.vx=-0.8+Math.random()*1.6;p.vy=0.8+Math.random()*1.8;p.sz=6+Math.random()*7;p.op=0.6+Math.random()*0.4;p.rt=Math.random()*360;p.rs=-2+Math.random()*4;break;
      case'meteor':p.x=Math.random()*w*1.5;p.y=-Math.random()*h*0.5;p.vx=-7-Math.random()*5;p.vy=7+Math.random()*5;p.sz=1.5+Math.random()*2;p.op=0.9;p.ln=25+Math.random()*45;break;
      case'leaves':p.x=Math.random()*w*1.1;p.y=ry?Math.random()*h:-Math.random()*40;p.vx=-0.5+Math.random();p.vy=1+Math.random()*2;p.sz=8+Math.random()*10;p.op=0.75;p.rt=Math.random()*360;p.rs=-2.5+Math.random()*5;p.sw=Math.random()*Math.PI*2;break;
      case'snow':p.x=Math.random()*w;p.y=ry?Math.random()*h:-Math.random()*40;p.vx=-0.3+Math.random()*0.6;p.vy=0.6+Math.random()*1.8;p.sz=2+Math.random()*4;p.op=0.5+Math.random()*0.4;p.sw=Math.random()*Math.PI*2;break;
    }
    return p;
  }

  function gn(){return{rain:80,sakura:35,meteor:6,leaves:25,snow:50}[particleType]||40}

  function reset(){particles=[];for(var i=0;i<gn();i++)particles.push(cp(true))}

  function draw(p){
    cx.save();cx.globalAlpha=p.op;
    switch(particleType){
      case'rain':
        cx.strokeStyle='rgba(160,196,232,0.7)';cx.lineWidth=p.sz;
        cx.beginPath();cx.moveTo(p.x,p.y);cx.lineTo(p.x+p.vx*2.5,p.y+p.vy*2.5);cx.stroke();
        break;
      case'sakura':
        cx.translate(p.x,p.y);cx.rotate(p.rt*Math.PI/180);
        for(var i=0;i<5;i++){cx.fillStyle=i%2?'#ffc8d6':'#ffb7c5';cx.beginPath();cx.ellipse(0,-p.sz*0.4,p.sz*0.22,p.sz*0.42,0,0,Math.PI*2);cx.fill();cx.rotate(Math.PI*2/5)}
        cx.fillStyle='#fff0f3';cx.beginPath();cx.arc(0,0,p.sz*0.15,0,Math.PI*2);cx.fill();
        break;
      case'meteor':
        var g=cx.createLinearGradient(p.x,p.y,p.x-p.ln*0.6,p.y-p.ln*0.6);
        g.addColorStop(0,'rgba(255,255,255,0.9)');g.addColorStop(1,'rgba(255,255,200,0)');
        cx.strokeStyle=g;cx.lineWidth=p.sz;cx.lineCap='round';
        cx.beginPath();cx.moveTo(p.x,p.y);cx.lineTo(p.x-p.ln*0.6,p.y-p.ln*0.6);cx.stroke();
        cx.fillStyle='#fff';cx.shadowColor='#fff';cx.shadowBlur=6;
        cx.beginPath();cx.arc(p.x,p.y,p.sz*0.8,0,Math.PI*2);cx.fill();
        break;
      case'leaves':
        cx.translate(p.x,p.y);cx.rotate(p.rt*Math.PI/180);cx.fillStyle='#c08040';
        cx.beginPath();cx.moveTo(0,-p.sz/2);cx.quadraticCurveTo(p.sz/2,0,0,p.sz/2);cx.quadraticCurveTo(-p.sz/2,0,0,-p.sz/2);cx.fill();
        break;
      case'snow':
        var sg=cx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.sz);
        sg.addColorStop(0,'rgba(255,255,255,0.9)');sg.addColorStop(1,'rgba(255,255,255,0)');
        cx.fillStyle=sg;cx.beginPath();cx.arc(p.x,p.y,p.sz,0,Math.PI*2);cx.fill();
        break;
    }
    cx.restore();
  }

  function upd(p,t){
    switch(particleType){
      case'rain':p.x+=p.vx;p.y+=p.vy;break;
      case'sakura':p.x+=p.vx+Math.sin(t/800+p.rt)*0.4;p.y+=p.vy;p.rt+=p.rs;break;
      case'meteor':p.x+=p.vx;p.y+=p.vy;p.op-=0.006;break;
      case'leaves':p.x+=p.vx+Math.sin(t/400+p.sw)*1.2;p.y+=p.vy;p.rt+=p.rs;break;
      case'snow':p.x+=p.vx+Math.sin(t/900+p.sw)*0.4;p.y+=p.vy;break;
    }
    if(p.y>cv.height+40||p.x<-60||p.x>cv.width+60||p.op<=0)return cp(false);
    return p;
  }

  function anim(t){
    cx.clearRect(0,0,cv.width,cv.height);
    for(var i=0;i<particles.length;i++){draw(particles[i]);particles[i]=upd(particles[i],t)}
    animId=requestAnimationFrame(anim);
  }

  reset();anim(0);

  document.querySelectorAll('.particle-btn').forEach(function(b){
    b.addEventListener('click',function(e){
      e.stopPropagation();
      document.querySelectorAll('.particle-btn').forEach(function(x){x.classList.remove('active')});
      this.classList.add('active');
      particleType=this.dataset.type;
      localStorage.setItem('particleType',particleType);
      reset();
    });
  });

  var st=localStorage.getItem('particleType');
  if(st&&st!==particleType){
    particleType=st;
    document.querySelectorAll('.particle-btn').forEach(function(b){b.classList.toggle('active',b.dataset.type===st)});
    reset();
  }
}

function stopP(){if(animId){cancelAnimationFrame(animId); animId=null;}}

// ===== éŸ³ä¹æ’­æ”¾å™¨ =====
function initMusic(){
  var au=$('audioPlayer'),disc=$('musicDisc'),pb=$('playPauseBtn'),pB=$('musicProgBar'),pr=$('musicProg'),tE=$('musicTitle'),tm=$('musicTime');

  function uUI(){
    var n=musicList.length;
    $('musicListBtn').textContent='åˆ—è¡¨('+n+'/5)';
    $('addMusicBtn').textContent=n>=5?'å·²æ»¡':'+ æ·»åŠ ';
    $('addMusicBtn').disabled=n>=5;
    tE.textContent=n&&curMusic<n?musicList[curMusic].name:'æœªé€‰æ‹©éŸ³ä¹';
    rL();
  }

  function rL(){
    var c=$('musicListBox');c.innerHTML='';
    musicList.forEach(function(m,i){
      var it=document.createElement('div');
      it.className='mi'+(i===curMusic&&isPlaying?' active':'');
      it.innerHTML='<span class="mi-idx">'+(i+1)+'</span><span class="mi-nm">'+m.name+'</span><div style="display:flex;gap:6px"><button class="mi-btn" data-a="r" data-i="'+i+'">ğŸ”„</button><button class="mi-btn" data-a="d" data-i="'+i+'">âœ•</button></div>';
      it.addEventListener('click',function(e){if(!e.target.closest('.mi-btn'))pI(i)});
      c.appendChild(it);
    });
  }

  function pI(i){
    if(!musicList.length)return;
    curMusic=i;au.src=musicList[i].data;
    au.play().then(function(){isPlaying=true;disc.classList.add('playing');pb.textContent='â¸';uUI()}).catch(function(){});
  }

  pb.addEventListener('click',function(){
    if(!musicList.length){toast('è¯·å…ˆæ·»åŠ éŸ³ä¹');return}
    if(isPlaying){au.pause();isPlaying=false;disc.classList.remove('playing');pb.textContent='â–¶'}
    else{if(!au.src||au.src===location.href)pI(curMusic);else au.play().then(function(){isPlaying=true;disc.classList.add('playing');pb.textContent='â¸'}).catch(function(){})}
    uUI();
  });

  $('nextMusicBtn').addEventListener('click',function(){if(musicList.length)pI((curMusic+1)%musicList.length)});
  $('prevMusicBtn').addEventListener('click',function(){if(musicList.length)pI((curMusic-1+musicList.length)%musicList.length)});

  au.addEventListener('timeupdate',function(){if(au.duration){pB.style.width=(au.currentTime/au.duration*100)+'%';tm.textContent=fmtT(au.currentTime)}});
  au.addEventListener('ended',function(){pI((curMusic+1)%musicList.length)});
  pr.addEventListener('click',function(e){if(au.duration){var r=pr.getBoundingClientRect();au.currentTime=((e.clientX-r.left)/r.width)*au.duration}});

  $('musicListBtn').addEventListener('click',function(){openModal($('musicListModal'))});
  $('closeMusicList').addEventListener('click',function(){closeModal($('musicListModal'))});
  $('musicListModal').addEventListener('click',function(e){if(e.target===this)closeModal(this)});

  $('addMusicBtn').addEventListener('click',function(){if(musicList.length>=5)return;$('musicFileInput').click()});
  $('musicFileInput').addEventListener('change',function(){
    if(!this.files||!this.files[0])return;
    var f=this.files[0];
    if(f.size>15e6){toast('éœ€<15MB');this.value='';return}
    var rd=new FileReader();
    rd.onload=function(e){
      var nm=f.name.replace(/\.[^/.]+$/,'');
      musicList.push({name:nm,data:e.target.result});
      uUI();mark();trigAS();
      if(musicList.length===1)pI(0);
    };
    rd.readAsDataURL(f);this.value='';
  });

  var rI=-1,rInp=document.createElement('input');
  rInp.type='file';rInp.accept='audio/*';rInp.style.display='none';document.body.appendChild(rInp);
  rInp.addEventListener('change',function(){
    if(!this.files||!this.files[0]||rI<0)return;
    var f=this.files[0];
    if(f.size>15e6){this.value='';return}
    var rd=new FileReader(),idx=rI;
    rd.onload=function(e){
      musicList[idx]={name:f.name.replace(/\.[^/.]+$/,''),data:e.target.result};
      if(idx===curMusic&&isPlaying)pI(idx);
      uUI();mark();trigAS();
    };
    rd.readAsDataURL(f);this.value='';
  });

  $('musicListBox').addEventListener('click',function(e){
    var b=e.target.closest('.mi-btn');if(!b)return;
    var a=b.dataset.a,i=+b.dataset.i;
    if(a==='r'){rI=i;rInp.click()}
    else if(a==='d'&&confirm('åˆ é™¤?')){
      var wp=i===curMusic&&isPlaying;
      musicList.splice(i,1);
      if(!musicList.length){au.pause();au.src='';isPlaying=false;disc.classList.remove('playing');pb.textContent='â–¶';curMusic=0;tm.textContent='0:00';pB.style.width='0%'}
      else{if(i<curMusic)curMusic--;else if(i===curMusic){curMusic%=musicList.length;if(wp)pI(curMusic)}}
      uUI();mark();trigAS();
    }
  });

  $('discCenter').addEventListener('click',function(e){e.stopPropagation();$('discImgInput').click()});
  $('discImgInput').addEventListener('change',function(){
    if(this.files&&this.files[0])compImg(this.files[0],200,0.8,function(u){
      $('discImg').src=u;$('discImg').style.display='block';$('discPh').style.display='none';mark();trigAS();
    });
    this.value='';
  });
  uUI();
}

function autoPlay(){
  if(!musicList.length)return;
  var a=$('audioPlayer');a.src=musicList[curMusic].data;
  $('musicTitle').textContent=musicList[curMusic].name;
  a.play().then(function(){
    isPlaying=true;$('musicDisc').classList.add('playing');$('playPauseBtn').textContent='â¸';
  }).catch(function(){
    document.addEventListener('click',function o(){
      if(musicList.length&&!isPlaying)a.play().then(function(){isPlaying=true;$('musicDisc').classList.add('playing');$('playPauseBtn').textContent='â¸'}).catch(function(){});
      document.removeEventListener('click',o);
    },{once:true});
  });
}

// ===== é”å±+å°é¢ =====
function initLock(){
  var pwd=localStorage.getItem('lockPassword'),lk=$('lockScreen');
  if(!pwd){lk.classList.add('hidden');return}
  lk.classList.remove('hidden');
  function go(){
    if($('lockInput').value===pwd){lk.classList.add('hiding');setTimeout(function(){lk.classList.add('hidden')},600)}
    else{$('lockInput').classList.add('error');$('lockError').textContent='å¯†ç é”™è¯¯';setTimeout(function(){$('lockInput').classList.remove('error')},400)}
  }
  $('lockSubmit').addEventListener('click',go);
  $('lockInput').addEventListener('keydown',function(e){if(e.key==='Enter')go()});
}

function enterMain(){
  var c=$('coverPage');c.classList.add('hiding');
  setTimeout(function(){c.classList.add('hidden');stopP()},700);
  $('mainPage').classList.add('show');
  $('topControls').classList.add('show');
  $('bottomBar').classList.add('show');
  localStorage.setItem('coverEntered','true');
  autoPlay();
  setTimeout(checkWN,500);
  trigLogin();
}

function initCover(){
  var c=$('coverPage'),sy=0,mv=false;
  if(localStorage.getItem('coverEntered')==='true'){
    c.classList.add('hidden');
    $('mainPage').classList.add('show');
    $('topControls').classList.add('show');
    $('bottomBar').classList.add('show');
    stopP();autoPlay();
    setTimeout(checkWN,1000);
    trigLogin();
    return;
  }
  c.addEventListener('touchstart',function(e){sy=e.touches[0].clientY;mv=false},{passive:true});
  c.addEventListener('touchmove',function(e){if(!c.classList.contains('hiding')&&sy-e.touches[0].clientY>55){mv=true;enterMain()}},{passive:true});
  c.addEventListener('touchend',function(e){if(!mv&&e.target.closest('.swipe-area'))enterMain()},{passive:true});
  $('swipeArea').addEventListener('click',function(e){e.stopPropagation();enterMain()});
  c.addEventListener('click',function(e){if(!e.target.closest('.particle-btn'))enterMain()});
  c.addEventListener('wheel',function(e){if(e.deltaY>0)enterMain()},{passive:true});
}

// ===== è®¸æ„¿ç“¶ =====
function renderWB(){
  var c=$('wishGrid');c.innerHTML='';
  wishList.forEach(function(w,i){
    var b=document.createElement('div'),now=new Date(),od=new Date(w.openDate+'T23:59:59'),rdy=now>=od;
    b.className='wish-bottle'+(rdy?' ready':'');
    b.innerHTML=rdy?'<div class="b-icon">âœ¨</div><div class="b-status">å¯ä»¥æ‰“å¼€!</div>':'<div class="b-icon">ğŸ¾</div><div class="b-status">è¿˜æœ‰'+Math.ceil((od-now)/864e5)+'å¤©</div>';
    b.addEventListener('click',function(){
      if(rdy){curWish=i;$('wishViewText').textContent=w.text;$('wishViewDate').textContent='è®¸æ„¿äº '+w.createDate+(w.author?' Â· '+w.author:'');openModal($('wishViewModal'))}
      else toast('è¿˜æ²¡åˆ°æ—¶é—´~');
    });
    c.appendChild(b);
  });
  var ab=document.createElement('div');ab.className='add-wish';ab.innerHTML='<span>+</span><p>è®¸ä¸ªæ„¿</p>';
  ab.addEventListener('click',function(){
    $('wishText').value='';
    var n=new Date();n.setDate(n.getDate()+7);
    $('wishOpenDate').value=n.toISOString().split('T')[0];
    $('wishOpenDate').min=getToday();
    openModal($('wishCreateModal'));
  });
  c.appendChild(ab);
}

function checkWN(){$('wishNotif').classList.toggle('show',wishList.some(function(w){return new Date()>=new Date(w.openDate+'T23:59:59')}))}

function initWish(){
  $('wishCard').addEventListener('click',function(){openModal($('wishModal'));renderWB()});
  $('closeWishBtn').addEventListener('click',function(){closeModal($('wishModal'))});
  $('cancelWishBtn').addEventListener('click',function(){closeModal($('wishCreateModal'))});
  $('saveWishBtn').addEventListener('click',function(){
    var t=$('wishText').value.trim(),d=$('wishOpenDate').value;
    if(!t){toast('è¯·å†™ä¸‹æ„¿æœ›');return}if(!d){toast('è¯·é€‰æ‹©æ—¥æœŸ');return}
    wishList.push({text:t,openDate:d,createDate:getToday()});
    closeModal($('wishCreateModal'));renderWB();mark();trigAS();toast('å·²å°å­˜ âœ¨');
  });
  $('closeWishViewBtn').addEventListener('click',function(){closeModal($('wishViewModal'));curWish=null});
  $('deleteWishBtn').addEventListener('click',function(){
    if(curWish!==null&&confirm('åˆ é™¤?')){wishList.splice(curWish,1);closeModal($('wishViewModal'));curWish=null;renderWB();mark();trigAS();checkWN()}
  });
  $('wishNotif').addEventListener('click',function(){openModal($('wishModal'));this.classList.remove('show');renderWB()});
  renderWB();
}

// ===== å¿ƒæƒ…æ›²çº¿ =====
function initMood(){
  function render(){
    var ch=$('moodChart'),nav=$('moodPgsNav'),pg=moodData.pages[moodData.curPage]||[];
    ch.innerHTML=pg.length?'':'<div style="color:var(--ts);padding:30px;text-align:center;width:100%;font-size:13px">è¿˜æ²¡æœ‰è®°å½•~</div>';
    pg.forEach(function(it){
      var b=document.createElement('div');b.className='mood-bar';
      b.innerHTML='<div class="mood-bar-fill m'+it.mood+'" style="height:'+(it.mood*28+22)+'px"></div><div class="mood-bar-date">'+it.date.slice(5)+'</div>';
      ch.appendChild(b);
    });
    $('moodPgInfo').textContent='ç¬¬'+(moodData.curPage+1)+'é¡µ ('+pg.length+'/30)';
    nav.innerHTML='';
    for(var i=0;i<3;i++){
      var btn=document.createElement('button');btn.className='mood-pg-btn'+(i===moodData.curPage?' active':'');
      btn.textContent='ç¬¬'+(i+1)+'é¡µ';btn.dataset.pg=i;
      if(i>0&&(!moodData.pages[i-1]||moodData.pages[i-1].length<30))btn.disabled=true;
      btn.addEventListener('click',function(){if(!this.disabled){moodData.curPage=+this.dataset.pg;render()}});
      nav.appendChild(btn);
    }
    var ab=$('addMoodBtn'),td=getToday(),rec=moodData.pages.some(function(p){return p&&p.some(function(x){return x.date===td})});
    if(rec){ab.disabled=true;ab.textContent='ä»Šå¤©å·²è®°å½• âœ“'}
    else if(pg.length>=30){ab.disabled=true;ab.textContent='æœ¬é¡µå·²æ»¡'}
    else{ab.disabled=false;ab.textContent='è®°å½•ä»Šå¤©çš„å¿ƒæƒ…'}
  }
  $('moodCard').addEventListener('click',function(){openModal($('moodModal'));render()});
  $('closeMoodBtn').addEventListener('click',function(){closeModal($('moodModal'))});
  $('addMoodBtn').addEventListener('click',function(){
    if(this.disabled)return;selMood=null;
    document.querySelectorAll('.mood-opt').forEach(function(o){o.classList.remove('selected')});
    openModal($('moodSelModal'));
  });
  document.querySelectorAll('.mood-opt').forEach(function(o){
    o.addEventListener('click',function(){
      document.querySelectorAll('.mood-opt').forEach(function(x){x.classList.remove('selected')});
      this.classList.add('selected');selMood=+this.dataset.m;
    });
  });
  $('cancelMoodBtn').addEventListener('click',function(){closeModal($('moodSelModal'))});
  $('saveMoodBtn').addEventListener('click',function(){
    if(!selMood){toast('è¯·é€‰æ‹©');return}
    if(!moodData.pages[moodData.curPage])moodData.pages[moodData.curPage]=[];
    moodData.pages[moodData.curPage].push({date:getToday(),mood:selMood});
    closeModal($('moodSelModal'));render();mark();trigAS();toast('å·²è®°å½• âœ¨');
  });
  render();
}

// ===== æƒ…ä¾£æ¸…å• =====
function initChecklist(){
  function render(){
    var c=$('checklistBox');c.innerHTML='';var dn=0;
    checklistData.forEach(function(it,i){
      if(it.done)dn++;
      var el=document.createElement('div');el.className='cl-item'+(it.done?' done':'');
      el.innerHTML='<div class="cl-cb'+(it.done?' checked':'')+'" data-i="'+i+'">'+(it.done?'âœ“':'')+'</div><div class="cl-info"><div class="cl-text ed" contenteditable="true" data-i="'+i+'">'+it.text+'</div>'+(it.doneDate?'<div class="cl-done-date">âœ“ '+it.doneDate+'</div>':'')+'</div><button class="cl-del" data-i="'+i+'">Ã—</button>';
      c.appendChild(el);
    });
    var t=checklistData.length;
    $('clStats').textContent='å·²å®Œæˆ '+dn+'/'+t;
    $('clProgBar').style.width=t?(dn/t*100)+'%':'0%';
  }
  $('checklistCard').addEventListener('click',function(){openModal($('checklistModal'));render()});
  $('closeChecklistBtn').addEventListener('click',function(){closeModal($('checklistModal'));if(hasUnsaved){saveAll();showAS();hasUnsaved=false}});
  $('addChecklistBtn').addEventListener('click',function(){checklistData.push({text:'æƒ³ä¸€èµ·åšçš„äº‹...',done:false,doneDate:''});render();mark();trigAS()});
  $('checklistBox').addEventListener('click',function(e){
    var cb=e.target.closest('.cl-cb');
    if(cb){var i=+cb.dataset.i;checklistData[i].done=!checklistData[i].done;checklistData[i].doneDate=checklistData[i].done?todayDot():'';render();mark();trigAS();return}
    var d=e.target.closest('.cl-del');if(d&&confirm('åˆ é™¤?')){checklistData.splice(+d.dataset.i,1);render();mark();trigAS()}
  });
  $('checklistBox').addEventListener('blur',function(e){if(e.target.classList.contains('cl-text')){checklistData[+e.target.dataset.i].text=e.target.innerHTML;mark();trigAS()}},true);
  render();
}

// ===== è¯­éŸ³ä¿¡ç®± =====
function initVoice(){
  function rL(){
    var c=$('voiceList');
    c.innerHTML=voiceList.length?'':'<div class="voice-empty">è¿˜æ²¡æœ‰å½•éŸ³~</div>';
    voiceList.forEach(function(v,i){
      var el=document.createElement('div');el.className='voice-item';
      el.innerHTML='<button class="v-play" data-i="'+i+'">â–¶</button><div class="v-info"><div class="v-title" contenteditable="true" data-i="'+i+'">'+v.title+'</div><div class="v-meta">'+v.date+' Â· '+v.duration+'</div><div class="v-prog"><div class="v-prog-bar" id="vP_'+i+'"></div></div></div><button class="v-del" data-i="'+i+'">Ã—</button>';
      c.appendChild(el);
    });
  }

  $('voiceCard').addEventListener('click',function(){openModal($('voiceModal'));rL()});
  $('closeVoiceBtn').addEventListener('click',function(){closeModal($('voiceModal'));sVP();if(mediaRec&&mediaRec.state==='recording')sR()});

  var isR=false;
  $('recBtn').addEventListener('click',function(){if(!isR)stR();else sR()});

  function stR(){
    if(!navigator.mediaDevices){toast('ä¸æ”¯æŒå½•éŸ³');return}
    navigator.mediaDevices.getUserMedia({audio:true}).then(function(stream){
      audioChunks=[];recSec=0;
      mediaRec=new MediaRecorder(stream);
      mediaRec.addEventListener('dataavailable',function(e){if(e.data.size>0)audioChunks.push(e.data)});
      mediaRec.addEventListener('stop',function(){
        stream.getTracks().forEach(function(t){t.stop()});
        if(!audioChunks.length)return;
        var bl=new Blob(audioChunks,{type:'audio/webm'}),rd=new FileReader();
        rd.onload=function(e){
          voiceList.push({title:'å½•éŸ³'+(voiceList.length+1),date:todayDot(),duration:fmtT(recSec),data:e.target.result});
          rL();mark();trigAS();toast('å·²ä¿å­˜ğŸ™ï¸');
        };
        rd.readAsDataURL(bl);
      });
      mediaRec.start();isR=true;
      $('recBtn').classList.add('recording');$('recBtn').textContent='â¹';
      $('recStatus').textContent='å½•éŸ³ä¸­...';
      recTimer=setInterval(function(){recSec++;$('recTime').textContent=fmtT(recSec)},1000);
    }).catch(function(){toast('è¯·å…è®¸éº¦å…‹é£')});
  }

  function sR(){
    if(mediaRec&&mediaRec.state==='recording')mediaRec.stop();
    isR=false;$('recBtn').classList.remove('recording');$('recBtn').textContent='ğŸ™ï¸';
    $('recStatus').textContent='ç‚¹å‡»å½•éŸ³';
    if(recTimer){clearInterval(recTimer);recTimer=null}
    $('recTime').textContent='0:00';
  }

  function sVP(){vAudio.pause();vAudio.src='';curVoice=null;document.querySelectorAll('.v-play').forEach(function(b){b.classList.remove('playing');b.textContent='â–¶'})}

  vAudio.addEventListener('timeupdate',function(){if(curVoice!==null&&vAudio.duration){var b=$('vP_'+curVoice);if(b)b.style.width=(vAudio.currentTime/vAudio.duration*100)+'%'}});
  vAudio.addEventListener('ended',sVP);

  $('voiceList').addEventListener('click',function(e){
    var pb=e.target.closest('.v-play');
    if(pb){var i=+pb.dataset.i;if(curVoice===i){sVP();return}sVP();curVoice=i;vAudio.src=voiceList[i].data;vAudio.play().then(function(){pb.classList.add('playing');pb.textContent='â¸'}).catch(function(){toast('æ’­æ”¾å¤±è´¥')});return}
    var d=e.target.closest('.v-del');if(d&&confirm('åˆ é™¤?')){if(curVoice===+d.dataset.i)sVP();voiceList.splice(+d.dataset.i,1);rL();mark();trigAS()}
  });

  $('voiceList').addEventListener('blur',function(e){if(e.target.classList.contains('v-title')){voiceList[+e.target.dataset.i].title=e.target.textContent;mark();trigAS()}},true);
  rL();
}

// ===== æ™ºèƒ½ä½“ç®¡ç† =====
function renderAgents(){
  var c=$('agentList');c.innerHTML='';
  agents.forEach(function(a){
    var el=document.createElement('div');el.className='agent-card';
    el.innerHTML='<div class="agent-avatar">ğŸ¤–</div><div class="agent-info"><div class="agent-nm">'+a.name+'</div><div class="agent-desc">ç§°å‘¼:'+(a.call||'æ— ')+' Â· '+(a.prompt||'').slice(0,30)+'</div></div><div style="display:flex;gap:6px"><button class="agent-act" data-a="e" data-id="'+a.id+'">âœï¸</button><button class="agent-act" data-a="d" data-id="'+a.id+'">ğŸ—‘ï¸</button></div>';
    c.appendChild(el);
  });
}

function initAgents(){
  $('setAgents').addEventListener('click',function(){openModal($('agentModal'));renderAgents()});
  $('closeAgentBtn').addEventListener('click',function(){closeModal($('agentModal'))});
  $('addAgentBtn').addEventListener('click',function(){
    $('agentEditTitle').textContent='æ–°å»º';$('agentNameInput').value='';$('agentCallInput').value='';$('agentPromptInput').value='';$('agentEditId').value='';
    openModal($('agentEditModal'));
  });
  $('cancelAgentEditBtn').addEventListener('click',function(){closeModal($('agentEditModal'))});
  $('saveAgentEditBtn').addEventListener('click',function(){
    var n=$('agentNameInput').value.trim(),c=$('agentCallInput').value.trim(),p=$('agentPromptInput').value.trim(),eid=$('agentEditId').value;
    if(!n){toast('è¯·è¾“å…¥åç§°');return}
    if(eid){var a=agents.find(function(x){return x.id===eid});if(a){a.name=n;a.call=c;a.prompt=p}}
    else agents.push({id:uid(),name:n,call:c,prompt:p});
    closeModal($('agentEditModal'));renderAgents();updateSelects();mark();trigAS();
  });
  $('agentList').addEventListener('click',function(e){
    var b=e.target.closest('.agent-act');if(!b)return;
    var a=b.dataset.a,id=b.dataset.id;
    if(a==='e'){
      var ag=agents.find(function(x){return x.id===id});if(!ag)return;
      $('agentEditTitle').textContent='ç¼–è¾‘';$('agentNameInput').value=ag.name;$('agentCallInput').value=ag.call;$('agentPromptInput').value=ag.prompt;$('agentEditId').value=ag.id;
      openModal($('agentEditModal'));
    }else if(a==='d'&&confirm('åˆ é™¤?')){agents=agents.filter(function(x){return x.id!==id});renderAgents();updateSelects();mark();trigAS()}
  });
}

// ===== é¢å…·ç®¡ç† =====
function renderMasks(){
  var c=$('maskList');c.innerHTML='';
  masks.forEach(function(m){
    var an='æ— ';if(m.agentId){var a=agents.find(function(x){return x.id===m.agentId});if(a)an=a.name}
    var el=document.createElement('div');el.className='agent-card';
    el.innerHTML='<div class="agent-avatar" style="background:linear-gradient(135deg,#e0c3fc,#8ec5fc)">ğŸ­</div><div class="agent-info"><div class="agent-nm">'+m.name+'</div><div class="agent-desc">ç§°å‘¼:'+(m.call||'æ— ')+' Â· ç»‘å®š:'+an+'</div></div><div style="display:flex;gap:6px"><button class="agent-act" data-a="e" data-id="'+m.id+'">âœï¸</button><button class="agent-act" data-a="d" data-id="'+m.id+'">ğŸ—‘ï¸</button></div>';
    c.appendChild(el);
  });
  $('maskCount').textContent=masks.length+'ä¸ª';
}

function initMasks(){
  $('setMasks').addEventListener('click',function(){openModal($('maskModal'));updateSelects();renderMasks()});
  $('closeMaskBtn').addEventListener('click',function(){closeModal($('maskModal'))});
  $('addMaskBtn').addEventListener('click',function(){
    $('maskEditTitle').textContent='æ–°å»º';$('maskNameInput').value='';$('maskCallInput').value='';$('maskPromptInput').value='';$('maskAgentSelect').value='';$('maskEditId').value='';
    updateSelects();openModal($('maskEditModal'));
  });
  $('cancelMaskEditBtn').addEventListener('click',function(){closeModal($('maskEditModal'))});
  $('saveMaskEditBtn').addEventListener('click',function(){
    var n=$('maskNameInput').value.trim(),c=$('maskCallInput').value.trim(),p=$('maskPromptInput').value.trim(),ai=$('maskAgentSelect').value,eid=$('maskEditId').value;
    if(!n){toast('è¯·è¾“å…¥åç§°');return}
    if(eid){var m=masks.find(function(x){return x.id===eid});if(m){m.name=n;m.call=c;m.prompt=p;m.agentId=ai}}
    else masks.push({id:uid(),name:n,call:c,prompt:p,agentId:ai});
    closeModal($('maskEditModal'));renderMasks();mark();trigAS();
  });
  $('maskList').addEventListener('click',function(e){
    var b=e.target.closest('.agent-act');if(!b)return;
    var a=b.dataset.a,id=b.dataset.id;
    if(a==='e'){
      var m=masks.find(function(x){return x.id===id});if(!m)return;
      $('maskEditTitle').textContent='ç¼–è¾‘';$('maskNameInput').value=m.name;$('maskCallInput').value=m.call;$('maskPromptInput').value=m.prompt;$('maskAgentSelect').value=m.agentId||'';$('maskEditId').value=m.id;
      updateSelects();openModal($('maskEditModal'));
    }else if(a==='d'&&confirm('åˆ é™¤?')){masks=masks.filter(function(x){return x.id!==id});renderMasks();mark();trigAS()}
  });
}

// ===== ä¸–ç•Œä¹¦ç®¡ç† =====
function renderWBooks(){
  var c=$('wbList');c.innerHTML='';
  worldbooks.forEach(function(w){
    var an=w.agentId?'':'å…¨å±€';if(w.agentId){var a=agents.find(function(x){return x.id===w.agentId});an=a?a.name:'?'}
    var el=document.createElement('div');el.className='wb-card';
    el.innerHTML='<div class="wb-hd"><span class="wb-nm">'+w.name+'</span><span class="wb-badge'+(w.agentId?'':' global')+'">'+an+'</span></div><div class="wb-content">'+w.content.slice(0,100)+'</div><div class="wb-acts"><button class="agent-act" data-a="e" data-id="'+w.id+'">âœï¸</button><button class="agent-act" data-a="d" data-id="'+w.id+'">ğŸ—‘ï¸</button></div>';
    c.appendChild(el);
  });
  $('wbCount').textContent=worldbooks.length+'æ¡';
}

function initWBooks(){
  $('setWorldbook').addEventListener('click',function(){openModal($('wbModal'));updateSelects();renderWBooks()});
  $('closeWbBtn').addEventListener('click',function(){closeModal($('wbModal'))});
  $('addWbBtn').addEventListener('click',function(){
    $('wbEditTitle').textContent='æ–°å»º';$('wbNameInput').value='';$('wbContentInput').value='';$('wbAgentSelect').value='';$('wbEditId').value='';
    updateSelects();openModal($('wbEditModal'));
  });
  $('cancelWbEditBtn').addEventListener('click',function(){closeModal($('wbEditModal'))});
  $('saveWbEditBtn').addEventListener('click',function(){
    var n=$('wbNameInput').value.trim(),ct=$('wbContentInput').value.trim(),ai=$('wbAgentSelect').value,eid=$('wbEditId').value;
    if(!n||!ct){toast('è¯·å¡«å†™å®Œæ•´');return}
    if(eid){var w=worldbooks.find(function(x){return x.id===eid});if(w){w.name=n;w.content=ct;w.agentId=ai}}
    else worldbooks.push({id:uid(),name:n,content:ct,agentId:ai});
    closeModal($('wbEditModal'));renderWBooks();mark();trigAS();
  });
  $('wbList').addEventListener('click',function(e){
    var b=e.target.closest('.agent-act');if(!b)return;
    var a=b.dataset.a,id=b.dataset.id;
    if(a==='e'){
      var w=worldbooks.find(function(x){return x.id===id});if(!w)return;
      $('wbEditTitle').textContent='ç¼–è¾‘';$('wbNameInput').value=w.name;$('wbContentInput').value=w.content;$('wbAgentSelect').value=w.agentId||'';$('wbEditId').value=w.id;
      updateSelects();openModal($('wbEditModal'));
    }else if(a==='d'&&confirm('åˆ é™¤?')){worldbooks=worldbooks.filter(function(x){return x.id!==id});renderWBooks();mark();trigAS()}
  });
}

// ===== æ ¸å¿ƒè®°å¿†ç®¡ç† =====
function renderMem(){
  var c=$('memList');c.innerHTML='';
  memories.forEach(function(m){
    var an='?';if(m.agentId){var a=agents.find(function(x){return x.id===m.agentId});an=a?a.name:'?'}
    var el=document.createElement('div');el.className='mem-card';
    el.innerHTML='<div class="mem-hd"><span class="mem-nm">ğŸ§  '+m.title+'</span><span class="wb-badge">'+an+'</span></div><div class="mem-content">'+m.content.slice(0,120)+'</div><div style="display:flex;gap:6px;margin-top:8px;justify-content:flex-end"><button class="agent-act" data-a="e" data-id="'+m.id+'">âœï¸</button><button class="agent-act" data-a="d" data-id="'+m.id+'">ğŸ—‘ï¸</button></div>';
    c.appendChild(el);
  });
  $('memCount').textContent=memories.length+'æ¡';
}

function initMem(){
  $('setMemory').addEventListener('click',function(){openModal($('memModal'));updateSelects();renderMem()});
  $('closeMemBtn').addEventListener('click',function(){closeModal($('memModal'))});
  $('addMemBtn').addEventListener('click',function(){
    $('memEditTitle').textContent='æ–°å»º';$('memAgentSelect').value='';$('memTitleInput').value='';$('memContentInput').value='';$('memEditId').value='';
    updateSelects();openModal($('memEditModal'));
  });
  $('cancelMemEditBtn').addEventListener('click',function(){closeModal($('memEditModal'))});
  $('saveMemEditBtn').addEventListener('click',function(){
    var ai=$('memAgentSelect').value,ti=$('memTitleInput').value.trim(),ct=$('memContentInput').value.trim(),eid=$('memEditId').value;
    if(!ai){toast('è¯·é€‰æ‹©æ™ºèƒ½ä½“');return}if(!ti||!ct){toast('è¯·å¡«å†™å®Œæ•´');return}
    if(eid){var m=memories.find(function(x){return x.id===eid});if(m){m.agentId=ai;m.title=ti;m.content=ct}}
    else memories.push({id:uid(),agentId:ai,title:ti,content:ct});
    closeModal($('memEditModal'));renderMem();mark();trigAS();toast('è®°å¿†å·²ä¿å­˜ğŸ§ ');
  });
  $('memList').addEventListener('click',function(e){
    var b=e.target.closest('.agent-act');if(!b)return;
    var a=b.dataset.a,id=b.dataset.id;
    if(a==='e'){
      var m=memories.find(function(x){return x.id===id});if(!m)return;
      $('memEditTitle').textContent='ç¼–è¾‘';$('memAgentSelect').value=m.agentId;$('memTitleInput').value=m.title;$('memContentInput').value=m.content;$('memEditId').value=m.id;
      updateSelects();openModal($('memEditModal'));
    }else if(a==='d'&&confirm('åˆ é™¤?')){memories=memories.filter(function(x){return x.id!==id});renderMem();mark();trigAS()}
  });
}

// ===== APIè®¾ç½® =====
function initAPI(){
  $('setAPI').addEventListener('click',function(){
    openModal($('apiModal'));
    $('apiUrlInput').value=apiCfg.url;$('apiKeyInput').value=apiCfg.key;$('modelNameInput').value=apiCfg.model;
    updateSelects();if(apiCfg.pubAgent)$('pubAgentSelect').value=apiCfg.pubAgent;
    renderModels();updateApiUI();updateAutoOpts();
  });
  $('closeApiBtn').addEventListener('click',function(){closeModal($('apiModal'))});
  $('fetchModelsBtn').addEventListener('click',fetchModels);
  $('saveApiBtn').addEventListener('click',function(){
    apiCfg.url=$('apiUrlInput').value.trim();apiCfg.key=$('apiKeyInput').value.trim();apiCfg.model=$('modelNameInput').value.trim();apiCfg.pubAgent=$('pubAgentSelect').value;
    saveAll();toast('å·²ä¿å­˜');updateApiUI();startAutoPub();
    $('apiStatusText').textContent=apiCfg.key?'å·²é…ç½®':'æœªé…ç½®';
  });
  $('manualPubBtn').addEventListener('click',function(){
    if(!apiCfg.key||!apiCfg.model){toast('è¯·å…ˆé…ç½®API');return}
    if(!apiCfg.pubAgent){toast('è¯·é€‰æ‹©æ™ºèƒ½ä½“');return}
    doAIPub();
  });
  document.querySelectorAll('#autoIntervalOpts .auto-opt').forEach(function(b){
    b.addEventListener('click',function(){
      document.querySelectorAll('#autoIntervalOpts .auto-opt').forEach(function(x){x.classList.remove('active')});
      this.classList.add('active');
      var iv=this.dataset.iv;
      apiCfg.autoInterval=iv==='login'?'login':(parseInt(iv)||0);
      mark();trigAS();
    });
  });
}

function updateAutoOpts(){
  document.querySelectorAll('#autoIntervalOpts .auto-opt').forEach(function(b){
    b.classList.toggle('active',String(apiCfg.autoInterval)===b.dataset.iv);
  });
}

function updateApiUI(){
  var bar=$('apiStatusBar');
  if(apiCfg.key&&apiCfg.url){bar.className='api-status connected';bar.innerHTML='<div class="api-dot"></div><span>å·²è¿æ¥Â·'+apiCfg.model+'</span>'}
  else{bar.className='api-status disconnected';bar.innerHTML='<div class="api-dot"></div><span>æœªè¿æ¥</span>'}
}

function renderModels(){
  var c=$('modelList');c.innerHTML='';
  modelsList.forEach(function(m){
    var el=document.createElement('div');el.className='model-item'+(apiCfg.model===m?' selected':'');el.textContent=m;
    el.addEventListener('click',function(){
      $('modelNameInput').value=m;
      document.querySelectorAll('.model-item').forEach(function(x){x.classList.remove('selected')});
      this.classList.add('selected');
    });
    c.appendChild(el);
  });
}

function fetchModels(){
  var u=$('apiUrlInput').value.trim(),k=$('apiKeyInput').value.trim();
  if(!u||!k){toast('è¯·å¡«å†™API');return}
  $('fetchModelsBtn').disabled=true;$('fetchModelsBtn').textContent='æ‹‰å–ä¸­...';
  fetch(u.replace(/\/$/,'')+'/models',{headers:{'Authorization':'Bearer '+k}})
  .then(function(r){if(!r.ok)throw new Error(r.status);return r.json()})
  .then(function(d){
    modelsList=[];
    if(d.data&&Array.isArray(d.data))d.data.forEach(function(m){modelsList.push(m.id)});
    modelsList.sort();renderModels();toast('è·å–'+modelsList.length+'ä¸ªæ¨¡å‹');
  })
  .catch(function(e){toast('å¤±è´¥:'+e.message)})
  .finally(function(){$('fetchModelsBtn').disabled=false;$('fetchModelsBtn').textContent='æ‹‰å–æ¨¡å‹'});
}

// ===== AIè°ƒç”¨ =====
function callAPI(msgs,cb){
  fetch(apiCfg.url.replace(/\/$/,'')+'/chat/completions',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiCfg.key},
    body:JSON.stringify({model:apiCfg.model,messages:msgs,temperature:0.8,max_tokens:600})
  })
  .then(function(r){if(!r.ok)throw new Error('HTTP'+r.status);return r.json()})
  .then(function(d){var ct=(d.choices&&d.choices[0]&&d.choices[0].message)?d.choices[0].message.content:'';cb(ct)})
  .catch(function(e){toast('APIé”™è¯¯:'+e.message);cb('')});
}

function parseChatLines(ct){
  var lines=ct.split('\n').filter(function(l){
    var t=l.trim();if(!t)return false;
    if(t.charAt(0)==='*'||t.charAt(0)==='(')return false;
    if(t.indexOf('*')>-1&&t.lastIndexOf('*')>t.indexOf('*'))return false;
    return true;
  });
  if(!lines.length)lines=[ct.replace(/\*[^*]*\*/g,'').trim()];
  var result=[];
  lines.forEach(function(line){
    line=line.replace(/^[""\s]+|[""\s]+$/g,'').replace(/\*[^*]*\*/g,'').trim();
    if(line)result.push(line);
  });
  return result.length?result:['...'];
}

// ===== AIä¸Šä¸‹æ–‡æ„å»º =====
function collectCtx(agentId){
  var agent=agents.find(function(a){return a.id===agentId});if(!agent)return null;
  var mask=masks.find(function(m){return m.agentId===agentId});
  var wbs=worldbooks.filter(function(w){return!w.agentId||w.agentId===agentId});
  var mems=memories.filter(function(m){return m.agentId===agentId});

  var ctx='ä½ æ˜¯ã€Œ'+agent.name+'ã€ã€‚\n';
  if(agent.call)ctx+='ä½ ç§°å‘¼ç”¨æˆ·ä¸ºã€Œ'+agent.call+'ã€ã€‚\n';
  if(agent.prompt)ctx+=agent.prompt+'\n\n';

  if(mask){
    ctx+='ç”¨æˆ·:ã€Œ'+mask.name+'ã€';
    if(mask.call)ctx+='ï¼Œç§°å‘¼ä½ ä¸ºã€Œ'+mask.call+'ã€';
    ctx+='ã€‚\n';
    if(mask.prompt)ctx+=mask.prompt+'\n\n';
  }

  if(mems.length){
    ctx+='===æ ¸å¿ƒè®°å¿†(æœ€é«˜ä¼˜å…ˆçº§)===\n';
    mems.forEach(function(m){ctx+='['+m.title+']: '+m.content+'\n'});
    ctx+='\n';
  }

  if(wbs.length){
    ctx+='===ä¸–ç•Œè®¾å®š===\n';
    wbs.forEach(function(w){ctx+=w.name+': '+w.content+'\n'});
    ctx+='\n';
  }

  ctx+='===ç©ºé—´å†…å®¹===\næ—¥æœŸ:'+getToday()+'\n';

  var tl=localStorage.getItem('loveStoryTimeline');
  if(tl&&tl!=='null'){
    try{JSON.parse(tl).forEach(function(t){if(isWithinRange(t.date,ctxRange))ctx+='æ—¶é—´çº¿ '+t.date+' '+t.title+':'+t.desc+'\n'})}catch(e){}
  }

  var nb=localStorage.getItem('loveStoryNotebook');
  if(nb&&nb!=='null'){
    try{JSON.parse(nb).forEach(function(n){if(isWithinRange(n.date,ctxRange))ctx+='ç¬”è®° '+n.date+' '+n.title+':'+(n.content||'').replace(/<[^>]*>/g,'').slice(0,80)+'\n'})}catch(e){}
  }

  if(wishList.length){
    ctx+='è®¸æ„¿ç“¶:\n';
    wishList.forEach(function(w){ctx+='- '+w.text+'('+w.openDate+')\n'});
  }

  var am=[];moodData.pages.forEach(function(p){if(p)am=am.concat(p)});
  if(ctxRange>0)am=am.filter(function(m){return isWithinRange(m.date,ctxRange)});
  if(am.length){ctx+='å¿ƒæƒ…:';am.slice(-5).forEach(function(m){ctx+=m.date+'='+m.mood+' '});ctx+='\n'}

  var st=[];document.querySelectorAll('.sticky-note .s-text').forEach(function(s){st.push(s.textContent)});
  if(st.length)ctx+='ä¾¿ç­¾:'+st.join('/').slice(0,200)+'\n';

  if(checklistData.length){
    ctx+='æ¸…å•:\n';
    checklistData.forEach(function(c){ctx+='- '+(c.done?'âœ“':'â—‹')+' '+c.text.replace(/<[^>]*>/g,'')+'\n'});
  }

  return{agent:agent,context:ctx};
}

// ===== AIè‡ªåŠ¨å‘å¸ƒ =====
function doAIPub(){
  var info=collectCtx(apiCfg.pubAgent);
  if(!info){toast('æœªæ‰¾åˆ°æ™ºèƒ½ä½“');return}
  toast('AIæ€è€ƒä¸­...');

  var prompt=info.context+'\n===ä»»åŠ¡===\nä»¥ã€Œ'+info.agent.name+'ã€èº«ä»½å‘å¸ƒå†…å®¹ã€‚éšæœºé€‰:1.note(title,content) 2.sticky(text) 3.wish(text,openDate) 4.mood(mood 1-5)\nåªå›å¤JSON:{"type":"...","data":{...}}';

  callAPI([{role:'system',content:prompt}],function(ct){
    if(!ct)return;
    var jm=ct.match(/\{[\s\S]*\}/);
    if(!jm){toast('è§£æå¤±è´¥');return}
    try{var r=JSON.parse(jm[0]);applyAI(r,info.agent.name)}catch(e){toast('JSONé”™è¯¯')}
  });
}

function applyAI(r,name){
  if(!r.type||!r.data){toast('æ ¼å¼é”™è¯¯');return}
  switch(r.type){
    case'note':
      var ns=localStorage.getItem('loveStoryNotebook');
      var nd=(ns&&ns!=='null')?JSON.parse(ns):[];
      nd.unshift({id:'nb_'+uid(),date:todayDot(),title:r.data.title||'',content:r.data.content||'',author:name});
      localStorage.setItem('loveStoryNotebook',JSON.stringify(nd));
      toast(name+' å‘å¸ƒç¬”è®°ğŸ“–');
      break;
    case'sticky':
      var sc=$('stickyBox'),ab=$('addStickyBtn'),cl=stickyColors[stickyCount%4];stickyCount++;
      var s=document.createElement('div');s.className='sticky-note '+cl;
      s.innerHTML='<button class="del-s">Ã—</button><div class="s-text ed" contenteditable="true" data-key="sticky_'+uid()+'">'+r.data.text+'</div><div class="s-author">â€” '+name+'</div>';
      sc.insertBefore(s,ab);bindE(s);
      toast(name+' è´´äº†ä¾¿ç­¾ğŸ“');
      break;
    case'wish':
      wishList.push({text:r.data.text||'',openDate:r.data.openDate||getToday(),createDate:getToday(),author:name});
      toast(name+' è®¸äº†æ„¿æœ›ğŸ¾');
      break;
    case'mood':
      var mv=Math.min(5,Math.max(1,parseInt(r.data.mood)||3));
      for(var i=0;i<3;i++){
        if(!moodData.pages[i])moodData.pages[i]=[];
        if(moodData.pages[i].length<30){moodData.pages[i].push({date:getToday(),mood:mv,author:name});break}
      }
      toast(name+' è®°å½•å¿ƒæƒ…'+['','ğŸ˜¢','ğŸ˜”','ğŸ˜','ğŸ˜Š','ğŸ˜„'][mv]);
      break;
    default:toast('æœªçŸ¥ç±»å‹');return;
  }
  mark();trigAS();
}

function startAutoPub(){
  if(autoPubTimer){clearInterval(autoPubTimer);autoPubTimer=null}
  if(!apiCfg.key||!apiCfg.model||!apiCfg.pubAgent)return;
  var iv=apiCfg.autoInterval;
  if(typeof iv==='number'&&iv>0)autoPubTimer=setInterval(doAIPub,iv);
}

function trigLogin(){
  if(!apiCfg.key||!apiCfg.model||!apiCfg.pubAgent)return;
  if(apiCfg.autoInterval==='login')setTimeout(doAIPub,3000);
  startAutoPub();
  trigPagerLogin();
}

// ===== ä¼ å‘¼æœº =====
function initPager(){
  $('pagerBtn').addEventListener('click',function(){openModal($('pagerModal'));renderPager()});
  $('closePagerBtn').addEventListener('click',function(){closeModal($('pagerModal'))});

  $('pagerBgBtn').addEventListener('click',function(){$('pagerBgInput').click()});
  $('pagerBgInput').addEventListener('change',function(){
    hFile(this,600,0.7,function(u){pagerBg=u;$('pagerScreen').style.backgroundImage='url('+u+')';mark();trigAS()});
  });

  $('pagerClearBtn').addEventListener('click',function(){
    if(confirm('æ¸…ç©ºæ‰€æœ‰å¯¹è¯?')){pagerChat=[];renderPager();mark();trigAS()}
  });

  $('pagerSendBtn').addEventListener('click',sendPagerMsg);
  $('pagerInput').addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendPagerMsg()}});
  $('pagerInput').addEventListener('input',function(){this.style.height='38px';this.style.height=Math.min(this.scrollHeight,80)+'px'});

  $('pagerRecvBtn').addEventListener('click',recvPagerMsg);

  if(apiCfg.pubAgent){var ag=agents.find(function(a){return a.id===apiCfg.pubAgent});if(ag)$('pagerCharName').textContent=ag.name}
}

function renderPager(){
  var c=$('pagerMsgs');c.innerHTML='';
  if(pagerBg)$('pagerScreen').style.backgroundImage='url('+pagerBg+')';
  if(!pagerChat.length){c.innerHTML='<div style="color:rgba(0,255,0,.3);text-align:center;padding:40px;font-size:12px">å‘é€ä¸€æ¡æ¶ˆæ¯å¼€å§‹å¯¹è¯</div>';return}
  pagerChat.forEach(function(m){
    var el=document.createElement('div');el.className='pager-msg '+m.role;
    el.innerHTML=m.text+'<span class="msg-time">'+m.time+'</span>';
    c.appendChild(el);
  });
  requestAnimationFrame(function(){$('pagerScreen').scrollTop=$('pagerScreen').scrollHeight});
  if(apiCfg.pubAgent){var ag=agents.find(function(a){return a.id===apiCfg.pubAgent});if(ag)$('pagerCharName').textContent=ag.name}

  var last=pagerChat[pagerChat.length-1];
  if(last&&last.role==='user'){$('pagerRecvBtn').disabled=false;$('pagerRecvBtn').classList.add('has-reply')}
  else{$('pagerRecvBtn').disabled=true;$('pagerRecvBtn').classList.remove('has-reply')}
}

function sendPagerMsg(){
  var text=$('pagerInput').value.trim();if(!text)return;
  if(!apiCfg.key||!apiCfg.model||!apiCfg.pubAgent){toast('è¯·å…ˆé…ç½®APIå’Œæ™ºèƒ½ä½“');return}
  pagerChat.push({role:'user',text:text,time:getNow(),date:getToday()});
  $('pagerInput').value='';$('pagerInput').style.height='38px';
  renderPager();mark();trigAS();
}

function recvPagerMsg(){
  if(!apiCfg.key||!apiCfg.model){toast('è¯·å…ˆé…ç½®API');return}
  if(!apiCfg.pubAgent){toast('è¯·é€‰æ‹©æ™ºèƒ½ä½“');return}
  $('pagerRecvBtn').disabled=true;$('pagerRecvBtn').classList.remove('has-reply');

  var msgs=buildPagerMessages();
  var typing=document.createElement('div');typing.className='pager-typing';typing.textContent='å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
  $('pagerMsgs').appendChild(typing);$('pagerScreen').scrollTop=$('pagerScreen').scrollHeight;

  callAPI(msgs,function(ct){
    if(typing.parentNode)typing.parentNode.removeChild(typing);
    if(!ct){toast('å›å¤ä¸ºç©º');return}
    var lines=parseChatLines(ct);
    lines.forEach(function(line){pagerChat.push({role:'char',text:line,time:getNow(),date:getToday()})});
    renderPager();mark();trigAS();
  });
}

function buildPagerMessages(){
  var agent=agents.find(function(a){return a.id===apiCfg.pubAgent});if(!agent)return[];
  var mask=masks.find(function(m){return m.agentId===agent.id});
  var wbs=worldbooks.filter(function(w){return!w.agentId||w.agentId===agent.id});
  var mems=memories.filter(function(m){return m.agentId===agent.id});

  var sys='ä½ æ˜¯ã€Œ'+agent.name+'ã€ï¼Œæ­£åœ¨é€šè¿‡ä¼ å‘¼æœºå’Œç”¨æˆ·å¯¹è¯ã€‚\n';
  if(agent.call)sys+='ä½ ç§°å‘¼ç”¨æˆ·ä¸ºã€Œ'+agent.call+'ã€ã€‚\n';
  if(agent.prompt)sys+=agent.prompt+'\n';
  if(mask){sys+='ç”¨æˆ·æ˜¯ã€Œ'+mask.name+'ã€';if(mask.call)sys+='ï¼Œç§°å‘¼ä½ ä¸ºã€Œ'+mask.call+'ã€';sys+='ã€‚\n';if(mask.prompt)sys+=mask.prompt+'\n'}
  if(mems.length){sys+='===æ ¸å¿ƒè®°å¿†===\n';mems.forEach(function(m){sys+='['+m.title+']:'+m.content+'\n'})}
  if(wbs.length){sys+='===ä¸–ç•Œè®¾å®š===\n';wbs.forEach(function(w){sys+=w.name+':'+w.content+'\n'})}
  sys+='\n===ä¸¥æ ¼è§„åˆ™===\n1.åªè¾“å‡ºçº¯å¯¹è¯æ–‡å­—ï¼Œç»å¯¹ç¦æ­¢*å·åŠ¨ä½œæå†™ã€()æ‹¬å·æå†™ã€æ—ç™½ã€å¿ƒç†æå†™\n2.å¯ä»¥å›å¤å¤šå¥ï¼Œæ¯å¥ä¸€è¡Œ\n3.ä¿æŒè§’è‰²æ€§æ ¼è¯­æ°”\n4.ç®€æ´è‡ªç„¶ï¼Œåƒæ‰‹æœºèŠå¤©\n5.ä¸è¦åŠ å¼•å·åŒ…è£¹å¯¹è¯';

  var msgs=[{role:'system',content:sys}];

  var chatPool=pagerChat;
  if(ctxRange>0){
    var cutDate=new Date();cutDate.setDate(cutDate.getDate()-ctxRange);
    chatPool=pagerChat.filter(function(m){if(!m.date)return true;return new Date(m.date)>=cutDate});
  }
  var recent=chatPool.slice(-pagerMemCount);
  recent.forEach(function(m){msgs.push({role:m.role==='user'?'user':'assistant',content:m.text})});

  return msgs;
}

function trigPagerLogin(){
  if(!apiCfg.key||!apiCfg.model||!apiCfg.pubAgent)return;
  if(sessionStorage.getItem('pagerAutoSent'))return;
  if(pagerChat.length>0){
    var last=pagerChat[pagerChat.length-1];
    if(last.role==='user'){
      sessionStorage.setItem('pagerAutoSent','1');
      setTimeout(function(){
        var msgs=buildPagerMessages();
        callAPI(msgs,function(ct){
          if(!ct)return;
          var lines=parseChatLines(ct);
          lines.forEach(function(line){pagerChat.push({role:'char',text:line,time:getNow(),date:getToday()})});
          mark();trigAS();
        });
      },4000);
    }
  }
}

// ===== ä½¿ç”¨æ‰‹å†Œ =====
function initManual(){
  $('manualBtn').addEventListener('click',function(){openModal($('manualModal'));renderManual()});
  $('closeManualBtn').addEventListener('click',function(){closeModal($('manualModal'))});
}

function renderManual(){
  $('manualContent').innerHTML=
  '<h4>ğŸ“Œ å…³äºæœ¬ç«™</h4><p>ã€Œæˆ‘ä»¬çš„æ•…äº‹ã€æ˜¯ä¸€ä¸ªçº¯å‰ç«¯çš„æƒ…ä¾£è®°å½•ç½‘ç«™ï¼Œæ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°(localStorage)ä¸­ã€‚ç”± <b>å¿ƒç”°</b> è®¾è®¡å¼€å‘ã€‚</p>'+
  '<h4>ğŸ  ä¸»é¡µåŠŸèƒ½</h4><ul><li><b>æ ‡é¢˜å’Œå¼•è¨€</b>ï¼šç‚¹å‡»æ–‡å­—å³å¯ç¼–è¾‘ï¼Œè‡ªåŠ¨ä¿å­˜ã€‚</li><li><b>éŸ³ä¹æ’­æ”¾å™¨</b>ï¼šæ”¯æŒæ·»åŠ æœ€å¤š5é¦–MP3ï¼Œç‚¹å‡»å”±ç‰‡ä¸­å¿ƒå¯æ›´æ¢å°é¢ã€‚</li><li><b>ç…§ç‰‡å¡</b>ï¼šç‚¹å‡»å›¾ç‰‡åŒºåŸŸä¸Šä¼ åˆç…§ã€‚</li><li><b>çˆ±æƒ…è®¡æ—¶å™¨</b>ï¼šé€‰æ‹©æ—¥æœŸåè‡ªåŠ¨è®¡ç®—å¤©æ•°ã€‚</li></ul>'+
  '<h4>ğŸ“… æ›´å¤šå†…å®¹</h4><ul><li><b>æ—¶é—´çº¿</b>ï¼šè®°å½•é‡è¦æ—¶åˆ»èŠ‚ç‚¹ï¼Œæ”¯æŒå¢åˆ æ”¹ã€‚</li><li><b>ç¬”è®°æœ¬</b>ï¼šå†™æ—¥è®°ï¼Œæ”¯æŒå­—æ•°ç»Ÿè®¡ã€‚</li><li><b>è®¸æ„¿ç“¶</b>ï¼šå†™ä¸‹æ„¿æœ›å¹¶è®¾å®šå¼€å¯æ—¥æœŸï¼Œåˆ°æœŸåæ‰èƒ½æŸ¥çœ‹ã€‚</li><li><b>å¿ƒæƒ…æ›²çº¿</b>ï¼šæ¯å¤©è®°å½•ä¸€æ¬¡å¿ƒæƒ…(1-5åˆ†)ï¼Œå¯è§†åŒ–å±•ç¤ºã€‚</li><li><b>æƒ…ä¾£æ¸…å•</b>ï¼šåˆ›å»ºæƒ³ä¸€èµ·åšçš„äº‹ï¼Œå®Œæˆåæ‰“å‹¾ã€‚</li><li><b>è¯­éŸ³ä¿¡ç®±</b>ï¼šå½•åˆ¶è¯­éŸ³ç•™è¨€ï¼Œæµè§ˆå™¨éœ€æˆæƒéº¦å…‹é£ã€‚</li></ul>'+
  '<h4>ğŸ“ ä¾¿ç­¾å¢™</h4><p>ç‚¹å‡»æ·»åŠ ä¾¿ç­¾ï¼Œç›´æ¥ç¼–è¾‘å†…å®¹ã€‚AIæ™ºèƒ½ä½“ä¹Ÿå¯ä»¥åœ¨ä¾¿ç­¾å¢™ç•™è¨€ã€‚</p>'+
  '<h4>ğŸ“Ÿ ä¼ å‘¼æœº</h4><ul><li>åº•éƒ¨æ ç‚¹å‡»ã€Œä¼ å‘¼æœºã€æ‰“å¼€ã€‚</li><li>è¾“å…¥æ¶ˆæ¯å¹¶å‘é€ï¼Œç„¶åç‚¹å‡»ğŸ“¥æ¥æ”¶æŒ‰é’®è·å–AIå›å¤ã€‚</li><li>AIåªå›å¤å¯¹è¯å†…å®¹ï¼Œä¸åŒ…å«åŠ¨ä½œæå†™ã€‚</li><li>æ¯æ¬¡ä¸Šçº¿æ—¶ï¼Œå¦‚æœæœ‰æœªå›å¤çš„æ¶ˆæ¯ï¼ŒAIä¼šè‡ªåŠ¨å›å¤ä¸€æ¬¡ã€‚</li><li>å¯åœ¨è®¾ç½®ä¸­è°ƒæ•´å¯¹è¯è®°å¿†æ¡æ•°(é»˜è®¤20æ¡)ã€‚</li><li>ç‚¹å‡»ã€ŒèƒŒæ™¯ã€å¯ä¸Šä¼ è‡ªå®šä¹‰èŠå¤©èƒŒæ™¯ã€‚</li></ul>'+
  '<h4>ğŸ¤– AIç³»ç»Ÿ</h4><ul><li><b>æ™ºèƒ½ä½“</b>ï¼šåˆ›å»ºAIè§’è‰²ï¼Œè®¾å®šåç§°ã€ç§°å‘¼ã€æ€§æ ¼ã€‚</li><li><b>é¢å…·</b>ï¼šåˆ›å»ºç”¨æˆ·èº«ä»½ï¼Œå¯å…³è”æ™ºèƒ½ä½“ã€‚</li><li><b>ä¸–ç•Œä¹¦</b>ï¼šæ·»åŠ ä¸–ç•Œè§‚è®¾å®šï¼Œå¯ç»‘å®šç‰¹å®šæ™ºèƒ½ä½“æˆ–å…¨å±€é€šç”¨ã€‚</li><li><b>æ ¸å¿ƒè®°å¿†</b>ï¼šä¸ºæ™ºèƒ½ä½“è®¾ç½®æ°¸ä¹…è®°å¿†ï¼Œæ¯æ¬¡å¯¹è¯æœ€é«˜ä¼˜å…ˆçº§ã€‚</li><li><b>APIè®¾ç½®</b>ï¼šå¡«å†™APIåœ°å€å’Œå¯†é’¥ï¼Œæ‹‰å–æˆ–æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åã€‚</li><li><b>è‡ªåŠ¨å‘å¸ƒ</b>ï¼šAIå¯æŒ‰è®¾å®šé¢‘ç‡è‡ªåŠ¨åœ¨ç¬”è®°/ä¾¿ç­¾/è®¸æ„¿ç“¶/å¿ƒæƒ…ä¸­å‘å¸ƒå†…å®¹ã€‚</li></ul>'+
  '<h4>âš™ï¸ è®¾ç½®è¯´æ˜</h4><ul><li><b>å¤œé—´æ¨¡å¼</b>ï¼šä¸€é”®åˆ‡æ¢æ·±è‰²ä¸»é¢˜ã€‚</li><li><b>è‡ªå®šä¹‰å­—ä½“</b>ï¼šç²˜è´´TTFå­—ä½“ç›´é“¾å³å¯å…¨å±€æ›¿æ¢ã€‚</li><li><b>é”å±å¯†ç </b>ï¼šè®¾ç½®åæ¯æ¬¡æ‰“å¼€éœ€è¾“å…¥å¯†ç ã€‚æœªè®¾å¯†ç åˆ™ç›´æ¥ä¸Šæ»‘è¿›å…¥ã€‚</li><li><b>çŸ­æœŸè®°å¿†èŒƒå›´</b>ï¼šæ§åˆ¶å‘é€ç»™AIçš„ä¸Šä¸‹æ–‡æ—¶é—´(å…¨éƒ¨/ä¸€å‘¨/ä¸€æœˆ/ä¸‰æœˆ)ã€‚</li><li><b>ä¼ å‘¼æœºè®°å¿†</b>ï¼šæ§åˆ¶ä¼ å‘¼æœºå‘é€ç»™AIçš„æœ€è¿‘å¯¹è¯æ¡æ•°ã€‚</li><li><b>æ—§æ•°æ®æ¸…ç†</b>ï¼šè‡ªåŠ¨æ¸…ç†æŒ‡å®šæ—¶é—´å‰çš„ç¬”è®°ã€å¿ƒæƒ…è®°å½•ã€‚</li><li><b>å¯¼å‡º/å¯¼å…¥</b>ï¼šå¤‡ä»½å’Œæ¢å¤æ‰€æœ‰æ•°æ®ã€‚</li></ul>'+
  '<h4>âš ï¸ é‡è¦æç¤º</h4><div class="hl"><p>â€¢ æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œæ¸…é™¤æµè§ˆå™¨æ•°æ®ä¼šä¸¢å¤±æ‰€æœ‰å†…å®¹ã€‚</p><p>â€¢ è¯·å®šæœŸä½¿ç”¨ã€Œå¯¼å‡ºæ•°æ®ã€åŠŸèƒ½å¤‡ä»½ã€‚</p><p>â€¢ æ›´æ¢è®¾å¤‡æ—¶éœ€è¦å¯¼å‡ºå†å¯¼å…¥ã€‚</p><p>â€¢ APIå¯†é’¥è¯·å¦¥å–„ä¿ç®¡ï¼Œä¸è¦æ³„éœ²ç»™ä»–äººã€‚</p></div>'+
  '<h4>ğŸ’ ç‰ˆæƒå£°æ˜</h4><p>æœ¬ç«™ç”± <b>å¿ƒç”°</b> åŸåˆ›è®¾è®¡å¼€å‘ã€‚</p><p style="text-align:center;margin-top:20px;opacity:.5;font-size:12px">â€” by å¿ƒç”° â€”</p>';
}

// ===== è®¾ç½® =====
function initSettings(){
  $('settingsBtn').addEventListener('click',function(){openModal($('settingsModal'));uSetUI()});
  $('closeSettingsBtn').addEventListener('click',function(){closeModal($('settingsModal'))});

  function uSetUI(){
    $('nightToggle').classList.toggle('on',document.body.getAttribute('data-night')==='true');
    $('fontStatus').textContent=localStorage.getItem('customFontUrl')?'å·²è®¾ç½®':'é»˜è®¤';
    $('passwordStatus').textContent=localStorage.getItem('lockPassword')?'å·²è®¾ç½®':'æœªè®¾ç½®';
    $('agentCount').textContent=agents.length+'ä¸ª';
    $('maskCount').textContent=masks.length+'ä¸ª';
    $('wbCount').textContent=worldbooks.length+'æ¡';
    $('memCount').textContent=memories.length+'æ¡';
    $('apiStatusText').textContent=apiCfg.key?'å·²é…ç½®':'æœªé…ç½®';
    $('ctxRangeText').textContent={0:'å…¨éƒ¨',7:'è¿‘ä¸€å‘¨',30:'è¿‘ä¸€æœˆ',90:'è¿‘ä¸‰æœˆ'}[ctxRange]||'å…¨éƒ¨';
    $('pagerMemText').textContent=pagerMemCount+'æ¡';
    $('autoCleanText').textContent={0:'å…³é—­',30:'1ä¸ªæœˆå‰',90:'3ä¸ªæœˆå‰',180:'åŠå¹´å‰',365:'ä¸€å¹´å‰'}[autoCleanDays]||'å…³é—­';
  }

  $('setNightMode').addEventListener('click',function(){
    var n=document.body.getAttribute('data-night')!=='true';
    document.body.setAttribute('data-night',String(n));localStorage.setItem('nightMode',String(n));
    $('nightToggle').classList.toggle('on',n);
  });

  $('setFont').addEventListener('click',function(){$('fontUrlInput').value=localStorage.getItem('customFontUrl')||'';openModal($('fontModal'))});
  $('cancelFontBtn').addEventListener('click',function(){closeModal($('fontModal'))});
  $('saveFontBtn').addEventListener('click',function(){
    var u=$('fontUrlInput').value.trim();
    if(u){applyFont(u);localStorage.setItem('customFontUrl',u)}else{removeFont();localStorage.removeItem('customFontUrl')}
    closeModal($('fontModal'));uSetUI();
  });

  $('setPassword').addEventListener('click',function(){$('newPwdInput').value='';$('confirmPwdInput').value='';openModal($('passwordModal'))});
  $('cancelPwdBtn').addEventListener('click',function(){closeModal($('passwordModal'))});
  $('savePwdBtn').addEventListener('click',function(){
    var p1=$('newPwdInput').value,p2=$('confirmPwdInput').value;
    if(!p1&&!p2){localStorage.removeItem('lockPassword');toast('å¯†ç å·²æ¸…é™¤');closeModal($('passwordModal'));uSetUI();return}
    if(p1!==p2){toast('ä¸ä¸€è‡´');return}
    localStorage.setItem('lockPassword',p1);toast('å·²è®¾ç½®ğŸ”');closeModal($('passwordModal'));uSetUI();
  });

  $('setCtxRange').addEventListener('click',function(){
    document.querySelectorAll('#ctxRangeOpts .auto-opt').forEach(function(b){b.classList.toggle('active',+b.dataset.rg===ctxRange)});
    openModal($('ctxRangeModal'));
  });
  document.querySelectorAll('#ctxRangeOpts .auto-opt').forEach(function(b){
    b.addEventListener('click',function(){
      document.querySelectorAll('#ctxRangeOpts .auto-opt').forEach(function(x){x.classList.remove('active')});
      this.classList.add('active');
    });
  });
  $('saveCtxRangeBtn').addEventListener('click',function(){
    var sel=document.querySelector('#ctxRangeOpts .auto-opt.active');
    ctxRange=sel?+sel.dataset.rg:0;
    closeModal($('ctxRangeModal'));mark();trigAS();toast('å·²ä¿å­˜');
  });

  $('setPagerMem').addEventListener('click',function(){$('pagerMemInput').value=pagerMemCount;openModal($('pagerMemModal'))});
  $('savePagerMemBtn').addEventListener('click',function(){
    var v=parseInt($('pagerMemInput').value)||20;
    pagerMemCount=Math.max(5,Math.min(100,v));
    closeModal($('pagerMemModal'));mark();trigAS();toast('å·²ä¿å­˜');
  });

  $('setAutoClean').addEventListener('click',function(){
    document.querySelectorAll('#autoCleanOpts .auto-opt').forEach(function(b){b.classList.toggle('active',+b.dataset.cl===autoCleanDays)});
    openModal($('autoCleanModal'));
  });
  document.querySelectorAll('#autoCleanOpts .auto-opt').forEach(function(b){
    b.addEventListener('click',function(){
      document.querySelectorAll('#autoCleanOpts .auto-opt').forEach(function(x){x.classList.remove('active')});
      this.classList.add('active');
    });
  });
  $('cancelCleanBtn').addEventListener('click',function(){closeModal($('autoCleanModal'))});
  $('saveCleanBtn').addEventListener('click',function(){
    var sel=document.querySelector('#autoCleanOpts .auto-opt.active');
    autoCleanDays=sel?+sel.dataset.cl:0;
    closeModal($('autoCleanModal'));mark();trigAS();toast('å·²ä¿å­˜');
    if(autoCleanDays>0)doAutoClean();
  });

  $('setExport').addEventListener('click',exportData);
  $('setImport').addEventListener('click',function(){$('importInput').click()});
  $('importInput').addEventListener('change',function(){importData(this)});

  $('setClear').addEventListener('click',function(){
    if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®?ä¸å¯æ¢å¤!'))return;
    if(!confirm('å†æ¬¡ç¡®è®¤'))return;
    localStorage.clear();sessionStorage.clear();
    toast('å·²æ¸…ç©º');setTimeout(function(){location.reload()},1500);
  });

  // æ‰€æœ‰overlayå¼¹çª—ç‚¹å‡»èƒŒæ™¯å…³é—­
  document.querySelectorAll('.ovm').forEach(function(m){
    m.addEventListener('click',function(e){if(e.target===this)closeModal(this)});
  });
}

// ===== è‡ªåŠ¨æ¸…ç† =====
function doAutoClean(){
  if(autoCleanDays<=0)return;
  var cleaned=false;

  // æ¸…ç†ç¬”è®°
  var nb=localStorage.getItem('loveStoryNotebook');
  if(nb&&nb!=='null'){
    try{
      var arr=JSON.parse(nb);
      var filtered=arr.filter(function(n){return isWithinRange(n.date,autoCleanDays)});
      if(filtered.length<arr.length){localStorage.setItem('loveStoryNotebook',JSON.stringify(filtered));cleaned=true}
    }catch(e){}
  }

  // æ¸…ç†å¿ƒæƒ…
  moodData.pages.forEach(function(pg,i){
    if(!pg)return;
    var before=pg.length;
    moodData.pages[i]=pg.filter(function(m){return isWithinRange(m.date,autoCleanDays)});
    if(moodData.pages[i].length<before)cleaned=true;
  });

  // æ¸…ç†ä¼ å‘¼æœºæ—§æ¶ˆæ¯
  if(pagerChat.length>pagerMemCount*3){pagerChat=pagerChat.slice(-pagerMemCount*2);cleaned=true}

  // æ¸…ç†å·²è¿‡æœŸä¸”æ‰“å¼€è¶…è¿‡æ¸…ç†æœŸé™çš„è®¸æ„¿ç“¶
  var wBefore=wishList.length;
  wishList=wishList.filter(function(w){
    var opened=new Date()>=new Date(w.openDate+'T23:59:59');
    if(!opened)return true;
    return isWithinRange(w.createDate,autoCleanDays);
  });
  if(wishList.length<wBefore)cleaned=true;

  if(cleaned){mark();trigAS()}
}

// ===== ä¿å­˜/åŠ è½½ =====
function saveAll(){
  try{
    var d={version:'6.0',savedAt:new Date().toISOString(),theme:document.body.getAttribute('data-theme')||'green'};

    d.mainContent={};
    document.querySelectorAll('.container [data-key]').forEach(function(el){
      var k=el.getAttribute('data-key');
      if(k&&el.tagName!=='IMG')d.mainContent[k]=el.innerHTML;
    });

    var mi=$('mainImg');if(mi&&mi.src&&mi.src.indexOf('data:')===0)d.mainImg=mi.src;
    var di=$('discImg');if(di&&di.src&&di.src.indexOf('data:')===0)d.discImg=di.src;

    [['bodyBg',document.body],['headerBg',$('headerBox')],['albumBg',$('albumBox')]].forEach(function(p){
      var bg=p[1]?p[1].style.backgroundImage:'';
      if(bg&&bg.indexOf('data:')>-1)d[p[0]]=bg;
    });

    d.albumImages={};
    document.querySelectorAll('#albumPages img[data-key]').forEach(function(img){
      var k=img.getAttribute('data-key');
      if(k&&img.src&&img.src.indexOf('data:')===0)d.albumImages[k]=img.src;
    });

    d.stickies=[];
    document.querySelectorAll('.sticky-note').forEach(function(s){
      var t=s.querySelector('.s-text'),a=s.querySelector('.s-author');
      if(t)d.stickies.push({color:s.className.replace('sticky-note','').trim(),text:t.innerHTML,key:t.getAttribute('data-key'),author:a?a.textContent:''});
    });

    d.timeline=[];
    document.querySelectorAll('#timelineBox .tl-item').forEach(function(it){
      d.timeline.push({id:it.getAttribute('data-id'),date:it.querySelector('[data-field="date"]').innerHTML,title:it.querySelector('[data-field="title"]').innerHTML,desc:it.querySelector('[data-field="desc"]').innerHTML});
    });

    d.notebook=[];
    document.querySelectorAll('#notebookBox .nb-entry').forEach(function(en){
      d.notebook.push({id:en.getAttribute('data-id'),date:en.querySelector('[data-field="date"]').innerHTML,title:en.querySelector('[data-field="title"]').innerHTML,content:en.querySelector('[data-field="content"]').innerHTML,author:en.dataset.author||''});
    });

    d.musicList=musicList;d.curMusic=curMusic;d.wishList=wishList;d.moodData=moodData;
    d.checklistData=checklistData;d.voiceList=voiceList;
    d.agents=agents;d.masks=masks;d.worldbooks=worldbooks;d.memories=memories;d.apiCfg=apiCfg;
    d.pagerChat=pagerChat;d.pagerBg=pagerBg;d.pagerMemCount=pagerMemCount;
    d.ctxRange=ctxRange;d.autoCleanDays=autoCleanDays;

    var sd=localStorage.getItem('loveStartDate');if(sd)d.startDate=sd;

    localStorage.setItem('loveStoryData',JSON.stringify(d));
    if(d.timeline.length)localStorage.setItem('loveStoryTimeline',JSON.stringify(d.timeline));
    if(d.notebook.length)localStorage.setItem('loveStoryNotebook',JSON.stringify(d.notebook));
    return true;
  }catch(e){console.error('ä¿å­˜å¤±è´¥:',e);return false}
}

function loadAll(){
  try{
    var s=localStorage.getItem('loveStoryData');if(!s)return;
    var d=JSON.parse(s);

    if(d.theme){document.body.setAttribute('data-theme',d.theme);themeIdx=themes.indexOf(d.theme);if(themeIdx<0)themeIdx=0}

    if(d.mainContent)Object.keys(d.mainContent).forEach(function(k){
      var el=document.querySelector('.container [data-key="'+k+'"]');
      if(el&&el.tagName!=='IMG')el.innerHTML=d.mainContent[k];
    });

    if(d.mainImg)$('mainImg').src=d.mainImg;
    if(d.discImg){$('discImg').src=d.discImg;$('discImg').style.display='block';$('discPh').style.display='none'}
    if(d.bodyBg)document.body.style.backgroundImage=d.bodyBg;
    if(d.headerBg)$('headerBox').style.backgroundImage=d.headerBg;
    if(d.albumBg&&$('albumBox'))$('albumBox').style.backgroundImage=d.albumBg;

    if(d.albumImages)Object.keys(d.albumImages).forEach(function(k){var img=$(k);if(img)img.src=d.albumImages[k]});

    if(d.stickies&&d.stickies.length){
      var sc=$('stickyBox'),ab=$('addStickyBtn');
      d.stickies.forEach(function(s){
        var st=document.createElement('div');st.className='sticky-note '+s.color;
        st.innerHTML='<button class="del-s">Ã—</button><div class="s-text ed" contenteditable="true" data-key="'+s.key+'">'+s.text+'</div>'+(s.author?'<div class="s-author">'+s.author+'</div>':'');
        sc.insertBefore(st,ab);bindE(st);stickyCount++;
      });
    }

    if(d.musicList){musicList=d.musicList;curMusic=d.curMusic||0}
    if(d.wishList)wishList=d.wishList;
    if(d.moodData){moodData=d.moodData;if(!moodData.pages)moodData.pages=[[],[],[]];if(typeof moodData.curPage!=='number')moodData.curPage=0}
    if(d.checklistData)checklistData=d.checklistData;
    if(d.voiceList)voiceList=d.voiceList;
    if(d.agents)agents=d.agents;
    if(d.masks)masks=d.masks;
    if(d.worldbooks)worldbooks=d.worldbooks;
    if(d.memories)memories=d.memories;
    if(d.apiCfg){apiCfg=d.apiCfg;if(!apiCfg.autoInterval)apiCfg.autoInterval=0}
    if(d.pagerChat)pagerChat=d.pagerChat;
    if(d.pagerBg)pagerBg=d.pagerBg;
    if(typeof d.pagerMemCount==='number')pagerMemCount=d.pagerMemCount;
    if(typeof d.ctxRange==='number')ctxRange=d.ctxRange;
    if(typeof d.autoCleanDays==='number')autoCleanDays=d.autoCleanDays;
    if(d.startDate)localStorage.setItem('loveStartDate',d.startDate);

  }catch(e){console.error('åŠ è½½å¤±è´¥:',e)}
}

function exportData(){
  saveAll();
  setTimeout(function(){
    try{
      var s=localStorage.getItem('loveStoryData');
      if(!s){toast('æ²¡æœ‰æ•°æ®');return}
      var bl=new Blob([s],{type:'application/json;charset=utf-8'}),u=URL.createObjectURL(bl);
      var a=document.createElement('a');a.href=u;a.download='æˆ‘ä»¬çš„æ•…äº‹_'+getToday()+'.json';
      document.body.appendChild(a);a.click();
      setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(u)},100);
      toast('å·²å¯¼å‡ºâ™¥');
    }catch(e){toast('å¯¼å‡ºå¤±è´¥')}
  },300);
}

function importData(inp){
  if(!inp.files||!inp.files[0])return;
  showLoad();
  var rd=new FileReader();
  rd.onload=function(e){
    try{
      var d=JSON.parse(e.target.result);
      if(!d.version){hideLoad();toast('æ— æ•ˆæ–‡ä»¶');return}
      localStorage.setItem('loveStoryData',e.target.result);
      if(d.startDate)localStorage.setItem('loveStartDate',d.startDate);
      if(d.timeline)localStorage.setItem('loveStoryTimeline',JSON.stringify(d.timeline));
      if(d.notebook)localStorage.setItem('loveStoryNotebook',JSON.stringify(d.notebook));
      if(d.theme)localStorage.setItem('currentTheme',d.theme);
      setTimeout(function(){location.reload()},1500);
    }catch(err){hideLoad();toast('æ ¼å¼é”™è¯¯')}
  };
  rd.onerror=function(){hideLoad();toast('è¯»å–å¤±è´¥')};
  rd.readAsText(inp.files[0]);inp.value='';
}

// ===== ç›¸å†Œ =====
function initAlbum(){
  var c=$('albumPages');c.innerHTML='';
  for(var i=0;i<totalPages;i++){
    var pg=document.createElement('div');pg.className='album-page'+(i===0?' active':'');pg.id='albumPage'+i;
    var h='';
    for(var j=0;j<photosPerPage;j++){
      var id='album_'+i+'_'+j;
      h+='<div class="polaroid" data-imgid="'+id+'"><img id="'+id+'" src="" data-key="'+id+'"><div class="up-ov">+</div></div><input type="file" id="'+id+'_input" accept="image/*" style="display:none">';
    }
    pg.innerHTML=h;c.appendChild(pg);
  }
  c.addEventListener('click',function(e){
    var p=e.target.closest('.polaroid');
    if(p){var inp=$(p.getAttribute('data-imgid')+'_input');if(inp)inp.click()}
  });
  c.addEventListener('change',function(e){
    if(e.target.type==='file'){
      var id=e.target.id.replace('_input','');
      hFile(e.target,600,0.7,function(u){$(id).src=u;mark();trigAS()});
    }
  });
  uPN();
}

function uPN(){
  $('pageInfo').textContent=(curPage+1)+'/'+totalPages;
  $('prevPageBtn').disabled=curPage===0;
  $('nextPageBtn').disabled=curPage===totalPages-1;
}

function goPage(n){
  if(n<0||n>=totalPages)return;
  $('albumPage'+curPage).classList.remove('active');
  curPage=n;
  $('albumPage'+curPage).classList.add('active');
  uPN();
}

// ===== æ—¶é—´çº¿ =====
function loadTL(){
  var c=$('timelineBox');c.innerHTML='';
  var s=localStorage.getItem('loveStoryTimeline');
  var d=(s&&s!=='null')?JSON.parse(s):[
    {id:'tl_1',date:'2024.XX.XX',title:'åˆæ¬¡ç›¸é‡',desc:'çˆ¶äº²è¯·æ¥çš„å¿ƒç†åŒ»ç”Ÿ,æˆä¸ºäº†æˆ‘ç”Ÿå‘½ä¸­æœ€é‡è¦çš„äººã€‚'},
    {id:'tl_2',date:'2024.XX.XX',title:'æ¬è¿›ä»–çš„å®¶',desc:'ç„å…³å¤šäº†ä¸€åŒæµ…è“è‰²çš„æ‹–é‹ã€‚'},
    {id:'tl_3',date:'2024.XX.XX',title:'ç¬¬ä¸€æ¬¡è¯´å–œæ¬¢',desc:'ä»–è¯´,ä½ æ˜¯æˆ‘æœ€é‡è¦çš„äººã€‚'}
  ];
  d.forEach(function(it){addTL(it,c)});
}

function addTL(it,c){
  var el=document.createElement('div');el.className='tl-item';el.setAttribute('data-id',it.id);
  el.innerHTML='<button class="del-item">Ã—</button><div class="date ed" contenteditable="true" data-field="date">'+it.date+'</div><div class="title ed" contenteditable="true" data-field="title">'+it.title+'</div><div class="desc ed" contenteditable="true" data-field="desc">'+it.desc+'</div>';
  c.appendChild(el);bindE(el);
}

// ===== ç¬”è®°æœ¬ =====
function loadNB(){
  var c=$('notebookBox');c.innerHTML='';
  var s=localStorage.getItem('loveStoryNotebook');
  var d=(s&&s!=='null')?JSON.parse(s):[{id:'nb_1',date:todayDot(),title:'å†™ç»™è”šå®‰',content:'ä»Šå¤©åˆæ˜¯è¢«ä½ æ¸©æŸ”å¯¹å¾…çš„ä¸€å¤©ã€‚è°¢è°¢ä½ ä¸€ç›´åœ¨æˆ‘èº«è¾¹ã€‚'}];
  d.forEach(function(it){addNB(it,c)});
}

function addNB(it,c){
  var en=document.createElement('div');en.className='nb-entry';en.setAttribute('data-id',it.id);
  if(it.author)en.dataset.author=it.author;
  var len=(it.content||'').replace(/<[^>]*>/g,'').replace(/\s/g,'').length;
  en.innerHTML='<div class="entry-hd"><span class="entry-date ed" contenteditable="true" data-field="date">'+it.date+'</span><button class="del-entry">Ã—</button></div><div class="entry-title ed" contenteditable="true" data-field="title">'+it.title+'</div><div class="entry-content ed" contenteditable="true" data-field="content">'+it.content+'</div>'+(it.author?'<div class="entry-author">â€” '+it.author+'</div>':'')+'<div class="word-count">å­—æ•°:'+len+'</div>';
  c.appendChild(en);bindE(en);
}

// ===== äº‹ä»¶ç›‘å¬ =====
function initEvents(){
  $('themeBtn').addEventListener('click',changeTheme);

  $('bgBtn').addEventListener('click',function(){$('bgInput').click()});
  $('bgInput').addEventListener('change',function(){hFile(this,1200,0.7,function(u){document.body.style.backgroundImage='url('+u+')';mark();trigAS()})});

  $('hdBgBtn').addEventListener('click',function(){$('hdBgInput').click()});
  $('hdBgInput').addEventListener('change',function(){hFile(this,800,0.7,function(u){$('headerBox').style.backgroundImage='url('+u+')';mark();trigAS()})});

  $('mainPhotoWrap').addEventListener('click',function(){$('mainPhotoInput').click()});
  $('mainPhotoInput').addEventListener('change',function(){hFile(this,800,0.8,function(u){$('mainImg').src=u;mark();trigAS()})});

  $('startDateInput').addEventListener('change',function(){
    if(this.value){localStorage.setItem('loveStartDate',this.value);updateDays();mark();trigAS()}
  });

  $('albumBook').addEventListener('click',function(){openModal($('albumModal'))});
  $('closeAlbumBtn').addEventListener('click',function(){closeModal($('albumModal'))});
  $('albumBgBtn').addEventListener('click',function(){$('albumBgInput').click()});
  $('albumBgInput').addEventListener('change',function(){hFile(this,800,0.7,function(u){$('albumBox').style.backgroundImage='url('+u+')';mark();trigAS()})});
  $('prevPageBtn').addEventListener('click',function(){goPage(curPage-1)});
  $('nextPageBtn').addEventListener('click',function(){goPage(curPage+1)});

  // æ—¶é—´çº¿
  $('timelineCard').addEventListener('click',function(){openModal($('timelineModal'));loadTL()});
  $('closeTimelineBtn').addEventListener('click',function(){closeModal($('timelineModal'));if(hasUnsaved){saveAll();showAS();hasUnsaved=false}});
  $('addTimelineBtn').addEventListener('click',function(){addTL({id:'tl_'+uid(),date:todayDot(),title:'æ–°æ—¶åˆ»',desc:'è®°å½•è¿™ä¸€å¤©...'},$('timelineBox'));mark();trigAS()});
  $('timelineBox').addEventListener('click',function(e){if(e.target.classList.contains('del-item')&&confirm('åˆ é™¤?')){e.target.parentElement.remove();mark();trigAS()}});

  // ç¬”è®°æœ¬
  $('notebookCard').addEventListener('click',function(){openModal($('notebookModal'));loadNB()});
  $('closeNotebookBtn').addEventListener('click',function(){closeModal($('notebookModal'));if(hasUnsaved){saveAll();showAS();hasUnsaved=false}});
  $('addNotebookBtn').addEventListener('click',function(){
    var c=$('notebookBox'),en=document.createElement('div');en.className='nb-entry';en.setAttribute('data-id','nb_'+uid());
    en.innerHTML='<div class="entry-hd"><span class="entry-date ed" contenteditable="true" data-field="date">'+todayDot()+'</span><button class="del-entry">Ã—</button></div><div class="entry-title ed" contenteditable="true" data-field="title">æ— é¢˜</div><div class="entry-content ed" contenteditable="true" data-field="content">å†™ä¸‹å¿ƒæƒ…...</div><div class="word-count">å­—æ•°:5</div>';
    c.insertBefore(en,c.firstChild);bindE(en);mark();trigAS();
  });
  $('notebookBox').addEventListener('click',function(e){if(e.target.classList.contains('del-entry')&&confirm('åˆ é™¤?')){e.target.closest('.nb-entry').remove();mark();trigAS()}});
  $('notebookBox').addEventListener('input',function(e){
    if(e.target.getAttribute('data-field')==='content'){
      var l=(e.target.innerText||'').replace(/\s/g,'').length;
      var w=e.target.parentElement.querySelector('.word-count');
      if(w)w.textContent='å­—æ•°:'+l;
    }
  });

  // ä¾¿ç­¾
  $('addStickyBtn').addEventListener('click',function(){
    var sc=$('stickyBox'),cl=stickyColors[stickyCount%4];stickyCount++;
    var s=document.createElement('div');s.className='sticky-note '+cl;
    s.innerHTML='<button class="del-s">Ã—</button><div class="s-text ed" contenteditable="true" data-key="sticky_'+uid()+'">å†™ç‚¹ä»€ä¹ˆ...</div>';
    sc.insertBefore(s,this);bindE(s);mark();trigAS();
  });
  $('stickyBox').addEventListener('click',function(e){if(e.target.classList.contains('del-s')&&confirm('åˆ é™¤?')){e.target.parentElement.remove();mark();trigAS()}});

  // ä¸»é¡µç¼–è¾‘
  document.querySelectorAll('.container [contenteditable="true"]').forEach(function(el){
    el.addEventListener('blur',function(){mark();trigAS()});
    el.addEventListener('input',mark);
  });

  setInterval(checkWN,60000);
  setInterval(updateDays,60000);
}

// ===== åˆå§‹åŒ– =====
function init(){
  loadTheme();
  loadNight();
  loadFont();
  initLock();
  initParticles();
  initCover();
  initAlbum();
  loadAll();
  updateDays();
  initMusic();
  initWish();
  initMood();
  initChecklist();
  initVoice();
  initAgents();
  initMasks();
  initWBooks();
  initMem();
  initAPI();
  initPager();
  initManual();
  initSettings();
  initEvents();
  updateSelects();
  if(autoCleanDays>0)doAutoClean();
}

window.addEventListener('beforeunload',function(){if(hasUnsaved)saveAll()});

if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);
else init();

})();
</script>
</body>
</html>