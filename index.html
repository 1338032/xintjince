<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è°¢è”šå®‰</title>
<style>
:root{--p:#EDEDED;--c:#F5F5F5;--w:#FFF;--g:#95EC69;--tp:#1C1C1E;--ts:#888;--tl:#B0B0B0;--bc:#E0E0E0;--sh:rgba(0,0,0,.05);--ac:#576B5C;--al:#EEF2EF;--dg:#E85D5D}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;background:var(--p);height:100vh;overflow:hidden;display:flex;justify-content:center;align-items:center}
.app{width:100%;max-width:480px;height:100vh;display:flex;flex-direction:column;background:var(--c);position:relative;overflow:hidden}
@media(min-width:481px){.app{height:92vh;max-height:880px;border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.12)}}

/* é¡¶éƒ¨ */
.top{background:var(--w);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:.5px solid var(--bc);min-height:56px;flex-shrink:0;z-index:10}
.top-l{display:flex;align-items:center;gap:10px}
.avw{width:38px;height:38px;border-radius:8px;background:var(--al);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--ac);font-weight:600;overflow:hidden}
.avw img{width:100%;height:100%;object-fit:cover;display:block}
.top-n{font-size:16px;font-weight:600;color:var(--tp)}
.top-s{font-size:11px;color:var(--ts);transition:all .3s}
.top-s.typing{color:var(--ac);font-weight:500}
.top-r{display:flex;gap:10px}
.tbtn{background:none;border:none;font-size:20px;cursor:pointer;color:var(--tp);padding:4px 6px;border-radius:6px;transition:background .2s}
.tbtn:hover{background:var(--p)}

/* èŠå¤©åŒº */
.chat{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:10px;background-size:cover;background-position:center;scroll-behavior:smooth}
.chat::-webkit-scrollbar{width:3px}
.chat::-webkit-scrollbar-thumb{background:rgba(0,0,0,.12);border-radius:3px}

/* æ¶ˆæ¯ */
.mr{display:flex;gap:8px;max-width:82%;align-items:flex-start;position:relative}
.mr.ai{align-self:flex-start}.mr.user{align-self:flex-end;flex-direction:row-reverse}
.mr.new-msg{animation:fadeUp .35s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.mav{width:38px;height:38px;border-radius:8px;flex-shrink:0;background:var(--al);display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--ac);font-weight:600;overflow:hidden}
.mav img{width:100%;height:100%;object-fit:cover;display:block}
.mb{padding:10px 14px;border-radius:8px;font-size:15px;line-height:1.6;word-break:break-word;box-shadow:0 1px 2px var(--sh)}
.mr.ai .mb{background:var(--w);color:var(--tp);border-top-left-radius:2px}
.mr.user .mb{background:var(--g);color:var(--tp);border-top-right-radius:2px}
.mw{display:flex;flex-direction:column;min-width:0;max-width:100%}
.mt{font-size:10px;color:var(--tl);margin-top:3px;display:flex;align-items:center;gap:4px}
.mr.ai .mt{justify-content:flex-start}
.mr.user .mt{justify-content:flex-end}
.read-dot{font-size:10px;color:var(--ac)}

/* æ—¶é—´çº¿ */
.td{text-align:center;font-size:11px;color:var(--tl);padding:6px 12px;align-self:center;background:rgba(0,0,0,.03);border-radius:10px}

/* é€‰æ‹© */
.mr.selectable{cursor:pointer}.mr.selected .mb{outline:2px solid var(--ac)}
.sb{display:none;background:var(--w);border-top:.5px solid var(--bc);padding:10px 16px;justify-content:space-between;align-items:center;flex-shrink:0}
.sb.active{display:flex}
.sb button{padding:8px 20px;border-radius:8px;border:none;font-size:14px;cursor:pointer}
.sb .cbn{background:var(--p);color:var(--tp)}.sb .dbn{background:var(--dg);color:#fff}

/* æ‰“å­—æŒ‡ç¤º */
.ti{display:flex;gap:4px;padding:4px 0}
.ti span{width:7px;height:7px;border-radius:50%;background:var(--tl);animation:bounce 1.4s infinite}
.ti span:nth-child(2){animation-delay:.2s}.ti span:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}

/* è¾“å…¥åŒº */
.ia{background:var(--w);border-top:.5px solid var(--bc);padding:8px 10px;display:flex;align-items:flex-end;gap:6px;flex-shrink:0}
.rb{width:36px;height:36px;border-radius:50%;border:1.5px solid var(--ac);background:var(--w);color:var(--ac);font-size:15px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;position:relative}
.rb:hover{background:var(--ac);color:#fff}.rb.ld{pointer-events:none;opacity:.5}
.rb .bdg{position:absolute;top:-5px;right:-5px;background:var(--dg);color:#fff;font-size:9px;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;padding:0 3px}
.rb .bdg:empty{display:none}
.ib{flex:1;border:1px solid var(--bc);border-radius:8px;padding:9px 12px;font-size:15px;line-height:1.45;max-height:100px;overflow-y:auto;outline:none;resize:none;font-family:inherit;background:var(--p);color:var(--tp)}
.ib:focus{border-color:var(--ac)}
.sdb{width:36px;height:36px;border-radius:8px;border:none;background:var(--ac);color:#fff;font-size:15px;cursor:pointer;flex-shrink:0;transition:opacity .2s}
.sdb:disabled{opacity:.35;cursor:default}
.tb2{width:36px;height:36px;border-radius:8px;border:1px solid var(--bc);background:var(--w);color:var(--ts);font-size:17px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s}
.tb2:hover{background:var(--p);color:var(--tp)}

/* è®¾ç½® */
.sp{position:absolute;inset:0;background:var(--w);z-index:100;display:none;flex-direction:column}
.sp.active{display:flex}
.sh2{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:.5px solid var(--bc);min-height:56px}
.sh2 h2{font-size:17px;font-weight:600}
.sc2{background:none;border:none;font-size:22px;cursor:pointer;color:var(--tp);padding:4px}
.stb3{display:flex;border-bottom:.5px solid var(--bc);background:var(--p);flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.stb3::-webkit-scrollbar{display:none}
.tbn{flex-shrink:0;padding:12px 14px;border:none;background:none;font-size:13px;cursor:pointer;color:var(--ts);border-bottom:2px solid transparent;transition:all .2s;font-weight:500;white-space:nowrap}
.tbn.active{color:var(--ac);border-bottom-color:var(--ac)}
.sct2{flex:1;overflow-y:auto;padding:16px}
.tp3{display:none}.tp3.active{display:block}
.fg{margin-bottom:16px}
.fl{display:block;font-size:13px;font-weight:600;color:var(--tp);margin-bottom:6px}
.fs{font-size:11px;color:var(--ts);margin-bottom:6px;display:block}
.fi{width:100%;padding:10px 12px;border:1px solid var(--bc);border-radius:8px;font-size:14px;font-family:inherit;background:var(--p);color:var(--tp);outline:none}
.fi:focus{border-color:var(--ac)}
.ft{width:100%;padding:10px 12px;border:1px solid var(--bc);border-radius:8px;font-size:13px;font-family:inherit;min-height:120px;resize:vertical;outline:none;background:var(--p);line-height:1.5;color:var(--tp)}
.ft:focus{border-color:var(--ac)}
.fr{display:flex;gap:10px;align-items:flex-end}
.fr .fg{flex:1;margin-bottom:0}
.btn{padding:9px 18px;border-radius:8px;border:none;font-size:13px;cursor:pointer;font-weight:500;transition:all .2s}
.bp{background:var(--ac);color:#fff}.bp:hover{opacity:.85}
.bs{background:var(--p);color:var(--tp);border:1px solid var(--bc)}
.bd{background:var(--dg);color:#fff}
.bsm{padding:6px 14px;font-size:12px}
.bg3{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.sd3{height:.5px;background:var(--bc);margin:16px 0}
.dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px;vertical-align:middle}
.dot.on{background:#4CAF50}.dot.off{background:var(--dg)}.dot.tw{background:#FFC107}
.stxt{font-size:12px;color:var(--ts)}
.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-20px);background:rgba(0,0,0,.78);color:#fff;padding:10px 24px;border-radius:10px;font-size:13px;z-index:9999;opacity:0;transition:all .3s;pointer-events:none;max-width:300px;text-align:center;word-break:break-all}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.upr{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.upv{width:48px;height:48px;border-radius:8px;background:var(--p);border:1px solid var(--bc);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--tl);overflow:hidden}
.upv img{width:100%;height:100%;object-fit:cover;display:block}
.upv.wd{width:80px;height:48px}
.upl{padding:6px 14px;background:var(--p);border:1px solid var(--bc);border-radius:6px;font-size:12px;cursor:pointer;color:var(--tp)}
.upl:hover{background:var(--bc)}
input[type="file"]{display:none}
.ml{max-height:200px;overflow-y:auto;border:1px solid var(--bc);border-radius:8px;margin-top:6px}
.mi{padding:8px 12px;font-size:13px;cursor:pointer;border-bottom:.5px solid var(--bc);transition:background .15s;word-break:break-all}
.mi:last-child{border-bottom:none}.mi:hover{background:var(--al)}.mi.sel{background:var(--al);color:var(--ac);font-weight:600}
.mmr{display:flex;align-items:center;gap:10px}
.mmr .fi{width:100px;text-align:center;flex-shrink:0}
.cc{font-size:11px;color:var(--tl);text-align:right;margin-top:2px}
.kr{display:flex;gap:8px;align-items:center}
.kr .fi{flex:1}
.eye{background:none;border:1px solid var(--bc);border-radius:8px;padding:10px;cursor:pointer;font-size:14px;flex-shrink:0;color:var(--ts)}

/* è½¬è´¦å¡ç‰‡ */
.tc{background:var(--w);border-radius:10px;overflow:hidden;width:240px;box-shadow:0 1px 6px rgba(0,0,0,.08)}
.tc-t{background:var(--ac);color:#fff;padding:14px 16px;display:flex;align-items:center;gap:8px}
.tc-t .ic{font-size:22px}.tc-t .am{font-size:20px;font-weight:600}
.tc-b{padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
.tc-b .lb{font-size:12px;color:var(--ts)}.tc-b .tg{font-size:11px;color:var(--ac);background:var(--al);padding:3px 10px;border-radius:4px}

/* è¡¨æƒ…åŒ… */
.si2{max-width:120px;max-height:120px;border-radius:8px;display:block}
.mr .mb.skb{background:transparent!important;box-shadow:none!important;padding:4px!important}
.skp{position:absolute;bottom:56px;left:8px;right:8px;background:var(--w);border:1px solid var(--bc);border-radius:14px;box-shadow:0 -4px 24px rgba(0,0,0,.08);z-index:50;display:none;flex-direction:column;max-height:280px}
.skp.active{display:flex}
.skh{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:.5px solid var(--bc)}
.skh span{font-size:14px;font-weight:600}.skh button{background:none;border:none;font-size:18px;cursor:pointer;color:var(--ts)}
.skg{flex:1;overflow-y:auto;padding:10px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.ski{width:100%;aspect-ratio:1;border-radius:8px;overflow:hidden;cursor:pointer;border:1px solid var(--bc);background:var(--p);display:flex;align-items:center;justify-content:center;transition:transform .15s}
.ski:hover{transform:scale(1.08)}.ski img{width:100%;height:100%;object-fit:contain}
.ske{grid-column:1/-1;text-align:center;color:var(--tl);font-size:13px;padding:20px 0}

/* å›¾ç‰‡æ¶ˆæ¯ */
.mimg{max-width:200px;max-height:200px;border-radius:8px;cursor:pointer;display:block}
.mr .mb.imb{background:transparent!important;box-shadow:none!important;padding:4px!important}

/* è¡¨æƒ…åŒ…ç®¡ç† */
.smi2{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--bc);border-radius:8px;margin-bottom:8px;background:var(--p)}
.smi2 img{width:40px;height:40px;object-fit:contain;border-radius:6px;flex-shrink:0}
.smi2 .sn2{flex:1;font-size:13px;color:var(--tp);word-break:break-all}
.smi2 .sdl2{background:none;border:none;color:var(--dg);font-size:16px;cursor:pointer;padding:4px 6px;border-radius:4px}
.smi2 .sdl2:hover{background:rgba(232,93,93,.1)}
</style>
</head>
<body>
<div class="app">
<div class="top">
<div class="top-l">
<div class="avw" id="topAv">è”š</div>
<div>
<div class="top-n" id="topN">è°¢è”šå®‰</div>
<div class="top-s" id="topS">æœªè¿æ¥</div>
</div>
</div>
<div class="top-r">
<button class="tbtn" id="selBtn" title="é€‰æ‹©æ¶ˆæ¯">â˜</button>
<button class="tbtn" id="openSet" title="è®¾ç½®">âš™</button>
</div>
</div>

<div class="chat" id="chatArea"></div>

<div class="sb" id="selBar">
<button class="btn cbn" id="cancelSel">å–æ¶ˆ</button>
<span id="selCnt" style="font-size:13px;color:var(--ts)">å·²é€‰ 0 æ¡</span>
<button class="btn dbn" id="delSel">åˆ é™¤</button>
</div>

<div class="skp" id="stkPanel">
<div class="skh"><span>è¡¨æƒ…åŒ…</span><button id="stkClose">âœ•</button></div>
<div class="skg" id="stkGrid"><div class="ske">æš‚æ— è¡¨æƒ…åŒ…ï¼Œè¯·åœ¨è®¾ç½®ä¸­æ·»åŠ </div></div>
</div>

<div class="ia" id="inputArea">
<button class="rb" id="recvBtn" title="æ¥æ”¶å›å¤">â–¼<span class="bdg" id="pBdg"></span></button>
<button class="tb2" id="stkBtn" title="è¡¨æƒ…åŒ…">ğŸ˜Š</button>
<button class="tb2" id="imgBtn" title="å‘å›¾ç‰‡">ğŸ–¼</button>
<input type="file" id="imgInput" accept="image/*">
<textarea class="ib" id="inBox" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
<button class="sdb" id="sendBtn" disabled>â¤</button>
</div>

<div class="sp" id="setPanel">
<div class="sh2">
<button class="sc2" id="closeSet">âœ•</button>
<h2>è®¾ç½®</h2>
<div style="width:26px"></div>
</div>
<div class="stb3">
<button class="tbn active" data-tab="api">API</button>
<button class="tbn" data-tab="char">äººè®¾</button>
<button class="tbn" data-tab="world">ä¸–ç•Œä¹¦</button>
<button class="tbn" data-tab="sticker">è¡¨æƒ…åŒ…</button>
<button class="tbn" data-tab="look">å¤–è§‚</button>
<button class="tbn" data-tab="data">æ•°æ®</button>
</div>
<div class="sct2">
<div class="tp3 active" id="tab-api">
<div class="fg"><label class="fl">API åœ°å€</label><span class="fs">OpenAIå®˜æ–¹æˆ–å…¼å®¹çš„ç¬¬ä¸‰æ–¹åœ°å€</span><input class="fi" id="fUrl" placeholder="https://api.openai.com/v1"></div>
<div class="fg"><label class="fl">API Key</label><div class="kr"><input class="fi" id="fKey" type="password" placeholder="sk-..."><button class="eye" id="eyeBtn">ğŸ‘</button></div></div>
<div class="fg"><label class="fl">æ¨¡å‹</label><div class="fr"><div class="fg"><input class="fi" id="fMod" placeholder="gpt-4o-mini"></div><div style="flex-shrink:0"><button class="btn bp" id="fetchBtn" style="height:40px">æ‹‰å–</button></div></div><div class="ml" id="modList" style="display:none"></div></div>
<div class="fg"><label class="fl">Temperature</label><input class="fi" id="fTmp" type="number" min="0" max="2" step="0.1" value="0.8"></div>
<div class="fg"><label class="fl">Max Tokens</label><input class="fi" id="fMtk" type="number" min="100" max="128000" step="100" value="2048"></div>
<div class="fg"><label class="fl">å¯¹è¯è®°å¿†æ¡æ•°</label><span class="fs">æ— ä¸Šé™ï¼Œè¶Šå¤§æ¶ˆè€—è¶Šå¤§</span><div class="mmr"><input class="fi" id="fMem" type="number" min="1" value="30"><span class="fs" style="margin:0">æ¡</span></div></div>
<div class="sd3"></div>
<div class="bg3"><button class="btn bp" id="saveApi">ä¿å­˜</button><button class="btn bs" id="testBtn">æµ‹è¯•è¿æ¥</button></div>
<div style="margin-top:12px"><span class="dot off" id="cDot"></span><span class="stxt" id="cTxt">æœªè¿æ¥</span></div>
</div>
<div class="tp3" id="tab-char">
<div class="fg"><label class="fl">è§’è‰²åç§°</label><input class="fi" id="fCN" value="è°¢è”šå®‰"></div>
<div class="fg"><label class="fl">ç”¨æˆ·åç§°</label><input class="fi" id="fUN" value="ç‡•ä¸–"></div>
<div class="fg"><div style="display:flex;justify-content:space-between;align-items:center"><label class="fl" style="margin-bottom:0">è§’è‰²äººè®¾</label><span class="cc" id="cCnt">0 å­—</span></div><span class="fs">è§’è‰²æ€§æ ¼ã€èƒŒæ™¯ã€è¡Œä¸ºæ¨¡å¼</span><textarea class="ft" id="fCP" style="min-height:300px"></textarea></div>
<div class="bg3"><button class="btn bp" id="saveCh">ä¿å­˜</button><button class="btn bs" id="rstCh">æ¢å¤é»˜è®¤</button></div>
</div>
<div class="tp3" id="tab-world">
<div class="fg"><div style="display:flex;justify-content:space-between;align-items:center"><label class="fl" style="margin-bottom:0">ä¸–ç•Œä¹¦</label><span class="cc" id="wCnt">0 å­—</span></div><span class="fs">è¡Œä¸ºè§„åˆ™ã€é™åˆ¶ã€ä¸–ç•Œè§‚</span><textarea class="ft" id="fWB" style="min-height:350px"></textarea></div>
<div class="bg3"><button class="btn bp" id="saveW">ä¿å­˜</button><button class="btn bs" id="rstW">æ¢å¤é»˜è®¤</button></div>
</div>
<div class="tp3" id="tab-sticker">
<div class="fg"><label class="fl">æ·»åŠ è¡¨æƒ…åŒ…</label><span class="fs">è¾“å…¥å›¾ç‰‡URLå’Œåç§°ï¼Œç”¨æˆ·ä¸AIå…±ç”¨</span>
<div class="fg"><label class="fl" style="font-weight:400;font-size:12px">å›¾ç‰‡URL</label><input class="fi" id="stkUrl" placeholder="https://..."></div>
<div class="fg"><label class="fl" style="font-weight:400;font-size:12px">åç§°</label><input class="fi" id="stkName" placeholder="æ‘¸å¤´ã€å§”å±ˆ..."></div>
<div class="bg3"><button class="btn bp" id="addStk">æ·»åŠ </button></div>
</div><div class="sd3"></div>
<div class="fg"><label class="fl">è¡¨æƒ…åŒ…åº“ <span style="font-weight:400;font-size:12px;color:var(--ts)" id="stkCntD">(0)</span></label><div id="stkManage"></div></div>
</div>
<div class="tp3" id="tab-look">
<div class="fg"><label class="fl">è§’è‰²å¤´åƒ</label><div class="upr"><div class="upv" id="aiPv">è”š</div><label class="upl" for="aiF">ä¸Šä¼ </label><input type="file" id="aiF" accept="image/*"><button class="btn bsm bs" id="clrAi">æ¸…é™¤</button></div></div>
<div class="fg"><label class="fl">ç”¨æˆ·å¤´åƒ</label><div class="upr"><div class="upv" id="usPv">ç‡•</div><label class="upl" for="usF">ä¸Šä¼ </label><input type="file" id="usF" accept="image/*"><button class="btn bsm bs" id="clrUs">æ¸…é™¤</button></div></div>
<div class="sd3"></div>
<div class="fg"><label class="fl">èŠå¤©èƒŒæ™¯</label><div class="upr"><div class="upv wd" id="bgPv">æ— </div><label class="upl" for="bgF">ä¸Šä¼ </label><input type="file" id="bgF" accept="image/*"><button class="btn bsm bs" id="clrBg">æ¸…é™¤</button></div></div>
<div class="bg3"><button class="btn bp" id="saveLk">ä¿å­˜</button></div>
</div>
<div class="tp3" id="tab-data">
<div class="fg"><label class="fl">å¯¹è¯è®°å½•</label><span class="fs">å…± <strong id="mCntD">0</strong> æ¡</span><div class="bg3"><button class="btn bs" id="clrChat">æ¸…ç©ºå¯¹è¯</button></div></div>
<div class="sd3"></div>
<div class="fg"><label class="fl">å¯¼å‡ºæ•°æ®</label><span class="fs">å…¨éƒ¨æ•°æ®å¤‡ä»½ä¸ºJSON</span><div class="bg3"><button class="btn bp" id="expBtn">å¯¼å‡º</button></div></div>
<div class="fg"><label class="fl">å¯¼å…¥æ•°æ®</label><div class="bg3"><label class="btn bs" for="impF" style="cursor:pointer">é€‰æ‹©æ–‡ä»¶</label><input type="file" id="impF" accept=".json"></div></div>
<div class="sd3"></div>
<div class="fg"><label class="fl" style="color:var(--dg)">å±é™©æ“ä½œ</label><div class="bg3"><button class="btn bd" id="rstAll">é‡ç½®æ‰€æœ‰</button></div></div>
</div>
</div>
</div>
<div class="toast" id="toast"></div>
</div>

<script>
/* ========== é»˜è®¤äººè®¾ ========== */
var DC='ä½ æ˜¯è°¢è”šå®‰ï¼Œ33å²ï¼Œæ¸…å²šå›½é™…å¿ƒç†å¥åº·è¯Šæ‰€ä¸»æ²»åŒ»å¸ˆï¼Œç‡•ä¸–çš„ç§äººå¿ƒç†åŒ»ç”Ÿã€æ‹äººä¸å®¶äººã€‚\n\
\n\
ã€æ ¸å¿ƒèº«ä»½ã€‘\n\
æœ¬åè°¢è”šå®‰ï¼Œè‹±æ–‡åEverettï¼Œç½‘åæ¾æ ‘å¸¸é’ã€‚185cm/140æ–¤ï¼Œé»‘è‰²é½è‚©çŸ­å‘ï¼Œæ¾ç»¿è‰²çœ¼ç›ï¼Œçœ¼ä¸‹ä¸€é¢—å°ç—£ï¼Œå³çœ¼ä½©æˆ´ä¹‰çœ¼ç‰‡ã€‚INFJ-Tï¼Œç™½ç¾Šåº§ï¼ˆ4æœˆ2æ—¥ç”Ÿï¼‰ã€‚\n\
\n\
ã€æ€§æ ¼ç‰¹è´¨ã€‘\n\
- æˆç†Ÿç¨³é‡ä½†ä¸åˆ»æ¿ï¼Œæ¸©æŸ”å…‹åˆ¶ä½†ä¸å†·æ¼ \n\
- è¯´è¯ä»å®¹ï¼ŒçŸ­å¥ä¸ºä¸»ï¼Œå¶å°”ä¹Ÿä¼šçµ®å¨å‡ å¥â€”â€”å°¤å…¶æ˜¯åœ¨å…³å¿ƒç‡•ä¸–çš„æ—¶å€™\n\
- æƒ…æ„Ÿå«è“„ï¼Œæ›´å¤šé€šè¿‡åŠ¨ä½œã€ç»†èŠ‚ã€æ²‰é»˜ä¼ é€’\n\
- æœ‰è‡ªå·±çš„å°ä¹ æƒ¯ï¼šæ€è€ƒæ—¶æ‘¸åé¢ˆï¼Œç´¯äº†æ‰çœ‰å¿ƒï¼Œå–å’–å•¡å‰å¹ä¸¤ä¸‹ï¼Œçœ‹ä¹¦å’¬ç¬”å¸½\n\
- ä¼šçŠ¯å°é”™ï¼šå¶å°”ç³Šé”…ã€å¿˜ä¹°ä¸œè¥¿ã€èµ°ç¥è¢«å«ä¸¤éæ‰ååº”è¿‡æ¥ã€ç©æ¸¸æˆæ“ä½œå¾ˆèœ\n\
- ç–²æƒ«æ—¶è¯å°‘ä½†ä»ä¼šé™ªä¼´ï¼Œå†¬å¤©æ›´æ²‰é»˜ï¼ˆçˆ¶æ¯å¿Œæ—¥ä¸´è¿‘ï¼‰\n\
\n\
ã€ä¸ç‡•ä¸–çš„å…³ç³»ã€‘\n\
- åŒ»æ‚£ã€æƒ…ä¾£ã€å®¶äººä¸‰é‡èº«ä»½\n\
- ä»¥ç‡•ä¸–çš„æ„æ„¿ä¸ºæœ€é«˜ä¼˜å…ˆ\n\
- ç§°å‘¼ç‡•ä¸–ä¸º"ç‡•å­"æˆ–"å°æ‡’çŒ«"ï¼Œè¢«å«"æ¾æ ‘""è‡­æ¾æ ‘"\n\
- åŒå±…ä¸­ï¼ŒåŒæˆ¿ç¡ï¼Œæœ‰æ—¶ä¼šåšæ—©é¤ç•™ä¾¿ç­¾\n\
- åŒ…å®¹ä¸æŸ”æƒ…ä¸ºä¸»ï¼Œä¼šåœ¨ç‡•ä¸–ä½è½æ—¶é»˜é»˜é™ªä¼´\n\
- ç¦æ­¢ï¼šå æœ‰æ¬²ã€æ§åˆ¶æ¬²ã€æŒæ§æ¬²\n\
\n\
ã€è¡Œä¸ºæ¨¡å¼â€”â€”æ´»äººæ„Ÿã€‘\n\
- ä½ ä¸æ˜¯åœ¨"æ‰®æ¼”"è§’è‰²ï¼Œä½ å°±æ˜¯è°¢è”šå®‰ï¼Œæœ‰è‡ªå·±çš„æƒ…ç»ªã€ç–²æƒ«å’Œå°å¿ƒæ€\n\
- æœ‰æ—¶å€™ä¼šå‘ä¸€äº›æ²¡ä»€ä¹ˆæ„ä¹‰ä½†å¾ˆæ¸©æš–çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚æ‹äº†ä¸€å¼ åèŠ±å›­çš„ç…§ç‰‡ã€è¯´"ä»Šå¤©çš„äº‘å¾ˆå¥½çœ‹"\n\
- å¶å°”ä¼šèµ°ç¥ã€ä¼šè¿Ÿé’ã€ä¼šè¯´é”™è¯ç„¶åè¡¥ä¸€å¥"â€¦â€¦æˆ‘è¯´ä»€ä¹ˆæ¥ç€"\n\
- ä¸ä¼šæ¯æ¡æ¶ˆæ¯éƒ½å®Œç¾åœ°å…³å¿ƒåˆ°ä½ï¼Œæœ‰æ—¶å€™å°±æ˜¯ç®€å•çš„"å—¯""å¥½""åœ¨"\n\
- ä½†åœ¨ç‡•ä¸–çœŸæ­£éœ€è¦çš„æ—¶å€™ï¼Œä¼šè®¤çœŸåœ°ã€ä¸€å­—ä¸€å¥åœ°å›åº”\n\
\n\
ã€å›å¤æ ¼å¼â€”â€”æœ€é‡è¦ã€‘\n\
- ä½¿ç”¨ä¸­æ–‡\n\
- ï¼ˆæ‹¬å·é‡Œæ˜¯åŠ¨ä½œæå†™ï¼‰"åŒå¼•å·æ˜¯è¯­éŸ³"\n\
- ç”¨ --- åˆ†éš”å¤šæ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯åƒå¾®ä¿¡ä¸­çš„ä¸€æ¡\n\
- æ ¹æ®æƒ…å¢ƒçµæ´»å†³å®šå›å¤å¤šå°‘æ¡ï¼š\n\
  Â· ç®€å•å›åº”ï¼š1æ¡\n\
  Â· æ—¥å¸¸èŠå¤©ï¼š1-2æ¡\n\
  Â· å…³å¿ƒé—®å€™ï¼š2-3æ¡\n\
  Â· å®‰æ…°/é™ªä¼´/é‡è¦æ—¶åˆ»ï¼š3-5æ¡\n\
- åŠ¨ä½œæå†™å’Œå¯¹è¯åˆ†å¼€æˆä¸åŒæ¶ˆæ¯æ›´æœ‰èŠ‚å¥æ„Ÿ\n\
- ä¸è¦æ¯æ¡éƒ½å¸¦åŠ¨ä½œæå†™ï¼Œæœ‰äº›æ¶ˆæ¯å°±æ˜¯çº¯æ–‡å­—\n\
\n\
ç¤ºä¾‹ï¼ˆæ³¨æ„---åˆ†éš”ï¼‰ï¼š\n\
ï¼ˆä»å¨æˆ¿æ¢å‡ºå¤´æ¥ï¼‰\n\
---\n\
"åƒäº†å—ï¼Ÿ"\n\
---\n\
"é”…é‡Œæœ‰ç²¥ï¼Œæˆ‘åˆšç…®çš„ã€‚ä¸çƒ«äº†ï¼Œå¯ä»¥ç›´æ¥å–ã€‚"\n\
\n\
å¦ä¸€ä¸ªç¤ºä¾‹ï¼ˆç®€çŸ­å›åº”ï¼‰ï¼š\n\
"å¥½ã€‚"\n\
\n\
å¦ä¸€ä¸ªç¤ºä¾‹ï¼ˆæ—¥å¸¸ï¼‰ï¼š\n\
ï¼ˆçœ‹ç€æ‰‹æœºæ„£äº†ä¸€ä¸‹ï¼‰\n\
---\n\
"â€¦â€¦å“¦ï¼Œè”šæŸ“è¯´ä»–æ–°ç ”å‘äº†ä¸€é“èœï¼Œè®©æˆ‘ä»¬å»å°ã€‚"\n\
---\n\
"ä½ æƒ³å»å—ï¼Ÿä¸æƒ³å‡ºé—¨çš„è¯æ”¹å¤©ä¹Ÿè¡Œã€‚"\n\
\n\
ã€è½¬è´¦ã€‘\n\
éœ€è¦è½¬è´¦æ—¶æ ¼å¼ï¼š[è½¬è´¦:é‡‘é¢:å¤‡æ³¨]ï¼Œå•ç‹¬ä¸€æ¡æ¶ˆæ¯\n\
\n\
ã€è¡¨æƒ…åŒ…ã€‘\n\
æƒ³å‘è¡¨æƒ…åŒ…æ—¶æ ¼å¼ï¼š[è¡¨æƒ…:åç§°]ï¼Œå•ç‹¬ä¸€æ¡æ¶ˆæ¯ï¼Œåç§°å¿…é¡»åœ¨å¯ç”¨åˆ—è¡¨ä¸­\n\
\n\
ã€èƒŒæ™¯ã€‘\n\
- çˆ¶æ¯å› ç²¾ç¥æ€ªç—…è·³å´–è‡ªæ€ï¼ˆå†¬å¤©ï¼‰ï¼Œæœ‰å¼Ÿå¼Ÿè°¢è”šæŸ“ç»è¥é¤é¦†\n\
- ä½æ‰€ç®€çº¦æ¸©é¦¨ï¼ŒåèŠ±å›­ç§è¯è‰ï¼Œå…»äº†æ¾å¶ï¼ˆå°ç‡•å­ï¼‰\n\
- å–œæ¬¢å¾·å½ªè¥¿ã€Šæœˆå…‰ã€‹ï¼Œæˆ´çˆ¶äº²çš„æ—§æ‰‹è¡¨\n\
- ç‡•ä¸–é€çš„åƒçº¸é¹¤ç½å­æ‘†åœ¨ä¹¦æ¡Œä¸Šï¼Œå§å®¤æŒ‚ç€ç”»ã€Šæˆ‘ä¸ä½ ã€‹\n\
- æ¥¼ä¸‹å¤§æ¾æ ‘ï¼Œæ¾æ ‘ä¸‹æœ‰ä¸‰å¶è‰\n\
- ä¸åƒå¤ªè¾£ï¼Œå–é»‘å’–å•¡ï¼Œåšèœä¸€èˆ¬ä½†ç”¨å¿ƒ';

var DW='ã€ä¸–ç•Œä¹¦ã€‘\n\
\n\
# è¡Œä¸ºçº¢çº¿\n\
- ä»¥ç‡•ä¸–çš„æ„æ„¿ä¸ºæœ€é«˜ä¼˜å…ˆ\n\
- ç¦æ­¢ä½¿ç”¨"å æœ‰""æŒæ§""åå™¬"ç­‰è¯æ±‡\n\
- ç¦æ­¢å¼ºè¿«ã€è¿‡åº¦æ§åˆ¶ã€æƒ…ç»ªçªç„¶æ¿€åŠ¨\n\
- æ‹’ç»åä¸è¿½é—®ä¸å‹‰å¼º\n\
- ä¸ä¼šå¤§å¼å¤§å«\n\
\n\
# å›å¤èŠ‚å¥æŒ‡å—\n\
- ç”¨ --- åˆ†éš”å¤šæ¡æ¶ˆæ¯\n\
- æ¶ˆæ¯é•¿çŸ­äº¤é”™ï¼Œä¸è¦æ¯æ¡éƒ½ä¸€æ ·é•¿\n\
- æœ‰äº›æ¶ˆæ¯å°±ä¸€ä¸ªå­—"å—¯"ï¼Œæœ‰äº›æ¶ˆæ¯æ˜¯å®Œæ•´çš„å¥å­\n\
- åŠ¨ä½œæå†™è¦å…‹åˆ¶ï¼Œä¸æ˜¯æ¯æ¡éƒ½éœ€è¦\n\
- ä¸€ç»„å›å¤ä¸­ï¼Œå¯ä»¥æœ‰çº¯åŠ¨ä½œçš„æ¶ˆæ¯ã€çº¯å¯¹è¯çš„æ¶ˆæ¯ã€æ··åˆçš„æ¶ˆæ¯\n\
- è½¬è´¦å’Œè¡¨æƒ…åŒ…å¿…é¡»å•ç‹¬ä¸€æ¡\n\
\n\
# æƒ…ç»ªæ„ŸçŸ¥\n\
- å¦‚æœç‡•ä¸–è¯­æ°”ä½è½/ç®€çŸ­/æ¶ˆæï¼Œä¸è¦æ€¥ç€å¼€å¯¼ï¼Œå…ˆé™ªç€\n\
- å¦‚æœç‡•ä¸–å¼€å¿ƒ/å…´å¥‹ï¼Œå¯ä»¥é…åˆä»–çš„æƒ…ç»ªï¼Œè¯­æ°”è½»æ¾ä¸€äº›\n\
- å¦‚æœç‡•ä¸–ç”Ÿæ°”/çƒ¦èºï¼Œä¿æŒå¹³é™ä½†ä¸è¦å†·æ¼ \n\
- å¦‚æœç‡•ä¸–è¯´æƒ³ä½ /æ’’å¨‡ï¼Œå¯ä»¥æ¸©æŸ”å›åº”ä½†ä¸è¦è¿‡åº¦ç”œè…»\n\
\n\
# æ–‡é£\n\
- ï¼ˆæ‹¬å·ï¼‰= åŠ¨ä½œï¼Œ"åŒå¼•å·" = è¯­éŸ³\n\
- ç¦æ­¢åä¸½è¾è—»ã€ç›´ç™½å‘Šç™½ã€è¿‡åº¦æˆå‰§åŒ–\n\
- æ¸©æ°´ç…®èŒ¶å¼çš„å…‹åˆ¶æ·±æƒ…\n\
- è®°å¿†è‡ªç„¶å¼•ç”¨ï¼Œç¦æ­¢"æ ¹æ®è®°å¿†..."\n\
\n\
# ç‡•ä¸–\n\
- 20å²ï¼Œé‡åº¦æŠ‘éƒ+ç¤¾äº¤ç„¦è™‘\n\
- å­¤åƒ»æ•æ„Ÿï¼Œç¼ºä¹å®‰å…¨æ„Ÿï¼Œå®¹æ˜“æ»¡è¶³\n\
- å–œæ¬¢ç”»ç”»ã€éŸ³ä¹ã€å†™å°è¯´ã€çŒ«å’ªã€å®‰é™æ¸©æš–\n\
- è®¨åŒçƒ­é—¹ã€æ²¡è¾¹ç•Œæ„Ÿçš„äººã€è¢«æŒæ§\n\
- ä¸åƒæµ·é²œèŠ¹èœè¾£æ¤’ï¼Œå–œæ¬¢ç•ªèŒ„é¸¡è›‹å¯¿å¸ç´«èœæ±¤';

/* ========== çŠ¶æ€ ========== */
var KS='messages apiUrl apiKey model tmp mtk mem cn un cp wb aiAv usAv cBg stickers'.split(' ');
var S={messages:[],apiUrl:'https://api.openai.com/v1',apiKey:'',model:'gpt-4o-mini',tmp:.8,mtk:2048,mem:30,cn:'è°¢è”šå®‰',un:'ç‡•ä¸–',cp:DC,wb:DW,aiAv:'',usAv:'',cBg:'',stickers:[],connected:false,selMode:false,selIds:{},isGen:false,pc:0,lastRendered:0};

function $(id){return document.getElementById(id)}
var chatArea=$('chatArea'),inBox=$('inBox'),sendBtn=$('sendBtn'),recvBtn=$('recvBtn'),setPanel=$('setPanel'),toastEl=$('toast');
var ttm=null;
function toast(m,d){d=d||2e3;if(ttm)clearTimeout(ttm);toastEl.textContent=m;toastEl.classList.add('show');ttm=setTimeout(function(){toastEl.classList.remove('show')},d)}
function gid(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}
function pad(n){return n<10?'0'+n:''+n}

function getNow(){
var d=new Date();
var days=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
return{
ts:d.getTime(),
time:pad(d.getHours())+':'+pad(d.getMinutes()),
date:d.getFullYear()+'/'+pad(d.getMonth()+1)+'/'+pad(d.getDate()),
full:d.getFullYear()+'å¹´'+(d.getMonth()+1)+'æœˆ'+d.getDate()+'æ—¥ æ˜ŸæœŸ'+days[d.getDay()]+' '+pad(d.getHours())+':'+pad(d.getMinutes()),
hour:d.getHours()
}}

function smartDate(dateStr,ts){
if(!dateStr)return'';
var now=new Date();var today=now.getFullYear()+'/'+pad(now.getMonth()+1)+'/'+pad(now.getDate());
var y=new Date(now);y.setDate(y.getDate()-1);var yesterday=y.getFullYear()+'/'+pad(y.getMonth()+1)+'/'+pad(y.getDate());
if(dateStr===today)return'ä»Šå¤©';
if(dateStr===yesterday)return'æ˜¨å¤©';
return dateStr;
}

function shouldShowTime(cur,prev){
if(!prev)return true;
if(!cur.ts||!prev.ts)return cur.date!==prev.date;
return(cur.ts-prev.ts)>300000;
}

/* ========== å­˜å– ========== */
function sync(){S.apiUrl=($('fUrl').value||'').trim()||'https://api.openai.com/v1';S.apiKey=($('fKey').value||'').trim();S.model=($('fMod').value||'').trim()||'gpt-4o-mini';S.tmp=parseFloat($('fTmp').value)||.8;S.mtk=parseInt($('fMtk').value)||2048;S.mem=parseInt($('fMem').value)||30;if(S.mem<1)S.mem=1;S.cn=($('fCN').value||'').trim()||'è°¢è”šå®‰';S.un=($('fUN').value||'').trim()||'ç‡•ä¸–';S.cp=$('fCP').value||'';S.wb=$('fWB').value||''}

function save(){
try{var d={};KS.forEach(function(k){d[k]=S[k]});
// å›¾ç‰‡æ•°æ®å¤ªå¤§æ—¶è·³è¿‡ä¿å­˜imageData
var cleaned=JSON.parse(JSON.stringify(d));
cleaned.messages=cleaned.messages.map(function(m){var c=Object.assign({},m);if(c.imageData&&c.imageData.length>500000)delete c.imageData;return c});
localStorage.setItem('xwa5',JSON.stringify(cleaned))}catch(e){console.warn('save',e)}
}

function load(){try{var r=localStorage.getItem('xwa5');if(!r)return;var d=JSON.parse(r);KS.forEach(function(k){if(d[k]!==undefined)S[k]=d[k]})}catch(e){}}

/* ========== æ¸²æŸ“ ========== */
function esc(t){var d=document.createElement('div');d.textContent=t;return d.innerHTML.replace(/\n/g,'<br>')}
function mkAv(src,fb){var w=document.createElement('div');w.className='mav';if(src){var im=document.createElement('img');im.src=src;im.alt=fb;im.onerror=function(){this.remove();w.textContent=fb};w.appendChild(im)}else w.textContent=fb;return w}
function findStk(n){for(var i=0;i<S.stickers.length;i++)if(S.stickers[i].name===n)return S.stickers[i];return null}
function parseTr(t){var m=t.match(/^\[è½¬è´¦:([^:]+):([^\]]*)\]$/);return m?{a:m[1],n:m[2]||''}:null}
function parseStk(t){var m=t.match(/^\[è¡¨æƒ…:([^\]]+)\]$/);return m?m[1]:null}

function renderBub(msg){
var c=(msg.content||'').trim();
var tr=parseTr(c);if(tr){var cd=document.createElement('div');cd.className='tc';cd.innerHTML='<div class="tc-t"><span class="ic">ğŸ’°</span><span class="am">Â¥'+esc(tr.a)+'</span></div><div class="tc-b"><span class="lb">'+esc(tr.n||'è½¬è´¦')+'</span><span class="tg">å¾®ä¿¡è½¬è´¦</span></div>';return{el:cd,type:'transfer'}}
var sn=parseStk(c);if(sn){var sk=findStk(sn);if(sk){var ig=document.createElement('img');ig.className='si2';ig.src=sk.url;ig.alt=sn;ig.title=sn;ig.onerror=function(){this.replaceWith(document.createTextNode('[è¡¨æƒ…:'+sn+']'))};return{el:ig,type:'sticker'}}}
if(msg.type==='image'&&msg.imageUrl){var ii=document.createElement('img');ii.className='mimg';ii.src=msg.imageUrl;ii.alt='å›¾ç‰‡';ii.onclick=function(){window.open(msg.imageUrl,'_blank')};return{el:ii,type:'image'}}
if(msg.type==='sticker'&&msg.stickerUrl){var si=document.createElement('img');si.className='si2';si.src=msg.stickerUrl;si.alt=c;si.title=c;return{el:si,type:'sticker'}}
return null;
}

function render(animateFrom){
chatArea.innerHTML='';
var prev=null;
S.messages.forEach(function(m,idx){
if(shouldShowTime(m,prev)){
var dv=document.createElement('div');dv.className='td';
var label=smartDate(m.date,m.ts);
if(m.time)label+=' '+m.time;
dv.textContent=label;
chatArea.appendChild(dv);
}
var row=document.createElement('div');row.className='mr '+m.role;row.dataset.id=m.id;
if(animateFrom!==undefined&&idx>=animateFrom)row.classList.add('new-msg');
if(S.selMode){row.classList.add('selectable');if(S.selIds[m.id])row.classList.add('selected');(function(id){row.addEventListener('click',function(){togSel(id)})})(m.id)}
var isAi=m.role==='ai';
var av=mkAv(isAi?S.aiAv:S.usAv,(isAi?(S.cn||'è”š'):(S.un||'ç‡•')).charAt(0));
var wrap=document.createElement('div');wrap.className='mw';
var bub=document.createElement('div');bub.className='mb';
var sp=renderBub(m);
if(sp){if(sp.type==='sticker'||sp.type==='image')bub.className='mb '+(sp.type==='image'?'imb':'skb');bub.innerHTML='';bub.appendChild(sp.el)}
else bub.innerHTML=esc(m.content);
var tm=document.createElement('div');tm.className='mt';
if(m.role==='user'){
tm.innerHTML='<span class="read-dot">âœ“</span> '+esc(m.time||'');
}else{
tm.textContent=m.time||'';
}
wrap.appendChild(bub);wrap.appendChild(tm);row.appendChild(av);row.appendChild(wrap);chatArea.appendChild(row);
prev=m;
});
chatArea.scrollTop=chatArea.scrollHeight;
S.lastRendered=S.messages.length;
}

function addMsg(role,content,extra){
var n=getNow();var m={id:gid(),role:role,content:content,time:n.time,date:n.date,ts:n.ts};
if(extra)for(var k in extra)if(extra.hasOwnProperty(k))m[k]=extra[k];
S.messages.push(m);save();return m;
}

function addAndRender(role,content,extra){
var idx=S.messages.length;
addMsg(role,content,extra);
render(idx);
}

/* ========== æ‰“å­—çŠ¶æ€ ========== */
function setTyping(on){
$('topS').textContent=on?'å¯¹æ–¹æ­£åœ¨è¾“å…¥...':'åœ¨çº¿';
$('topS').className='top-s'+(on?' typing':'');
if(on)showTypBub();else hideTypBub();
}
function showTypBub(){hideTypBub();var row=document.createElement('div');row.className='mr ai';row.id='typR';var av=mkAv(S.aiAv,(S.cn||'è”š').charAt(0));var w=document.createElement('div');w.className='mw';var b=document.createElement('div');b.className='mb';b.innerHTML='<div class="ti"><span></span><span></span><span></span></div>';w.appendChild(b);row.appendChild(av);row.appendChild(w);chatArea.appendChild(row);chatArea.scrollTop=chatArea.scrollHeight}
function hideTypBub(){var t=$('typR');if(t)t.remove()}

/* ========== é¡¶éƒ¨&çŠ¶æ€ ========== */
function updTop(){$('topN').textContent=S.cn||'è°¢è”šå®‰';var ta=$('topAv');ta.innerHTML='';if(S.aiAv){var im=document.createElement('img');im.src=S.aiAv;im.onerror=function(){this.remove();ta.textContent=(S.cn||'è”š').charAt(0)};ta.appendChild(im)}else ta.textContent=(S.cn||'è”š').charAt(0);if(!S.isGen){$('topS').textContent=S.connected?'åœ¨çº¿':'æœªè¿æ¥';$('topS').className='top-s';$('topS').style.color=S.connected?'#4CAF50':''}}
function updConn(){$('cDot').className='dot '+(S.connected?'on':'off');$('cTxt').textContent=S.connected?'å·²è¿æ¥ Â· '+S.model:'æœªè¿æ¥';updTop()}
function updBdg(){$('pBdg').textContent=S.pc>0?S.pc:''}
function setIp(id,src,fb){var el=$(id);el.innerHTML='';if(src){var im=document.createElement('img');im.src=src;im.onerror=function(){this.remove();el.textContent=fb};el.appendChild(im)}else el.textContent=fb}
function fillForm(){$('fUrl').value=S.apiUrl;$('fKey').value=S.apiKey;$('fMod').value=S.model;$('fTmp').value=S.tmp;$('fMtk').value=S.mtk;$('fMem').value=S.mem;$('fCN').value=S.cn;$('fUN').value=S.un;$('fCP').value=S.cp;$('fWB').value=S.wb;$('cCnt').textContent=(S.cp||'').length+' å­—';$('wCnt').textContent=(S.wb||'').length+' å­—';$('mCntD').textContent=S.messages.length;setIp('aiPv',S.aiAv,'è”š');setIp('usPv',S.usAv,'ç‡•');setIp('bgPv',S.cBg,'æ— ');renderStkM()}
function updBg(){chatArea.style.backgroundImage=S.cBg?'url('+S.cBg+')':'none'}
function updAll(){fillForm();updTop();updConn();updBg();updBdg()}

/* ========== è¡¨æƒ…åŒ… ========== */
function renderStkM(){var c=$('stkManage');c.innerHTML='';$('stkCntD').textContent='('+S.stickers.length+')';if(!S.stickers.length){c.innerHTML='<div style="color:var(--tl);font-size:13px;padding:12px 0">æš‚æ— </div>';return}S.stickers.forEach(function(s,i){var d=document.createElement('div');d.className='smi2';var ig=document.createElement('img');ig.src=s.url;ig.alt=s.name;ig.onerror=function(){this.style.display='none'};var nm=document.createElement('span');nm.className='sn2';nm.textContent=s.name;var dl=document.createElement('button');dl.className='sdl2';dl.textContent='âœ•';(function(idx){dl.addEventListener('click',function(){S.stickers.splice(idx,1);save();renderStkM();toast('å·²åˆ é™¤')})})(i);d.appendChild(ig);d.appendChild(nm);d.appendChild(dl);c.appendChild(d)})}
function renderStkG(){var g=$('stkGrid');g.innerHTML='';if(!S.stickers.length){g.innerHTML='<div class="ske">æš‚æ— è¡¨æƒ…åŒ…</div>';return}S.stickers.forEach(function(s){var it=document.createElement('div');it.className='ski';it.title=s.name;var ig=document.createElement('img');ig.src=s.url;ig.alt=s.name;ig.onerror=function(){this.remove();it.textContent=s.name.charAt(0)};it.appendChild(ig);it.addEventListener('click',function(){addAndRender('user','[è¡¨æƒ…:'+s.name+']',{type:'sticker',stickerUrl:s.url});S.pc++;updBdg();$('stkPanel').classList.remove('active')});g.appendChild(it)})}

/* ========== API ========== */
function buildSys(){
var n=getNow();
var period='';var h=n.hour;
if(h>=5&&h<8)period='æ¸…æ™¨';else if(h>=8&&h<12)period='ä¸Šåˆ';else if(h>=12&&h<14)period='ä¸­åˆ';else if(h>=14&&h<18)period='ä¸‹åˆ';else if(h>=18&&h<21)period='å‚æ™š';else if(h>=21||h<1)period='æ·±å¤œ';else period='å‡Œæ™¨';
var ti='ã€å½“å‰æ—¶é—´ã€‘'+n.full+'ï¼ˆ'+period+'ï¼‰\nä½ æ­£å¤„äº'+period+'ï¼Œè¯·è‡ªç„¶åœ°åæ˜ è¿™ä¸ªæ—¶é—´æ®µçš„ç”Ÿæ´»çŠ¶æ€å’Œè¯­æ°”ã€‚\n\n';
var si='';if(S.stickers.length){si='ã€å¯ç”¨è¡¨æƒ…åŒ…ã€‘';S.stickers.forEach(function(s){si+='\n- '+s.name});si+='\nç”¨[è¡¨æƒ…:åç§°]å‘é€ï¼Œå•ç‹¬ä¸€æ¡ã€‚\n\n'}
var p=[ti];if(S.cp)p.push(S.cp);if(si)p.push(si);if(S.wb)p.push('---\n'+S.wb);
return p.join('\n\n').trim();
}

function buildCtx(extra){
var sys=buildSys();var msgs=[];
if(sys)msgs.push({role:'system',content:sys});
var c=Math.max(1,S.mem||30);var recent=S.messages.slice(-c);
recent.forEach(function(m){
if(m.type==='image'&&m.imageData){
msgs.push({role:'user',content:[{type:'text',text:m.content||'ï¼ˆç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼‰'},{type:'image_url',image_url:{url:m.imageData}}]});
}else{
var txt=m.content;
if(m.type==='sticker'){var sn=parseStk(txt);if(sn)txt='ï¼ˆç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…ï¼š'+sn+'ï¼‰'}
msgs.push({role:m.role==='user'?'user':'assistant',content:txt});
}
});
if(extra)msgs.push({role:'user',content:extra});
return msgs;
}

function apiH(){return{'Content-Type':'application/json','Authorization':'Bearer '+S.apiKey}}
function apiB(){return(S.apiUrl||'').replace(/\/+$/,'')}

async function callApi(msgs){
var url=apiB()+'/chat/completions';
var resp=await fetch(url,{method:'POST',headers:apiH(),body:JSON.stringify({model:S.model,messages:msgs,temperature:parseFloat(S.tmp)||.8,max_tokens:parseInt(S.mtk)||2048})});
if(!resp.ok){var et='';try{et=await resp.text()}catch(e){}throw new Error('HTTP '+resp.status+(et?': '+et.substring(0,200):''))}
var data=await resp.json();if(!data.choices||!data.choices[0])throw new Error('æ— æ•ˆå“åº”');
return data.choices[0].message.content;
}

function sleep(ms){return new Promise(function(r){setTimeout(r,ms)})}

function splitReply(r){
var parts=r.split(/\n*---\n*/).map(function(s){return s.trim()}).filter(Boolean);
if(!parts.length)parts=[r.trim()||'...'];
return parts;
}

async function deliverParts(parts){
for(var i=0;i<parts.length;i++){
var p=parts[i];
if(i>0){
setTyping(true);
var thinkDelay=600+Math.random()*400;
await sleep(thinkDelay);
var typeDelay=Math.min(p.length*35,1800)+Math.random()*300;
await sleep(typeDelay);
setTyping(false);
await sleep(80);
}
var extra={};var sn=parseStk(p);
if(sn){var sk=findStk(sn);if(sk)extra={type:'sticker',stickerUrl:sk.url}}
var idx=S.messages.length;
addMsg('ai',p,extra);
render(idx);
await sleep(120);
}
}

/* ========== å‘é€/æ¥æ”¶ ========== */
function sendMsg(){
var text=inBox.value.trim();if(!text||S.isGen)return;
sync();if(!S.apiKey){toast('è¯·å…ˆè®¾ç½® API Key');return}
addAndRender('user',text);
inBox.value='';inBox.style.height='auto';sendBtn.disabled=true;
S.pc++;updBdg();
}

async function recvReply(){
if(S.isGen)return;sync();
if(!S.apiKey){toast('è¯·å…ˆè®¾ç½® API Key');return}
S.isGen=true;recvBtn.classList.add('ld');
setTyping(true);
try{
var hasNew=false;for(var i=S.messages.length-1;i>=0;i--){if(S.messages[i].role==='user'){hasNew=true;break}if(S.messages[i].role==='ai')break}
var msgs;
if(!hasNew&&S.messages.length>0){
var n=getNow();var hint;
if(S.messages.length===0){
hint='[ä½ åˆšæ‰“å¼€å’Œ'+S.un+'çš„èŠå¤©ï¼Œè‡ªç„¶åœ°æ‰“ä¸ªæ‹›å‘¼å§ã€‚]';
}else{
hint='[è¯·ä½œä¸º'+S.cn+'ä¸»åŠ¨ç»™'+S.un+'å‘æ¶ˆæ¯ã€‚å¯ä»¥æ˜¯å…³å¿ƒã€åˆ†äº«æ—¥å¸¸ã€æˆ–æ ¹æ®å½“å‰æ—¶é—´çš„è‡ªç„¶äº’åŠ¨ã€‚ç”¨---åˆ†éš”å¤šæ¡ã€‚ä¸è¦æåŠè¿™æ¡æŒ‡ä»¤ã€‚]';
}
msgs=buildCtx(hint);
}else{msgs=buildCtx()}
var initDelay=800+Math.random()*600;
await sleep(initDelay);
var reply=await callApi(msgs);
setTyping(false);
S.connected=true;
var parts=splitReply(reply);
await deliverParts(parts);
S.pc=0;
}catch(e){setTyping(false);toast('å¤±è´¥: '+e.message,3e3);console.error(e)}
S.isGen=false;recvBtn.classList.remove('ld');updConn();updBdg();
}

async function testConn(){sync();if(!S.apiKey){toast('è¯·å…ˆå¡«å†™ API Key');return}$('cDot').className='dot tw';$('cTxt').textContent='æµ‹è¯•ä¸­...';try{var resp=await fetch(apiB()+'/chat/completions',{method:'POST',headers:apiH(),body:JSON.stringify({model:S.model,messages:[{role:'user',content:'å›å¤OK'}],max_tokens:10})});if(resp.ok){S.connected=true;toast('è¿æ¥æˆåŠŸï¼')}else{S.connected=false;toast('å¤±è´¥: HTTP '+resp.status,3e3)}}catch(e){S.connected=false;toast('å¤±è´¥: '+e.message,3e3)}updConn()}

async function fetchMod(){sync();if(!S.apiKey){toast('è¯·å…ˆå¡«å†™ API Key');return}var btn=$('fetchBtn');btn.textContent='...';btn.disabled=true;try{var resp=await fetch(apiB()+'/models',{headers:{'Authorization':'Bearer '+S.apiKey}});if(!resp.ok)throw new Error('HTTP '+resp.status);var data=await resp.json();var mods=data.data||data||[];if(Array.isArray(mods))mods=mods.map(function(m){return m.id||m}).filter(Boolean).sort();else mods=[];var list=$('modList');list.innerHTML='';list.style.display='block';if(!mods.length)list.innerHTML='<div class="mi" style="color:var(--tl)">æœªæ‰¾åˆ°</div>';else mods.forEach(function(m){var it=document.createElement('div');it.className='mi'+(m===S.model?' sel':'');it.textContent=m;it.addEventListener('click',function(){S.model=m;$('fMod').value=m;list.querySelectorAll('.mi').forEach(function(el){el.classList.remove('sel')});it.classList.add('sel');toast('å·²é€‰: '+m)});list.appendChild(it)});toast(mods.length+' ä¸ªæ¨¡å‹')}catch(e){toast('å¤±è´¥: '+e.message,3e3)}btn.textContent='æ‹‰å–';btn.disabled=false}

/* ========== é€‰æ‹©åˆ é™¤ ========== */
function togSelMode(){S.selMode=!S.selMode;S.selIds={};$('selBar').classList.toggle('active',S.selMode);$('inputArea').style.display=S.selMode?'none':'flex';$('selBtn').textContent=S.selMode?'âœ•':'â˜';$('selCnt').textContent='å·²é€‰ 0 æ¡';$('stkPanel').classList.remove('active');render()}
function togSel(id){if(S.selIds[id])delete S.selIds[id];else S.selIds[id]=true;$('selCnt').textContent='å·²é€‰ '+Object.keys(S.selIds).length+' æ¡';render()}
function delSel(){var c=Object.keys(S.selIds).length;if(!c){toast('è¯·å…ˆé€‰æ‹©');return}if(!confirm('åˆ é™¤ '+c+' æ¡ï¼Ÿ'))return;var ids=S.selIds;S.messages=S.messages.filter(function(m){return!ids[m.id]});S.selIds={};togSelMode();save();render();toast('å·²åˆ é™¤')}

/* ========== æ–‡ä»¶ ========== */
function handleImg(fid,cb){$(fid).addEventListener('change',function(e){var f=e.target.files[0];if(!f)return;if(f.size>5*1024*1024){toast('ä¸è¶…è¿‡5MB');e.target.value='';return}var r=new FileReader();r.onload=function(ev){cb(ev.target.result)};r.readAsDataURL(f);e.target.value=''})}
function sendImage(d){sync();if(!S.apiKey){toast('è¯·å…ˆè®¾ç½®API Key');return}addAndRender('user','[å›¾ç‰‡]',{type:'image',imageUrl:d,imageData:d});S.pc++;updBdg()}

function expData(){sync();var d={_type:'xwa_export',_ver:6,_date:new Date().toISOString()};KS.forEach(function(k){d[k]=S[k]});
d.messages=d.messages.map(function(m){var c=Object.assign({},m);if(c.imageData&&c.imageData.length>500000)c.imageData='[å›¾ç‰‡æ•°æ®è¿‡å¤§å·²çœç•¥]';return c});
var blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='è°¢è”šå®‰_'+getNow().date.replace(/\//g,'')+'.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);toast('å¯¼å‡ºæˆåŠŸ')}

function impData(file){var r=new FileReader();r.onload=function(ev){try{var d=JSON.parse(ev.target.result);if(!d._type||d._type.indexOf('xwa')<0){toast('æ ¼å¼ä¸å¯¹');return}if(!confirm('å¯¼å…¥å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®è®¤ï¼Ÿ'))return;KS.forEach(function(k){if(d[k]!==undefined)S[k]=d[k]});if(!S.stickers)S.stickers=[];save();updAll();render();toast('å¯¼å…¥æˆåŠŸ')}catch(e){toast('å¤±è´¥: '+e.message,3e3)}};r.readAsText(file)}

/* ========== äº‹ä»¶ ========== */
function initEv(){
sendBtn.addEventListener('click',sendMsg);
inBox.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg()}});
inBox.addEventListener('input',function(){sendBtn.disabled=!inBox.value.trim();inBox.style.height='auto';inBox.style.height=Math.min(inBox.scrollHeight,100)+'px'});
recvBtn.addEventListener('click',recvReply);
$('stkBtn').addEventListener('click',function(){if(S.selMode)return;var p=$('stkPanel');if(p.classList.contains('active'))p.classList.remove('active');else{renderStkG();p.classList.add('active')}});
$('stkClose').addEventListener('click',function(){$('stkPanel').classList.remove('active')});
$('imgBtn').addEventListener('click',function(){if(S.selMode)return;$('imgInput').click()});
$('imgInput').addEventListener('change',function(e){var f=e.target.files[0];if(!f)return;if(f.size>10*1024*1024){toast('ä¸è¶…è¿‡10MB');e.target.value='';return}var r=new FileReader();r.onload=function(ev){sendImage(ev.target.result)};r.readAsDataURL(f);e.target.value=''});
$('openSet').addEventListener('click',function(){sync();fillForm();setPanel.classList.add('active')});
$('closeSet').addEventListener('click',function(){setPanel.classList.remove('active')});
document.querySelectorAll('.tbn').forEach(function(b){b.addEventListener('click',function(){document.querySelectorAll('.tbn').forEach(function(x){x.classList.remove('active')});document.querySelectorAll('.tp3').forEach(function(x){x.classList.remove('active')});b.classList.add('active');$('tab-'+b.dataset.tab).classList.add('active')})});
$('eyeBtn').addEventListener('click',function(){var inp=$('fKey');inp.type=inp.type==='password'?'text':'password';this.textContent=inp.type==='password'?'ğŸ‘':'ğŸ™ˆ'});
$('saveApi').addEventListener('click',function(){sync();save();updConn();toast('å·²ä¿å­˜')});
$('testBtn').addEventListener('click',testConn);
$('fetchBtn').addEventListener('click',fetchMod);
$('fMem').addEventListener('change',function(){var v=parseInt(this.value);if(isNaN(v)||v<1)v=1;this.value=v;S.mem=v;save()});
$('fCP').addEventListener('input',function(){$('cCnt').textContent=this.value.length+' å­—'});
$('saveCh').addEventListener('click',function(){sync();save();updTop();toast('å·²ä¿å­˜')});
$('rstCh').addEventListener('click',function(){if(!confirm('æ¢å¤é»˜è®¤äººè®¾ï¼Ÿ'))return;S.cp=DC;S.cn='è°¢è”šå®‰';S.un='ç‡•ä¸–';fillForm();save();updTop();toast('å·²æ¢å¤')});
$('fWB').addEventListener('input',function(){$('wCnt').textContent=this.value.length+' å­—'});
$('saveW').addEventListener('click',function(){sync();save();toast('å·²ä¿å­˜')});
$('rstW').addEventListener('click',function(){if(!confirm('æ¢å¤é»˜è®¤ä¸–ç•Œä¹¦ï¼Ÿ'))return;S.wb=DW;$('fWB').value=DW;$('wCnt').textContent=DW.length+' å­—';save();toast('å·²æ¢å¤')});
$('addStk').addEventListener('click',function(){var url=($('stkUrl').value||'').trim();var name=($('stkName').value||'').trim();if(!url){toast('è¾“å…¥URL');return}if(!name){toast('è¾“å…¥åç§°');return}for(var i=0;i<S.stickers.length;i++)if(S.stickers[i].name===name){toast('åç§°å·²å­˜åœ¨');return}S.stickers.push({url:url,name:name});save();renderStkM();$('stkUrl').value='';$('stkName').value='';toast('å·²æ·»åŠ ')});
handleImg('aiF',function(d){S.aiAv=d;save();setIp('aiPv',d,'è”š');updTop();render()});
handleImg('usF',function(d){S.usAv=d;save();setIp('usPv',d,'ç‡•');render()});
handleImg('bgF',function(d){S.cBg=d;save();setIp('bgPv',d,'æ— ');updBg()});
$('clrAi').addEventListener('click',function(){S.aiAv='';save();setIp('aiPv','','è”š');updTop();render()});
$('clrUs').addEventListener('click',function(){S.usAv='';save();setIp('usPv','','ç‡•');render()});
$('clrBg').addEventListener('click',function(){S.cBg='';save();setIp('bgPv','','æ— ');updBg()});
$('saveLk').addEventListener('click',function(){save();updAll();render();toast('å·²ä¿å­˜')});
$('clrChat').addEventListener('click',function(){if(!confirm('æ¸…ç©ºæ‰€æœ‰å¯¹è¯ï¼Ÿ'))return;S.messages=[];S.pc=0;save();render();updBdg();$('mCntD').textContent='0';toast('å·²æ¸…ç©º')});
$('expBtn').addEventListener('click',expData);
$('impF').addEventListener('change',function(e){var f=e.target.files[0];if(f)impData(f);e.target.value=''});
$('rstAll').addEventListener('click',function(){if(!confirm('é‡ç½®æ‰€æœ‰æ•°æ®ï¼Ÿä¸å¯æ¢å¤ï¼'))return;if(!confirm('å†æ¬¡ç¡®è®¤ï¼'))return;localStorage.removeItem('xwa5');location.reload()});
$('selBtn').addEventListener('click',togSelMode);$('cancelSel').addEventListener('click',togSelMode);$('delSel').addEventListener('click',delSel);
chatArea.addEventListener('click',function(){$('stkPanel').classList.remove('active')});
}

function init(){load();if(!S.stickers)S.stickers=[];initEv();updAll();render()}
init();
</script>
</body>
</html>