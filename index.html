<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æˆ‘ä»¬çš„æ•…äº‹</title>
<style>
:root {
  --primary-color: #7a9a8a;
  --primary-dark: #5d7a6a;
  --primary-light: #a8c5b5;
  --primary-bg: #f0f5f2;
  --primary-bg2: #e5ebe8;
  --card-bg: rgba(255,255,255,0.92);
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.1);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.15);
  --radius-sm: 12px;
  --radius-md: 18px;
  --radius-lg: 24px;
}
[data-theme="red"] {
  --primary-color: #c9897a;
  --primary-dark: #a8685d;
  --primary-light: #e5b5a8;
  --primary-bg: #f8f0ee;
  --primary-bg2: #f0e5e2;
}
[data-theme="yellow"] {
  --primary-color: #b0a06a;
  --primary-dark: #8a7a44;
  --primary-light: #d5c58a;
  --primary-bg: #f8f5ea;
  --primary-bg2: #f0ebda;
}
[data-theme="white"] {
  --primary-color: #9a9a9a;
  --primary-dark: #707070;
  --primary-light: #c5c5c5;
  --primary-bg: #f8f8f8;
  --primary-bg2: #f0f0f0;
}
[data-theme="black"] {
  --primary-color: #6a6a6a;
  --primary-dark: #444444;
  --primary-light: #8a8a8a;
  --primary-bg: #ececec;
  --primary-bg2: #e0e0e0;
}
[data-theme="green"] {
  --primary-color: #7a9a8a;
  --primary-dark: #5d7a6a;
  --primary-light: #a8c5b5;
  --primary-bg: #f0f5f2;
  --primary-bg2: #e5ebe8;
}
[data-theme="blue"] {
  --primary-color: #7a8fa8;
  --primary-dark: #5d6f85;
  --primary-light: #a8bdd5;
  --primary-bg: #eef2f8;
  --primary-bg2: #e2e8f0;
}
[data-theme="purple"] {
  --primary-color: #9a82ab;
  --primary-dark: #755d8a;
  --primary-light: #c5aed5;
  --primary-bg: #f4f0f8;
  --primary-bg2: #eae5f0;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}
html, body {
  width: 100%;
  height: 100%;
  overflow-x: hidden;
}
body {
  font-family: -apple-system, "PingFang SC", "Microsoft YaHei", "Helvetica Neue", sans-serif;
  min-height: 100vh;
  color: #3d3d3d;
  line-height: 1.8;
  background-color: var(--primary-bg);
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  transition: background-color 0.4s;
}
.cover-page {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(160deg, var(--primary-bg) 0%, var(--primary-bg2) 50%, var(--primary-bg) 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9000;
  touch-action: pan-y;
  transition: transform 0.7s cubic-bezier(0.4, 0, 0.1, 1), opacity 0.7s ease;
  overflow: hidden;
}
.cover-page.hiding {
  transform: translateY(-100%);
  opacity: 0;
}
.cover-page.hidden {
  display: none;
}
.particles-canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}
.particle-switcher {
  position: absolute;
  top: 20px;
  right: 15px;
  display: flex;
  gap: 6px;
  z-index: 10;
  flex-wrap: wrap;
  justify-content: flex-end;
  max-width: 200px;
}
.particle-btn {
  background: var(--card-bg);
  border: 2px solid transparent;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-sm);
}
.particle-btn.active {
  background: var(--primary-color);
  border-color: white;
  box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  transform: scale(1.1);
}
.cover-title {
  font-size: 46px;
  font-weight: 300;
  letter-spacing: 6px;
  color: var(--primary-dark);
  margin-bottom: 16px;
  text-shadow: 0 2px 8px rgba(0,0,0,0.06);
  text-align: center;
  padding: 0 20px;
  position: relative;
  z-index: 5;
}
.cover-subtitle {
  font-size: 15px;
  color: var(--primary-color);
  margin-bottom: 80px;
  opacity: 0.8;
  letter-spacing: 3px;
  position: relative;
  z-index: 5;
}
.cover-author {
  position: absolute;
  bottom: 120px;
  left: 30px;
  font-size: 13px;
  color: var(--primary-color);
  opacity: 0.5;
  z-index: 5;
  letter-spacing: 1px;
}
.swipe-area {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 180px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 5;
}
.swipe-hint {
  display: flex;
  flex-direction: column;
  align-items: center;
  color: var(--primary-color);
  animation: floatUp 2.5s ease-in-out infinite;
}
.swipe-arrow {
  width: 22px;
  height: 22px;
  border-left: 2.5px solid var(--primary-color);
  border-top: 2.5px solid var(--primary-color);
  transform: rotate(45deg);
  margin-bottom: 14px;
  opacity: 0.7;
}
.swipe-text {
  font-size: 13px;
  opacity: 0.6;
  letter-spacing: 2px;
}
.swipe-bar {
  position: absolute;
  bottom: 25px;
  left: 50%;
  transform: translateX(-50%);
  width: 45px;
  height: 4px;
  background: var(--primary-color);
  border-radius: 2px;
  opacity: 0.35;
}
@keyframes floatUp {
  0%, 100% { transform: translateY(0); opacity: 0.7; }
  50% { transform: translateY(-14px); opacity: 1; }
}
.loading-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(160deg, var(--primary-bg) 0%, var(--primary-bg2) 100%);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 1;
  transition: opacity 0.5s ease;
}
.loading-overlay.show { display: flex; }
.loading-overlay.hiding { opacity: 0; }
.loading-title {
  font-size: 42px;
  font-weight: 300;
  color: var(--primary-dark);
  margin-bottom: 16px;
  letter-spacing: 4px;
}
.loading-text {
  font-size: 14px;
  color: var(--primary-color);
  letter-spacing: 1px;
}
.loading-dots::after {
  content: '';
  animation: loadingDots 1.5s infinite;
}
@keyframes loadingDots {
  0%, 20% { content: ''; }
  40% { content: '.'; }
  60% { content: '..'; }
  80%, 100% { content: '...'; }
}
.author-mark {
  position: fixed;
  font-size: 11px;
  color: var(--primary-color);
  opacity: 0.4;
  z-index: 50;
  pointer-events: none;
  letter-spacing: 1px;
}
.author-mark.top-left { top: 12px; left: 12px; }
.author-mark.bottom-right { bottom: 68px; right: 12px; }
.main-page { display: none; }
.main-page.show { display: block; }
.top-controls {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 50;
  display: none;
  gap: 8px;
}
.top-controls.show { display: flex; }
.ctrl-btn {
  background: var(--card-bg);
  border: none;
  padding: 8px 14px;
  border-radius: 22px;
  font-size: 12px;
  color: var(--primary-dark);
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  transition: transform 0.2s, box-shadow 0.2s;
  backdrop-filter: blur(10px);
}
.ctrl-btn:active {
  transform: scale(0.94);
  box-shadow: var(--shadow-md);
}
.theme-btn {
  width: 38px;
  height: 38px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 17px;
  border-radius: 50%;
}
</style>
<style>
/* ===== éŸ³ä¹æ’­æ”¾å™¨ ===== */
.music-player {
  background: var(--card-bg);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  margin-bottom: 22px;
  box-shadow: var(--shadow-md);
  display: flex;
  align-items: center;
  gap: 18px;
  backdrop-filter: blur(10px);
}
.disc-container {
  position: relative;
  width: 72px;
  height: 72px;
  flex-shrink: 0;
}
.disc {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  background: conic-gradient(from 0deg, #1a1a1a, #333, #1a1a1a, #2a2a2a, #1a1a1a);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 16px rgba(0,0,0,0.25), inset 0 0 15px rgba(0,0,0,0.3);
  position: relative;
  overflow: hidden;
}
.disc::before {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  background: repeating-radial-gradient(
    circle at center,
    transparent 0px, transparent 3px,
    rgba(255,255,255,0.02) 3px, rgba(255,255,255,0.02) 5px
  );
}
.disc.playing {
  animation: discRotate 6s linear infinite;
}
@keyframes discRotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
.disc-center {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #f0f0f0;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
  z-index: 2;
  cursor: pointer;
  border: 2px solid #e0e0e0;
  transition: border-color 0.3s;
}
.disc-center:active {
  border-color: var(--primary-color);
}
.disc-center img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.disc-center .disc-placeholder {
  font-size: 11px;
  color: #aaa;
}
.music-info {
  flex: 1;
  min-width: 0;
}
.music-title {
  font-size: 14px;
  color: var(--primary-dark);
  margin-bottom: 10px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 500;
}
.music-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}
.music-btn {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  border: none;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  color: white;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  transition: transform 0.2s;
}
.music-btn:active {
  transform: scale(0.92);
}
.music-btn.small {
  width: 28px;
  height: 28px;
  font-size: 10px;
  background: var(--primary-light);
  box-shadow: none;
}
.music-progress {
  flex: 1;
  height: 4px;
  background: #e8e8e8;
  border-radius: 2px;
  overflow: hidden;
  cursor: pointer;
  position: relative;
}
.music-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-light) 0%, var(--primary-color) 100%);
  width: 0%;
  border-radius: 2px;
  transition: width 0.2s linear;
}
.music-time {
  font-size: 11px;
  color: #aaa;
  min-width: 35px;
  text-align: right;
}
.music-list-btn {
  background: none;
  border: 1px solid var(--primary-light);
  padding: 5px 14px;
  border-radius: 16px;
  font-size: 12px;
  color: var(--primary-color);
  cursor: pointer;
  transition: all 0.3s;
}
.music-list-btn:active {
  background: var(--primary-bg);
}
/* ===== éŸ³ä¹åˆ—è¡¨å¼¹çª— ===== */
.overlay-modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.45);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}
.overlay-modal.open {
  display: flex;
}
.overlay-modal-content {
  background: white;
  border-radius: var(--radius-lg);
  padding: 24px;
  width: 90%;
  max-width: 380px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: modalFadeIn 0.3s ease;
}
@keyframes modalFadeIn {
  from { opacity: 0; transform: translateY(20px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.overlay-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
  padding-bottom: 12px;
  border-bottom: 1px solid #f0f0f0;
}
.overlay-modal-header h3 {
  font-size: 17px;
  color: var(--primary-dark);
  font-weight: 600;
}
.overlay-modal-close {
  background: #f5f5f5;
  border: none;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  font-size: 18px;
  color: #999;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}
.overlay-modal-close:active {
  background: #e8e8e8;
}
.music-item {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  background: var(--primary-bg);
  gap: 10px;
  transition: all 0.2s;
}
.music-item.active {
  background: var(--primary-color);
  color: white;
}
.music-item-index {
  font-size: 13px;
  font-weight: 600;
  opacity: 0.5;
  width: 20px;
  text-align: center;
}
.music-item.active .music-item-index { opacity: 0.8; }
.music-item-name {
  flex: 1;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.music-item-actions {
  display: flex;
  gap: 6px;
}
.music-item-btn {
  background: none;
  border: none;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #999;
  transition: background 0.2s;
}
.music-item-btn:active {
  background: rgba(0,0,0,0.1);
}
.music-item.active .music-item-btn { color: rgba(255,255,255,0.7); }
.music-add-btn {
  width: 100%;
  padding: 16px;
  border: 2px dashed var(--primary-light);
  border-radius: var(--radius-sm);
  background: none;
  color: var(--primary-color);
  font-size: 14px;
  cursor: pointer;
  margin-top: 8px;
  transition: border-color 0.3s, background 0.3s;
}
.music-add-btn:active {
  background: var(--primary-bg);
  border-color: var(--primary-color);
}
.music-add-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
</style>
<style>
/* ===== ä¸»å®¹å™¨ ===== */
.container {
  max-width: 500px;
  margin: 0 auto;
  padding: 16px;
  padding-top: 50px;
  padding-bottom: 100px;
}
.header {
  text-align: center;
  padding: 36px 20px 28px;
  border-radius: var(--radius-lg);
  margin-bottom: 16px;
  box-shadow: var(--shadow-md);
  background: var(--card-bg);
  background-size: cover;
  background-position: center;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
}
.header-bg-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(255,255,255,0.75);
  border: none;
  padding: 5px 12px;
  border-radius: 16px;
  font-size: 11px;
  color: var(--primary-dark);
  cursor: pointer;
  backdrop-filter: blur(4px);
  z-index: 2;
}
.header h1 {
  font-size: 26px;
  color: var(--primary-dark);
  margin-bottom: 8px;
  font-weight: 500;
  letter-spacing: 2px;
  position: relative;
  z-index: 1;
}
.header p {
  color: var(--primary-color);
  font-size: 14px;
  position: relative;
  z-index: 1;
  letter-spacing: 1px;
}
.editable {
  outline: none;
  border: none;
  transition: background 0.3s, padding 0.3s;
  border-radius: 6px;
}
.editable:focus {
  background: rgba(122,154,138,0.12);
  padding: 2px 6px;
}
/* ===== å¼•è¨€å¡ç‰‡ ===== */
.quote-box {
  background: linear-gradient(145deg, var(--primary-bg) 0%, var(--primary-bg2) 100%);
  border-radius: var(--radius-md);
  padding: 28px 24px;
  margin-bottom: 20px;
  text-align: center;
  position: relative;
  box-shadow: var(--shadow-sm);
}
.quote-box::before {
  content: '"';
  font-size: 54px;
  color: var(--primary-color);
  opacity: 0.2;
  position: absolute;
  top: 8px;
  left: 22px;
  font-family: Georgia, serif;
  line-height: 1;
}
.quote-box p {
  font-size: 15px;
  color: var(--primary-dark);
  font-style: italic;
  position: relative;
  z-index: 1;
  line-height: 1.9;
}
.quote-box .author {
  margin-top: 12px;
  font-size: 13px;
  color: var(--primary-color);
  opacity: 0.8;
}
/* ===== ç¬”è®°æœ¬ ===== */
.notebook {
  background: var(--card-bg);
  border-radius: var(--radius-md);
  padding: 22px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
  border-left: 4px solid var(--primary-color);
  backdrop-filter: blur(10px);
}
.notebook-title {
  font-size: 17px;
  color: var(--primary-dark);
  margin-bottom: 14px;
  padding-bottom: 10px;
  border-bottom: 1px dashed var(--primary-light);
  font-weight: 500;
}
.notebook-content {
  font-size: 14px;
  min-height: 60px;
  line-height: 2;
}
.notebook-date {
  font-size: 12px;
  color: var(--primary-light);
  margin-top: 14px;
  text-align: right;
}
/* ===== ç…§ç‰‡å¡ ===== */
.section-title {
  color: var(--primary-dark);
  margin: 28px 0 18px;
  font-size: 19px;
  font-weight: 500;
  letter-spacing: 1px;
}
.photo-card {
  background: var(--card-bg);
  border-radius: var(--radius-lg);
  overflow: hidden;
  margin-bottom: 22px;
  box-shadow: var(--shadow-md);
}
.photo-wrapper {
  position: relative;
  cursor: pointer;
  overflow: hidden;
}
.photo-wrapper img {
  width: 100%;
  height: 220px;
  object-fit: cover;
  display: block;
  background: linear-gradient(135deg, #e8e8e8 0%, #f5f5f5 100%);
  transition: transform 0.3s;
}
.photo-wrapper:active img { transform: scale(1.02); }
.photo-wrapper .upload-hint {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(93,122,106,0.65);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  opacity: 0;
  transition: opacity 0.3s;
  backdrop-filter: blur(2px);
}
.photo-wrapper:hover .upload-hint,
.photo-wrapper:active .upload-hint { opacity: 1; }
.upload-hint span { font-size: 36px; margin-bottom: 8px; }
.photo-card .caption {
  padding: 18px 20px;
  text-align: center;
}
.photo-card .caption h3 {
  font-size: 15px;
  color: var(--primary-dark);
  margin-bottom: 6px;
  font-weight: 500;
}
.photo-card .caption p {
  font-size: 13px;
  color: #999;
}
input[type="file"] { display: none; }
/* ===== è®¡æ—¥å¡ ===== */
.calendar-card {
  background: linear-gradient(140deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  border-radius: var(--radius-lg);
  padding: 28px 24px;
  margin-bottom: 22px;
  text-align: center;
  color: white;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}
.calendar-card::before {
  content: '';
  position: absolute;
  top: -30px;
  right: -30px;
  width: 100px;
  height: 100px;
  background: rgba(255,255,255,0.08);
  border-radius: 50%;
}
.calendar-card::after {
  content: '';
  position: absolute;
  bottom: -20px;
  left: -20px;
  width: 70px;
  height: 70px;
  background: rgba(255,255,255,0.05);
  border-radius: 50%;
}
.calendar-card .days-count {
  font-size: 52px;
  font-weight: 200;
  margin: 12px 0;
  letter-spacing: 2px;
}
.calendar-card .days-label {
  font-size: 14px;
  opacity: 0.9;
  letter-spacing: 2px;
}
.calendar-card .start-date {
  font-size: 12px;
  opacity: 0.65;
  margin-top: 10px;
}
.calendar-card .date-picker {
  margin-top: 14px;
}
.calendar-card .date-picker input {
  background: rgba(255,255,255,0.18);
  border: 1px solid rgba(255,255,255,0.3);
  padding: 8px 16px;
  border-radius: 20px;
  color: white;
  font-size: 14px;
  outline: none;
  backdrop-filter: blur(4px);
}
.calendar-card .date-picker input::-webkit-calendar-picker-indicator {
  filter: invert(1);
}
</style>
<style>
/* ===== ç›¸å†Œ ===== */
.album-book {
  background: linear-gradient(145deg, #8b7355 0%, #6b5344 100%);
  border-radius: var(--radius-sm);
  padding: 18px;
  margin-bottom: 22px;
  box-shadow: var(--shadow-lg);
  cursor: pointer;
  transition: transform 0.3s;
}
.album-book:active { transform: scale(0.97); }
.album-cover {
  background: linear-gradient(145deg, #a08060 0%, #8b7355 100%);
  border-radius: 8px;
  padding: 35px 20px;
  text-align: center;
  border: 2px solid rgba(196,168,130,0.6);
  position: relative;
}
.album-cover h2 {
  color: #f5e6d3;
  font-size: 22px;
  margin-bottom: 8px;
  font-weight: 400;
  letter-spacing: 4px;
}
.album-cover p { color: #e8d5c4; font-size: 13px; }
.album-cover .book-spine {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 12px;
  background: linear-gradient(90deg, #4a3525 0%, #6b5344 100%);
  border-radius: 8px 0 0 8px;
}
/* ===== å¯¼èˆªå¡ç‰‡ ===== */
.nav-cards {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 14px;
  margin-bottom: 22px;
}
.nav-card {
  background: var(--card-bg);
  border-radius: var(--radius-md);
  padding: 22px 16px;
  text-align: center;
  box-shadow: var(--shadow-sm);
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  backdrop-filter: blur(10px);
}
.nav-card:active {
  transform: translateY(-3px);
  box-shadow: var(--shadow-md);
}
.nav-card .icon { font-size: 32px; margin-bottom: 10px; }
.nav-card h3 {
  color: var(--primary-dark);
  font-size: 15px;
  margin-bottom: 4px;
  font-weight: 500;
}
.nav-card p { color: #aaa; font-size: 12px; }
/* ===== å…¨å±å¼¹çª— ===== */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 1000;
  overflow-y: auto;
}
.modal.open { display: block; }
.modal-container {
  max-width: 500px;
  margin: 0 auto;
  min-height: 100vh;
  background: linear-gradient(160deg, var(--primary-bg) 0%, var(--primary-bg2) 100%);
}
.modal-header {
  background: var(--card-bg);
  padding: 14px 18px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 10;
  box-shadow: var(--shadow-sm);
  backdrop-filter: blur(15px);
}
.modal-header h3 {
  font-size: 17px;
  color: var(--primary-dark);
  font-weight: 600;
}
.close-modal {
  background: #f5f5f5;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 20px;
  color: #999;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.close-modal:active { background: #e8e8e8; }
.modal-content {
  padding: 18px;
  padding-bottom: 30px;
}
/* ç›¸å†Œå¼¹çª— */
.album-modal .modal-container {
  max-width: 100%;
  background: #1a1a1a;
  background-size: cover;
  background-position: center;
}
.album-modal .modal-header {
  background: rgba(255,255,255,0.92);
}
.album-modal .header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}
.album-modal .album-bg-btn {
  background: var(--primary-bg);
  border: none;
  padding: 6px 14px;
  border-radius: 16px;
  font-size: 12px;
  color: var(--primary-dark);
  cursor: pointer;
}
.album-modal .modal-content {
  padding: 24px 18px 100px;
  min-height: calc(100vh - 60px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
}
.album-page {
  display: none;
  width: 100%;
  max-width: 320px;
}
.album-page.active { display: block; }
.polaroid {
  background: white;
  padding: 10px 10px 40px;
  margin-bottom: 18px;
  box-shadow: 0 4px 18px rgba(0,0,0,0.25);
  position: relative;
  cursor: pointer;
  transition: transform 0.3s;
}
.polaroid:nth-child(odd) { transform: rotate(-1.5deg); }
.polaroid:nth-child(even) { transform: rotate(1.2deg); }
.polaroid:active { transform: rotate(0deg) scale(1.02) !important; }
.polaroid img {
  width: 100%;
  height: 170px;
  object-fit: cover;
  display: block;
  background: #f0f0f0;
}
.polaroid .upload-overlay {
  position: absolute;
  top: 10px; left: 10px; right: 10px; bottom: 40px;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 32px;
  opacity: 0;
  transition: opacity 0.3s;
  backdrop-filter: blur(2px);
}
.polaroid:hover .upload-overlay,
.polaroid:active .upload-overlay { opacity: 1; }
.album-nav {
  position: fixed;
  bottom: 28px;
  left: 0; right: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 24px;
  z-index: 100;
}
.album-nav .nav-btn {
  background: rgba(255,255,255,0.92);
  border: none;
  width: 46px;
  height: 46px;
  border-radius: 50%;
  font-size: 16px;
  color: var(--primary-dark);
  cursor: pointer;
  box-shadow: var(--shadow-md);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
}
.album-nav .nav-btn:active { transform: scale(0.92); }
.album-nav .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.album-nav .page-indicator {
  background: rgba(255,255,255,0.92);
  padding: 8px 20px;
  border-radius: 20px;
  font-size: 13px;
  color: var(--primary-dark);
  box-shadow: var(--shadow-sm);
}
</style>
<style>
/* ===== è®¸æ„¿ç“¶ ===== */
.wish-bottle-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px;
  margin-bottom: 20px;
}
.wish-bottle {
  background: linear-gradient(180deg, rgba(220,240,255,0.5) 0%, rgba(180,220,255,0.6) 100%);
  border-radius: 16px 16px 28px 28px;
  padding: 18px 12px;
  text-align: center;
  position: relative;
  min-height: 115px;
  cursor: pointer;
  border: 2px solid rgba(180,220,255,0.5);
  transition: transform 0.3s, box-shadow 0.3s;
  box-shadow: var(--shadow-sm);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.wish-bottle:active { transform: scale(0.95); }
.wish-bottle::before {
  content: '';
  position: absolute;
  top: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 26px;
  height: 12px;
  background: linear-gradient(180deg, #a08060 0%, #8b7355 100%);
  border-radius: 4px 4px 2px 2px;
}
.wish-bottle .bottle-icon { font-size: 28px; margin-bottom: 6px; }
.wish-bottle .bottle-status {
  font-size: 11px;
  color: #666;
  line-height: 1.4;
}
.wish-bottle.locked .bottle-status { color: var(--primary-color); }
.wish-bottle.ready {
  animation: bottleGlow 2s ease-in-out infinite;
  border-color: #ffd700;
  background: linear-gradient(180deg, rgba(255,250,220,0.6) 0%, rgba(255,235,180,0.7) 100%);
}
@keyframes bottleGlow {
  0%, 100% { box-shadow: 0 0 12px rgba(255,215,0,0.2); }
  50% { box-shadow: 0 0 22px rgba(255,215,0,0.5); }
}
.add-wish-bottle {
  background: rgba(255,255,255,0.5);
  border: 2px dashed var(--primary-light);
  border-radius: 16px 16px 28px 28px;
  padding: 18px 12px;
  text-align: center;
  min-height: 115px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--primary-color);
  transition: border-color 0.3s;
}
.add-wish-bottle:active { border-color: var(--primary-color); }
.add-wish-bottle span { font-size: 26px; margin-bottom: 4px; }
.add-wish-bottle p { font-size: 12px; }
/* è®¸æ„¿å¼¹çª—å†…å®¹ */
.wish-modal-body h3 {
  text-align: center;
  color: var(--primary-dark);
  margin-bottom: 20px;
  font-size: 18px;
  font-weight: 500;
}
.wish-modal-body textarea {
  width: 100%;
  height: 110px;
  border: 1.5px solid #e8e8e8;
  border-radius: var(--radius-sm);
  padding: 14px;
  font-size: 14px;
  resize: none;
  margin-bottom: 16px;
  font-family: inherit;
  line-height: 1.8;
  transition: border-color 0.3s;
}
.wish-modal-body textarea:focus {
  outline: none;
  border-color: var(--primary-color);
}
.wish-modal-body label {
  display: block;
  font-size: 13px;
  color: #888;
  margin-bottom: 8px;
}
.wish-modal-body input[type="date"] {
  width: 100%;
  padding: 10px 14px;
  border: 1.5px solid #e8e8e8;
  border-radius: var(--radius-sm);
  font-size: 14px;
  margin-bottom: 20px;
  font-family: inherit;
  color: #555;
}
.wish-modal-body input[type="date"]:focus {
  outline: none;
  border-color: var(--primary-color);
}
.btn-row {
  display: flex;
  gap: 10px;
}
.btn-primary {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 14px;
  cursor: pointer;
  font-family: inherit;
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  color: white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.btn-primary:active { transform: scale(0.97); }
.btn-secondary {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 14px;
  cursor: pointer;
  font-family: inherit;
  background: #f0f0f0;
  color: #666;
  transition: background 0.2s;
}
.btn-secondary:active { background: #e5e5e5; }
/* æ„¿æœ›æŸ¥çœ‹ */
.wish-view-body { text-align: center; }
.wish-view-body .wish-text {
  font-size: 15px;
  color: var(--primary-dark);
  padding: 22px;
  background: var(--primary-bg);
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
  line-height: 1.9;
  text-align: left;
}
.wish-view-body .wish-date {
  font-size: 12px;
  color: #aaa;
  margin-bottom: 20px;
}
/* ===== å¿ƒæƒ…æ›²çº¿ ===== */
.mood-chart-container {
  background: var(--card-bg);
  border-radius: var(--radius-md);
  padding: 20px;
  box-shadow: var(--shadow-sm);
}
.mood-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
}
.mood-header h4 {
  color: var(--primary-dark);
  font-size: 16px;
  font-weight: 500;
}
.mood-page-info {
  font-size: 12px;
  color: #aaa;
  background: var(--primary-bg);
  padding: 4px 12px;
  border-radius: 12px;
}
.mood-legend {
  display: flex;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 14px;
}
.mood-legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  color: #888;
}
.mood-legend-color {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}
.mood-scroll-wrapper {
  overflow-x: auto;
  margin-bottom: 14px;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 5px;
}
.mood-scroll-wrapper::-webkit-scrollbar { height: 3px; }
.mood-scroll-wrapper::-webkit-scrollbar-track { background: #f0f0f0; border-radius: 2px; }
.mood-scroll-wrapper::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 2px; }
.mood-chart {
  display: flex;
  align-items: flex-end;
  height: 190px;
  min-width: max-content;
  padding: 8px 4px;
  gap: 6px;
}
.mood-bar {
  width: 28px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.mood-bar-fill {
  width: 18px;
  border-radius: 9px 9px 4px 4px;
  transition: height 0.4s ease;
  min-height: 4px;
}
.mood-bar-fill.mood-1 { background: linear-gradient(180deg, #ef9a9a, #e57373); }
.mood-bar-fill.mood-2 { background: linear-gradient(180deg, #ffcc80, #ffb74d); }
.mood-bar-fill.mood-3 { background: linear-gradient(180deg, #fff59d, #fff176); }
.mood-bar-fill.mood-4 { background: linear-gradient(180deg, #c5e1a5, #aed581); }
.mood-bar-fill.mood-5 { background: linear-gradient(180deg, #81d4fa, #4fc3f7); }
.mood-bar-date {
  font-size: 9px;
  color: #bbb;
  margin-top: 6px;
  writing-mode: vertical-rl;
  text-orientation: mixed;
  height: 38px;
}
.mood-pages-nav {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 12px;
  margin-bottom: 14px;
}
.mood-page-btn {
  padding: 7px 16px;
  border: 1.5px solid var(--primary-light);
  background: white;
  border-radius: 18px;
  font-size: 12px;
  color: var(--primary-color);
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
}
.mood-page-btn.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}
.mood-page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.mood-add-btn {
  width: 100%;
  padding: 13px;
  background: linear-gradient(135deg, var(--primary-bg) 0%, var(--primary-bg2) 100%);
  border: none;
  border-radius: var(--radius-sm);
  color: var(--primary-color);
  font-size: 14px;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s;
}
.mood-add-btn:active { background: var(--primary-bg2); }
.mood-add-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.mood-selector {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 18px 0;
}
.mood-option {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 3px solid transparent;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-sm);
}
.mood-option:active,
.mood-option.selected {
  transform: scale(1.2);
  border-color: var(--primary-color);
  box-shadow: var(--shadow-md);
}
.mood-option[data-mood="1"] { background: #ffebee; }
.mood-option[data-mood="2"] { background: #fff3e0; }
.mood-option[data-mood="3"] { background: #fffde7; }
.mood-option[data-mood="4"] { background: #f1f8e9; }
.mood-option[data-mood="5"] { background: #e1f5fe; }
</style>
<style>
/* ===== ä¾¿ç­¾å¢™ ===== */
.sticky-wall {
  background: linear-gradient(145deg, #d4a574 0%, #c4956a 100%);
  border-radius: var(--radius-md);
  padding: 18px;
  margin-bottom: 22px;
  min-height: 180px;
  box-shadow: inset 0 2px 10px rgba(0,0,0,0.1), var(--shadow-sm);
}
.sticky-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.sticky-note {
  width: calc(50% - 5px);
  min-height: 95px;
  padding: 12px;
  border-radius: 4px;
  box-shadow: 2px 3px 8px rgba(0,0,0,0.15);
  position: relative;
  font-size: 13px;
  transition: transform 0.2s;
}
.sticky-note:active { transform: scale(0.98); }
.sticky-note.yellow { background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%); }
.sticky-note.pink { background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); }
.sticky-note.blue { background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%); }
.sticky-note.green { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); }
.sticky-note .delete-sticky {
  position: absolute;
  top: 4px; right: 6px;
  background: none;
  border: none;
  color: rgba(0,0,0,0.25);
  cursor: pointer;
  font-size: 16px;
  transition: color 0.2s;
}
.sticky-note .delete-sticky:active { color: rgba(0,0,0,0.5); }
.sticky-note .sticky-text {
  outline: none;
  min-height: 55px;
  line-height: 1.7;
}
.add-sticky-btn {
  width: calc(50% - 5px);
  min-height: 95px;
  border: 2px dashed rgba(139,105,20,0.4);
  border-radius: 4px;
  background: rgba(255,255,255,0.25);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: rgba(139,105,20,0.7);
  font-size: 14px;
  transition: background 0.2s;
}
.add-sticky-btn:active { background: rgba(255,255,255,0.4); }
/* ===== æ—¶é—´çº¿ ===== */
.timeline {
  position: relative;
  padding-left: 28px;
}
.timeline::before {
  content: "";
  position: absolute;
  left: 7px; top: 0; bottom: 0;
  width: 2px;
  background: linear-gradient(180deg, var(--primary-color) 0%, var(--primary-light) 100%);
}
.timeline-item {
  position: relative;
  margin-bottom: 22px;
  background: var(--card-bg);
  padding: 18px;
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-sm);
}
.timeline-item::before {
  content: "";
  position: absolute;
  left: -25px; top: 22px;
  width: 10px;
  height: 10px;
  background: var(--primary-color);
  border-radius: 50%;
  border: 3px solid var(--primary-bg);
  box-shadow: 0 0 0 2px var(--primary-color);
}
.timeline-item .date {
  font-size: 12px;
  color: var(--primary-color);
  margin-bottom: 6px;
}
.timeline-item .title {
  font-size: 15px;
  color: #3d3d3d;
  margin-bottom: 8px;
  font-weight: 500;
}
.timeline-item .desc {
  font-size: 13px;
  color: #888;
  line-height: 1.8;
}
.timeline-item .delete-item {
  position: absolute;
  top: 8px; right: 10px;
  background: none;
  border: none;
  color: #ddd;
  cursor: pointer;
  font-size: 18px;
}
.timeline-item .delete-item:active { color: #999; }
.add-item-btn {
  background: var(--card-bg);
  border: 2px dashed var(--primary-light);
  border-radius: var(--radius-sm);
  padding: 28px;
  text-align: center;
  cursor: pointer;
  color: var(--primary-color);
  margin-left: 28px;
  transition: border-color 0.3s;
}
.add-item-btn:active { border-color: var(--primary-color); }
.add-item-btn span {
  font-size: 28px;
  display: block;
  margin-bottom: 8px;
}
/* ===== ç¬”è®°æœ¬æ¡ç›® ===== */
.notebook-entry {
  background: var(--card-bg);
  border-radius: var(--radius-md);
  padding: 22px;
  margin-bottom: 18px;
  box-shadow: var(--shadow-sm);
  border-left: 4px solid var(--primary-color);
}
.notebook-entry .entry-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 14px;
}
.notebook-entry .entry-date {
  font-size: 12px;
  color: var(--primary-color);
  background: var(--primary-bg);
  padding: 4px 12px;
  border-radius: 14px;
}
.notebook-entry .delete-entry {
  background: none;
  border: none;
  color: #ddd;
  cursor: pointer;
  font-size: 18px;
}
.notebook-entry .delete-entry:active { color: #999; }
.notebook-entry .entry-title {
  font-size: 17px;
  color: var(--primary-dark);
  margin-bottom: 14px;
  padding-bottom: 10px;
  border-bottom: 1px dashed var(--primary-light);
  font-weight: 500;
}
.notebook-entry .entry-content {
  font-size: 14px;
  min-height: 80px;
  white-space: pre-wrap;
  line-height: 2;
}
.word-count {
  font-size: 11px;
  color: #ccc;
  text-align: right;
  margin-top: 10px;
}
/* ===== åº•éƒ¨æ  ===== */
.bottom-bar {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--card-bg);
  padding: 12px 20px;
  padding-bottom: max(12px, env(safe-area-inset-bottom));
  box-shadow: 0 -2px 15px rgba(0,0,0,0.08);
  display: none;
  justify-content: center;
  gap: 12px;
  z-index: 100;
  backdrop-filter: blur(15px);
}
.bottom-bar.show { display: flex; }
.bottom-btn {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  color: white;
  border: none;
  padding: 10px 22px;
  border-radius: 22px;
  font-size: 14px;
  cursor: pointer;
  font-family: inherit;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.bottom-btn:active { transform: scale(0.95); }
.bottom-btn.secondary {
  background: white;
  color: var(--primary-color);
  border: 1.5px solid var(--primary-light);
  box-shadow: none;
}
/* ===== æç¤ºå’Œé€šçŸ¥ ===== */
.toast {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.78);
  color: white;
  padding: 14px 28px;
  border-radius: var(--radius-sm);
  font-size: 14px;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
  backdrop-filter: blur(8px);
  letter-spacing: 0.5px;
}
.toast.show { opacity: 1; }
.auto-save-indicator {
  position: fixed;
  top: 14px; left: 50%;
  transform: translateX(-50%);
  background: var(--primary-color);
  color: white;
  padding: 5px 16px;
  border-radius: 16px;
  font-size: 12px;
  z-index: 2000;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}
.auto-save-indicator.show { opacity: 1; }
.wish-notification {
  position: fixed;
  top: 18px; left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
  color: #4a3000;
  padding: 12px 22px;
  border-radius: var(--radius-md);
  box-shadow: 0 4px 22px rgba(255,215,0,0.35);
  z-index: 3000;
  display: none;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  animation: notifPulse 2.5s ease-in-out infinite;
  white-space: nowrap;
}
.wish-notification.show { display: flex; }
@keyframes notifPulse {
  0%, 100% { transform: translateX(-50%) scale(1); }
  50% { transform: translateX(-50%) scale(1.03); }
}
.wish-notification .notif-icon { font-size: 20px; }
.wish-notification .notif-text { font-size: 13px; font-weight: 500; }
</style>
</head>
<body data-theme="green">
  <!-- å°é¢ -->
<div class="cover-page" id="coverPage">
  <canvas class="particles-canvas" id="particlesCanvas"></canvas>
  <div class="particle-switcher">
    <button class="particle-btn active" data-type="rain">ğŸŒ§ï¸</button>
    <button class="particle-btn" data-type="sakura">ğŸŒ¸</button>
    <button class="particle-btn" data-type="meteor">ğŸŒ </button>
    <button class="particle-btn" data-type="leaves">ğŸ‚</button>
    <button class="particle-btn" data-type="snow">â„ï¸</button>
  </div>
  <div class="cover-title">æˆ‘ä»¬çš„æ•…äº‹</div>
  <div class="cover-subtitle">è®°å½•å±äºæˆ‘ä»¬çš„æ¯ä¸€åˆ»</div>
  <div class="cover-author">by å¿ƒç”°</div>
  <div class="swipe-area" id="swipeArea">
    <div class="swipe-hint">
      <div class="swipe-arrow"></div>
      <div class="swipe-text">ä¸Šæ»‘æˆ–ç‚¹å‡»è¿›å…¥</div>
    </div>
    <div class="swipe-bar"></div>
  </div>
</div>

<!-- åŠ è½½ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-title">å¿ƒç”°</div>
  <div class="loading-text">æ­£åœ¨å¯¼å…¥æ•°æ®<span class="loading-dots"></span></div>
</div>

<!-- è®¸æ„¿é€šçŸ¥ -->
<div class="wish-notification" id="wishNotification">
  <span class="notif-icon">ğŸ‰</span>
  <span class="notif-text">æœ‰æ„¿æœ›å¯ä»¥æ‰“å¼€å•¦!</span>
</div>

<!-- ä¸»é¡µ -->
<div class="main-page" id="mainPage">
  <div class="author-mark top-left">by å¿ƒç”°</div>
  <div class="author-mark bottom-right">å¿ƒç”°</div>
  <div class="top-controls" id="topControls">
    <button class="ctrl-btn theme-btn" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜">ğŸ¨</button>
    <button class="ctrl-btn" id="bgBtn">èƒŒæ™¯</button>
    <input type="file" id="bgInput" accept="image/*">
  </div>
  <div class="auto-save-indicator" id="autoSaveIndicator">å·²è‡ªåŠ¨ä¿å­˜</div>

  <div class="container">
    <!-- æ ‡é¢˜å¤´ -->
    <div class="header" id="headerBox">
      <button class="header-bg-btn" id="headerBgBtn">æ¢èƒŒæ™¯</button>
      <input type="file" id="headerBgInput" accept="image/*">
      <h1 class="editable" contenteditable="true" data-key="mainTitle">æˆ‘ä»¬çš„æ•…äº‹</h1>
      <p class="editable" contenteditable="true" data-key="subTitle1">ç‡•ä¸– & è°¢è”šå®‰</p>
      <p class="editable" contenteditable="true" data-key="subTitle2">ä»ç›¸é‡åˆ°ç›¸å®ˆ</p>
    </div>

    <!-- éŸ³ä¹æ’­æ”¾å™¨ -->
    <div class="music-player" id="musicPlayer">
      <div class="disc-container">
        <div class="disc" id="musicDisc">
          <div class="disc-center" id="discCenter">
            <img id="discImg" src="" alt="" style="display:none">
            <span class="disc-placeholder" id="discPlaceholder">+</span>
          </div>
        </div>
        <input type="file" id="discImgInput" accept="image/*">
      </div>
      <div class="music-info">
        <div class="music-title" id="musicTitle">æœªé€‰æ‹©éŸ³ä¹</div>
        <div class="music-controls">
          <button class="music-btn small" id="prevMusicBtn">â®</button>
          <button class="music-btn" id="playPauseBtn">â–¶</button>
          <button class="music-btn small" id="nextMusicBtn">â­</button>
          <div class="music-progress" id="musicProgress">
            <div class="music-progress-bar" id="musicProgressBar"></div>
          </div>
          <span class="music-time" id="musicTime">0:00</span>
        </div>
        <button class="music-list-btn" id="musicListBtn">éŸ³ä¹åˆ—è¡¨ (0/5)</button>
      </div>
    </div>
    <audio id="audioPlayer"></audio>

    <!-- å¼•è¨€ -->
    <div class="quote-box">
      <p class="editable" contenteditable="true" data-key="quote">æœ‰ä½ åœ¨,æˆ‘è§‰å¾—è¿™ä¸ªå®¶æ˜¯æ´»çš„ã€‚</p>
      <div class="author">â€”â€” <span class="editable" contenteditable="true" data-key="quoteAuthor">è°¢è”šå®‰</span></div>
    </div>

    <!-- ç¬”è®° -->
    <div class="notebook">
      <div class="notebook-title">ç¬¬ä¸€æ¬¡è§é¢</div>
      <div class="notebook-content editable" contenteditable="true" data-key="note1">é‚£å¤©é˜³å…‰å¾ˆå¥½,ä»–ç©¿ç€ç™½å¤§è¤‚ç«™åœ¨çª—è¾¹ã€‚æˆ‘è®°å¾—ä»–è¯´çš„ç¬¬ä¸€å¥è¯æ˜¯"ä½ å¥½,æˆ‘æ˜¯è°¢è”šå®‰"ã€‚å£°éŸ³å¾ˆè½»,åƒæ€•æƒŠæ‰°ä»€ä¹ˆä¼¼çš„ã€‚</div>
      <div class="notebook-date editable" contenteditable="true" data-key="note1Date">2024å¹´ æŸæœˆæŸæ—¥</div>
    </div>

    <!-- ç…§ç‰‡ -->
    <div class="photo-card">
      <div class="photo-wrapper" id="mainPhotoWrapper">
        <img id="mainImg" src="" alt="ç‚¹å‡»æ·»åŠ ç…§ç‰‡">
        <div class="upload-hint"><span>+</span><p>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</p></div>
      </div>
      <input type="file" id="mainPhotoInput" accept="image/*">
      <div class="caption">
        <h3>æˆ‘ä»¬çš„åˆç…§</h3>
        <p class="editable" contenteditable="true" data-key="mainCaption">è®°å½•æœ€ç¾å¥½çš„ç¬é—´</p>
      </div>
    </div>

    <!-- è®¡æ—¥ -->
    <div class="calendar-card">
      <div class="days-label">æˆ‘ä»¬å·²ç»ç›¸è¯†</div>
      <div class="days-count" id="daysCount">0</div>
      <div class="days-label">å¤©</div>
      <div class="start-date" id="startDateText">é€‰æ‹©ç›¸é‡çš„æ—¥æœŸå¼€å§‹è®°å½•</div>
      <div class="date-picker"><input type="date" id="startDateInput"></div>
    </div>

    <!-- ç›¸å†Œ -->
    <h2 class="section-title">æˆ‘ä»¬çš„ç›¸å†Œ</h2>
    <div class="album-book" id="albumBook">
      <div class="album-cover">
        <div class="book-spine"></div>
        <h2>ç›¸å†Œ</h2>
        <p>ç‚¹å‡»æ‰“å¼€ Â· å…±10é¡µ</p>
      </div>
    </div>

    <!-- æ›´å¤š -->
    <h2 class="section-title">æ›´å¤šå†…å®¹</h2>
    <div class="nav-cards">
      <div class="nav-card" id="timelineCard"><div class="icon">ğŸ“…</div><h3>æ—¶é—´çº¿</h3><p>è®°å½•é‡è¦æ—¶åˆ»</p></div>
      <div class="nav-card" id="notebookCard"><div class="icon">ğŸ“–</div><h3>ç¬”è®°æœ¬</h3><p>å†™ä¸‹æƒ³è¯´çš„è¯</p></div>
      <div class="nav-card" id="wishCard"><div class="icon">ğŸ¾</div><h3>è®¸æ„¿ç“¶</h3><p>å°å­˜ç¾å¥½æ„¿æœ›</p></div>
      <div class="nav-card" id="moodCard"><div class="icon">ğŸ“ˆ</div><h3>å¿ƒæƒ…æ›²çº¿</h3><p>è®°å½•æ¯æ—¥å¿ƒæƒ…</p></div>
    </div>

    <!-- ä¾¿ç­¾ -->
    <h2 class="section-title">ä¾¿ç­¾å¢™</h2>
    <div class="sticky-wall">
      <div class="sticky-container" id="stickyContainer">
        <div class="add-sticky-btn" id="addStickyBtn">+ æ·»åŠ ä¾¿ç­¾</div>
      </div>
    </div>

    <!-- å°¾éƒ¨ç¬”è®° -->
    <div class="notebook">
      <div class="notebook-title">ç»™æœªæ¥çš„æˆ‘ä»¬</div>
      <div class="notebook-content editable" contenteditable="true" data-key="note2">ä¸ç®¡ä»¥åå‘ç”Ÿä»€ä¹ˆ,æˆ‘éƒ½æƒ³è®°ä½ç°åœ¨çš„æ„Ÿè§‰ã€‚è¢«çˆ±ç€çš„æ„Ÿè§‰,è¢«æ¸©æŸ”å¯¹å¾…çš„æ„Ÿè§‰ã€‚è°¢è°¢ä½ ,è”šå®‰ã€‚</div>
      <div class="notebook-date editable" contenteditable="true" data-key="note2Date">å†™äºæŸä¸ªå®‰é™çš„å¤œæ™š</div>
    </div>
  </div>

  <div class="bottom-bar" id="bottomBar">
    <button class="bottom-btn secondary" id="exportBtn">å¯¼å‡ºæ•°æ®</button>
    <button class="bottom-btn" id="importBtn">å¯¼å…¥æ•°æ®</button>
    <input type="file" id="importInput" accept=".json">
  </div>
</div>
<!-- éŸ³ä¹åˆ—è¡¨å¼¹çª— -->
<div class="overlay-modal" id="musicListModal">
  <div class="overlay-modal-content">
    <div class="overlay-modal-header">
      <h3>éŸ³ä¹åˆ—è¡¨</h3>
      <button class="overlay-modal-close" id="closeMusicList">Ã—</button>
    </div>
    <div id="musicListContainer"></div>
    <button class="music-add-btn" id="addMusicBtn">+ æ·»åŠ éŸ³ä¹ (æœ€å¤š5é¦–)</button>
    <input type="file" id="musicFileInput" accept="audio/mp3,audio/mpeg,.mp3">
  </div>
</div>

<!-- ç›¸å†Œå¼¹çª— -->
<div class="modal album-modal" id="albumModal">
  <div class="modal-container" id="albumContainer">
    <div class="modal-header">
      <div class="header-left">
        <button class="album-bg-btn" id="albumBgBtn">æ›´æ¢èƒŒæ™¯</button>
        <input type="file" id="albumBgInput" accept="image/*">
      </div>
      <h3>æˆ‘ä»¬çš„ç›¸å†Œ</h3>
      <button class="close-modal" id="closeAlbumBtn">Ã—</button>
    </div>
    <div class="modal-content">
      <div id="albumPages"></div>
    </div>
    <div class="album-nav">
      <button class="nav-btn" id="prevPageBtn">â—€</button>
      <span class="page-indicator" id="pageInfo">1 / 10</span>
      <button class="nav-btn" id="nextPageBtn">â–¶</button>
    </div>
  </div>
</div>

<!-- æ—¶é—´çº¿å¼¹çª— -->
<div class="modal" id="timelineModal">
  <div class="modal-container">
    <div class="modal-header">
      <h3>æˆ‘ä»¬çš„æ—¶é—´çº¿</h3>
      <button class="close-modal" id="closeTimelineBtn">Ã—</button>
    </div>
    <div class="modal-content">
      <div class="timeline" id="timelineContainer"></div>
      <div class="add-item-btn" id="addTimelineBtn"><span>+</span><p>æ·»åŠ æ–°çš„æ—¶é—´èŠ‚ç‚¹</p></div>
    </div>
  </div>
</div>

<!-- ç¬”è®°æœ¬å¼¹çª— -->
<div class="modal" id="notebookModal">
  <div class="modal-container">
    <div class="modal-header">
      <h3>æˆ‘çš„ç¬”è®°æœ¬</h3>
      <button class="close-modal" id="closeNotebookBtn">Ã—</button>
    </div>
    <div class="modal-content">
      <div id="notebookContainer"></div>
      <div class="add-item-btn" id="addNotebookBtn"><span>+</span><p>å†™ä¸€ç¯‡æ–°çš„æ—¥è®°</p></div>
    </div>
  </div>
</div>

<!-- è®¸æ„¿ç“¶å¼¹çª— -->
<div class="modal" id="wishModal">
  <div class="modal-container">
    <div class="modal-header">
      <h3>è®¸æ„¿ç“¶</h3>
      <button class="close-modal" id="closeWishBtn">Ã—</button>
    </div>
    <div class="modal-content">
      <div class="wish-bottle-container" id="wishBottleContainer"></div>
    </div>
  </div>
</div>

<!-- å¿ƒæƒ…æ›²çº¿å¼¹çª— -->
<div class="modal" id="moodModal">
  <div class="modal-container">
    <div class="modal-header">
      <h3>å¿ƒæƒ…æ›²çº¿</h3>
      <button class="close-modal" id="closeMoodBtn">Ã—</button>
    </div>
    <div class="modal-content">
      <div class="mood-chart-container">
        <div class="mood-header">
          <h4>å¿ƒæƒ…è®°å½•</h4>
          <span class="mood-page-info" id="moodPageInfo">ç¬¬1é¡µ (0/30)</span>
        </div>
        <div class="mood-legend">
          <div class="mood-legend-item"><div class="mood-legend-color" style="background:#e57373"></div>å¾ˆå·®</div>
          <div class="mood-legend-item"><div class="mood-legend-color" style="background:#ffb74d"></div>ä¸å¥½</div>
          <div class="mood-legend-item"><div class="mood-legend-color" style="background:#fff176"></div>ä¸€èˆ¬</div>
          <div class="mood-legend-item"><div class="mood-legend-color" style="background:#aed581"></div>ä¸é”™</div>
          <div class="mood-legend-item"><div class="mood-legend-color" style="background:#4fc3f7"></div>å¾ˆæ£’</div>
        </div>
        <div class="mood-scroll-wrapper">
          <div class="mood-chart" id="moodChart"></div>
        </div>
        <div class="mood-pages-nav" id="moodPagesNav"></div>
        <button class="mood-add-btn" id="addMoodBtn">è®°å½•ä»Šå¤©çš„å¿ƒæƒ…</button>
      </div>
    </div>
  </div>
</div>

<!-- è®¸æ„¿-åˆ›å»º -->
<div class="overlay-modal" id="wishCreateModal">
  <div class="overlay-modal-content">
    <div class="wish-modal-body">
      <h3>ğŸ¾ å†™ä¸‹ä½ çš„æ„¿æœ›</h3>
      <textarea id="wishText" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„æ„¿æœ›..."></textarea>
      <label>é€‰æ‹©å¼€å¯æ—¥æœŸ:</label>
      <input type="date" id="wishOpenDate">
      <div class="btn-row">
        <button class="btn-secondary" id="cancelWishBtn">å–æ¶ˆ</button>
        <button class="btn-primary" id="saveWishBtn">å°å­˜æ„¿æœ›</button>
      </div>
    </div>
  </div>
</div>

<!-- è®¸æ„¿-æŸ¥çœ‹ -->
<div class="overlay-modal" id="wishViewModal">
  <div class="overlay-modal-content">
    <div class="wish-modal-body">
      <h3>ğŸ‰ æ„¿æœ›å·²å®ç°</h3>
      <div class="wish-view-body">
        <div class="wish-text" id="wishViewText"></div>
        <div class="wish-date" id="wishViewDate"></div>
        <div class="btn-row">
          <button class="btn-secondary" id="closeWishViewBtn">å…³é—­</button>
          <button class="btn-primary" id="deleteWishBtn">åˆ é™¤æ„¿æœ›</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å¿ƒæƒ…é€‰æ‹© -->
<div class="overlay-modal" id="moodSelectModal">
  <div class="overlay-modal-content">
    <div class="wish-modal-body">
      <h3>ä»Šå¤©å¿ƒæƒ…å¦‚ä½•?</h3>
      <div class="mood-selector">
        <div class="mood-option" data-mood="1">ğŸ˜¢</div>
        <div class="mood-option" data-mood="2">ğŸ˜”</div>
        <div class="mood-option" data-mood="3">ğŸ˜</div>
        <div class="mood-option" data-mood="4">ğŸ˜Š</div>
        <div class="mood-option" data-mood="5">ğŸ˜„</div>
      </div>
      <div class="btn-row">
        <button class="btn-secondary" id="cancelMoodBtn">å–æ¶ˆ</button>
        <button class="btn-primary" id="saveMoodBtn">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script>
(function() {
  'use strict';

  var currentPage = 0, totalPages = 10, photosPerPage = 3;
  var stickyColors = ['yellow', 'pink', 'blue', 'green'], stickyCount = 0;
  var autoSaveTimer = null, hasUnsavedChanges = false;
  var themes = ['green', 'red', 'yellow', 'white', 'black', 'blue', 'purple'];
  var currentThemeIndex = 0;
  var musicList = [], currentMusicIndex = 0, isPlaying = false;
  var wishList = [], currentViewingWish = null;
  var moodData = { pages: [[], [], []], currentPage: 0 };
  var selectedMood = null;
  var particleType = 'rain', particles = [], animationId = null;

  function $(id) { return document.getElementById(id); }

  function showToast(msg) {
    var t = $('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 1800);
  }

  function showAutoSave() {
    var s = $('autoSaveIndicator');
    s.classList.add('show');
    setTimeout(function() { s.classList.remove('show'); }, 1200);
  }

  function showLoading() { $('loadingOverlay').classList.add('show'); }

  function hideLoading() {
    var o = $('loadingOverlay');
    o.classList.add('hiding');
    setTimeout(function() { o.classList.remove('show', 'hiding'); }, 500);
  }

  function markChanged() { hasUnsavedChanges = true; }

  function triggerAutoSave() {
    if (autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(function() {
      saveAllData();
      showAutoSave();
      hasUnsavedChanges = false;
    }, 1000);
  }

  function getToday() {
    var d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  }

  function getTodayDot() {
    var d = new Date();
    return d.getFullYear() + '.' + String(d.getMonth() + 1).padStart(2, '0') + '.' + String(d.getDate()).padStart(2, '0');
  }

  function formatTime(sec) {
    if (!sec || isNaN(sec)) return '0:00';
    var m = Math.floor(sec / 60);
    var s = Math.floor(sec % 60);
    return m + ':' + (s < 10 ? '0' : '') + s;
  }

  // ===== ç²’å­ç³»ç»Ÿ =====
  function initParticles() {
    var canvas = $('particlesCanvas');
    var ctx = canvas.getContext('2d');

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    function createParticle(randomY) {
      var p = { x: 0, y: 0, vx: 0, vy: 0, size: 0, opacity: 1, rotation: 0, rs: 0, sw: 0, len: 0 };
      switch (particleType) {
        case 'rain':
          p.x = Math.random() * canvas.width * 1.2 - canvas.width * 0.1;
          p.y = randomY ? Math.random() * canvas.height : -Math.random() * 80;
          p.vx = -0.8;
          p.vy = 7 + Math.random() * 5;
          p.size = 0.8 + Math.random() * 1.5;
          p.opacity = 0.3 + Math.random() * 0.3;
          break;
        case 'sakura':
          p.x = Math.random() * canvas.width * 1.2;
          p.y = randomY ? Math.random() * canvas.height : -Math.random() * 40;
          p.vx = -0.8 + Math.random() * 1.6;
          p.vy = 0.8 + Math.random() * 1.8;
          p.size = 6 + Math.random() * 7;
          p.opacity = 0.6 + Math.random() * 0.4;
          p.rotation = Math.random() * 360;
          p.rs = -2 + Math.random() * 4;
          break;
        case 'meteor':
          p.x = Math.random() * canvas.width * 1.5;
          p.y = -Math.random() * canvas.height * 0.5;
          p.vx = -7 - Math.random() * 5;
          p.vy = 7 + Math.random() * 5;
          p.size = 1.5 + Math.random() * 2;
          p.opacity = 0.9;
          p.len = 25 + Math.random() * 45;
          break;
        case 'leaves':
          p.x = Math.random() * canvas.width * 1.1;
          p.y = randomY ? Math.random() * canvas.height : -Math.random() * 40;
          p.vx = -0.5 + Math.random() * 1;
          p.vy = 1 + Math.random() * 2;
          p.size = 8 + Math.random() * 10;
          p.opacity = 0.75;
          p.rotation = Math.random() * 360;
          p.rs = -2.5 + Math.random() * 5;
          p.sw = Math.random() * Math.PI * 2;
          break;
        case 'snow':
          p.x = Math.random() * canvas.width;
          p.y = randomY ? Math.random() * canvas.height : -Math.random() * 40;
          p.vx = -0.3 + Math.random() * 0.6;
          p.vy = 0.6 + Math.random() * 1.8;
          p.size = 2 + Math.random() * 4;
          p.opacity = 0.5 + Math.random() * 0.4;
          p.sw = Math.random() * Math.PI * 2;
          break;
      }
      return p;
    }

    function getCount() {
      var counts = { rain: 80, sakura: 35, meteor: 6, leaves: 25, snow: 50 };
      return counts[particleType] || 40;
    }

    function resetParticles() {
      particles = [];
      for (var i = 0; i < getCount(); i++) particles.push(createParticle(true));
    }

    function draw(p) {
      ctx.save();
      ctx.globalAlpha = p.opacity;
      switch (particleType) {
        case 'rain':
          ctx.strokeStyle = 'rgba(160,196,232,0.7)';
          ctx.lineWidth = p.size;
          ctx.beginPath();
          ctx.moveTo(p.x, p.y);
          ctx.lineTo(p.x + p.vx * 2.5, p.y + p.vy * 2.5);
          ctx.stroke();
          break;
        case 'sakura':
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          for (var i = 0; i < 5; i++) {
            ctx.fillStyle = i % 2 === 0 ? '#ffb7c5' : '#ffc8d6';
            ctx.beginPath();
            ctx.ellipse(0, -p.size * 0.4, p.size * 0.22, p.size * 0.42, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.rotate(Math.PI * 2 / 5);
          }
          ctx.fillStyle = '#fff0f3';
          ctx.beginPath();
          ctx.arc(0, 0, p.size * 0.15, 0, Math.PI * 2);
          ctx.fill();
          break;
        case 'meteor':
          var g = ctx.createLinearGradient(p.x, p.y, p.x - p.len * 0.6, p.y - p.len * 0.6);
          g.addColorStop(0, 'rgba(255,255,255,0.9)');
          g.addColorStop(0.4, 'rgba(255,255,200,0.5)');
          g.addColorStop(1, 'rgba(255,255,200,0)');
          ctx.strokeStyle = g;
          ctx.lineWidth = p.size;
          ctx.lineCap = 'round';
          ctx.beginPath();
          ctx.moveTo(p.x, p.y);
          ctx.lineTo(p.x - p.len * 0.6, p.y - p.len * 0.6);
          ctx.stroke();
          ctx.fillStyle = '#fff';
          ctx.shadowColor = '#fff';
          ctx.shadowBlur = 6;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size * 0.8, 0, Math.PI * 2);
          ctx.fill();
          break;
        case 'leaves':
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          var lg = ctx.createLinearGradient(-p.size / 2, 0, p.size / 2, 0);
          lg.addColorStop(0, '#d4a574');
          lg.addColorStop(0.5, '#c08040');
          lg.addColorStop(1, '#a05d2e');
          ctx.fillStyle = lg;
          ctx.beginPath();
          ctx.moveTo(0, -p.size / 2);
          ctx.quadraticCurveTo(p.size / 2, 0, 0, p.size / 2);
          ctx.quadraticCurveTo(-p.size / 2, 0, 0, -p.size / 2);
          ctx.fill();
          ctx.strokeStyle = 'rgba(139,69,19,0.4)';
          ctx.lineWidth = 0.5;
          ctx.beginPath();
          ctx.moveTo(0, -p.size / 2);
          ctx.lineTo(0, p.size / 2);
          ctx.stroke();
          break;
        case 'snow':
          var sg = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
          sg.addColorStop(0, 'rgba(255,255,255,0.9)');
          sg.addColorStop(1, 'rgba(255,255,255,0)');
          ctx.fillStyle = sg;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fill();
          break;
      }
      ctx.restore();
    }

    function update(p, t) {
      switch (particleType) {
        case 'rain': p.x += p.vx; p.y += p.vy; break;
        case 'sakura':
          p.x += p.vx + Math.sin(t / 800 + p.rotation) * 0.4;
          p.y += p.vy;
          p.rotation += p.rs;
          break;
        case 'meteor':
          p.x += p.vx; p.y += p.vy; p.opacity -= 0.006;
          break;
        case 'leaves':
          p.x += p.vx + Math.sin(t / 400 + p.sw) * 1.2;
          p.y += p.vy;
          p.rotation += p.rs;
          break;
        case 'snow':
          p.x += p.vx + Math.sin(t / 900 + p.sw) * 0.4;
          p.y += p.vy;
          break;
      }
      if (p.y > canvas.height + 40 || p.x < -60 || p.x > canvas.width + 60 || p.opacity <= 0) {
        return createParticle(false);
      }
      return p;
    }

    function animate(t) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (var i = 0; i < particles.length; i++) {
        draw(particles[i]);
        particles[i] = update(particles[i], t);
      }
      animationId = requestAnimationFrame(animate);
    }

    resetParticles();
    animate(0);

    document.querySelectorAll('.particle-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        document.querySelectorAll('.particle-btn').forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');
        particleType = this.getAttribute('data-type');
        localStorage.setItem('particleType', particleType);
        resetParticles();
      });
    });

    var savedType = localStorage.getItem('particleType');
    if (savedType && savedType !== particleType) {
      particleType = savedType;
      document.querySelectorAll('.particle-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-type') === savedType);
      });
      resetParticles();
    }
  }

  function stopParticles() {
    if (animationId) { cancelAnimationFrame(animationId); animationId = null; }
  }
  // ===== éŸ³ä¹æ’­æ”¾å™¨ =====
  function initMusicPlayer() {
    var audio = $('audioPlayer');
    var disc = $('musicDisc');
    var playBtn = $('playPauseBtn');
    var progressBar = $('musicProgressBar');
    var progress = $('musicProgress');
    var titleEl = $('musicTitle');
    var timeEl = $('musicTime');

    function updateUI() {
      var count = musicList.length;
      $('musicListBtn').textContent = 'éŸ³ä¹åˆ—è¡¨ (' + count + '/5)';
      var addBtn = $('addMusicBtn');
      if (count >= 5) {
        addBtn.textContent = 'å·²è¾¾ä¸Šé™ (5/5)';
        addBtn.disabled = true;
      } else {
        addBtn.textContent = '+ æ·»åŠ éŸ³ä¹ (æœ€å¤š5é¦–)';
        addBtn.disabled = false;
      }
      if (count > 0 && currentMusicIndex < count) {
        titleEl.textContent = musicList[currentMusicIndex].name;
      } else {
        titleEl.textContent = 'æœªé€‰æ‹©éŸ³ä¹';
      }
      renderList();
    }

    function renderList() {
      var container = $('musicListContainer');
      container.innerHTML = '';
      musicList.forEach(function(music, i) {
        var item = document.createElement('div');
        item.className = 'music-item' + (i === currentMusicIndex && isPlaying ? ' active' : '');
        item.innerHTML = '<span class="music-item-index">' + (i + 1) + '</span>' +
          '<span class="music-item-name">' + music.name + '</span>' +
          '<div class="music-item-actions">' +
            '<button class="music-item-btn" data-action="replace" data-index="' + i + '" title="æ›¿æ¢">ğŸ”„</button>' +
            '<button class="music-item-btn" data-action="delete" data-index="' + i + '" title="åˆ é™¤">âœ•</button>' +
          '</div>';
        item.addEventListener('click', function(e) {
          if (!e.target.closest('.music-item-btn')) playIndex(i);
        });
        container.appendChild(item);
      });
    }

    function playIndex(index) {
      if (musicList.length === 0) return;
      currentMusicIndex = index;
      audio.src = musicList[index].data;
      audio.play().then(function() {
        isPlaying = true;
        disc.classList.add('playing');
        playBtn.textContent = 'â¸';
        updateUI();
      }).catch(function() {});
    }

    function togglePlay() {
      if (musicList.length === 0) { showToast('è¯·å…ˆæ·»åŠ éŸ³ä¹'); return; }
      if (isPlaying) {
        audio.pause();
        isPlaying = false;
        disc.classList.remove('playing');
        playBtn.textContent = 'â–¶';
      } else {
        if (!audio.src || audio.src === location.href) {
          playIndex(currentMusicIndex);
        } else {
          audio.play().then(function() {
            isPlaying = true;
            disc.classList.add('playing');
            playBtn.textContent = 'â¸';
          }).catch(function() {});
        }
      }
      updateUI();
    }

    playBtn.addEventListener('click', togglePlay);

    $('nextMusicBtn').addEventListener('click', function() {
      if (musicList.length === 0) return;
      playIndex((currentMusicIndex + 1) % musicList.length);
    });

    $('prevMusicBtn').addEventListener('click', function() {
      if (musicList.length === 0) return;
      playIndex((currentMusicIndex - 1 + musicList.length) % musicList.length);
    });

    audio.addEventListener('timeupdate', function() {
      if (audio.duration) {
        progressBar.style.width = (audio.currentTime / audio.duration * 100) + '%';
        timeEl.textContent = formatTime(audio.currentTime);
      }
    });

    audio.addEventListener('ended', function() {
      var next = (currentMusicIndex + 1) % musicList.length;
      playIndex(next);
    });

    progress.addEventListener('click', function(e) {
      if (audio.duration) {
        var rect = progress.getBoundingClientRect();
        audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
      }
    });

    $('musicListBtn').addEventListener('click', function() {
      $('musicListModal').classList.add('open');
    });

    $('closeMusicList').addEventListener('click', function() {
      $('musicListModal').classList.remove('open');
    });

    $('addMusicBtn').addEventListener('click', function() {
      if (musicList.length >= 5) { showToast('æœ€å¤š5é¦–'); return; }
      $('musicFileInput').click();
    });

    $('musicFileInput').addEventListener('change', function() {
      if (!this.files || !this.files[0]) return;
      var file = this.files[0];
      if (file.size > 15 * 1024 * 1024) { showToast('æ–‡ä»¶éœ€å°äº15MB'); this.value = ''; return; }
      var reader = new FileReader();
      reader.onload = function(e) {
        var name = file.name.replace(/\.[^/.]+$/, '');
        musicList.push({ name: name, data: e.target.result });
        updateUI();
        markChanged();
        triggerAutoSave();
        showToast('å·²æ·»åŠ : ' + name);
        if (musicList.length === 1) playIndex(0);
      };
      reader.readAsDataURL(file);
      this.value = '';
    });

    // æ›¿æ¢å’Œåˆ é™¤
    var replaceIndex = -1;
    var replaceInput = document.createElement('input');
    replaceInput.type = 'file';
    replaceInput.accept = 'audio/mp3,audio/mpeg,.mp3';
    replaceInput.style.display = 'none';
    document.body.appendChild(replaceInput);

    replaceInput.addEventListener('change', function() {
      if (!this.files || !this.files[0] || replaceIndex < 0) return;
      var file = this.files[0];
      if (file.size > 15 * 1024 * 1024) { showToast('æ–‡ä»¶éœ€å°äº15MB'); this.value = ''; return; }
      var reader = new FileReader();
      var idx = replaceIndex;
      reader.onload = function(e) {
        var name = file.name.replace(/\.[^/.]+$/, '');
        musicList[idx] = { name: name, data: e.target.result };
        if (idx === currentMusicIndex && isPlaying) playIndex(idx);
        updateUI();
        markChanged();
        triggerAutoSave();
        showToast('å·²æ›¿æ¢ä¸º: ' + name);
      };
      reader.readAsDataURL(file);
      this.value = '';
    });

    $('musicListContainer').addEventListener('click', function(e) {
      var btn = e.target.closest('.music-item-btn');
      if (!btn) return;
      var action = btn.getAttribute('data-action');
      var index = parseInt(btn.getAttribute('data-index'));

      if (action === 'replace') {
        replaceIndex = index;
        replaceInput.click();
      } else if (action === 'delete') {
        if (!confirm('ç¡®å®šåˆ é™¤è¿™é¦–éŸ³ä¹å—?')) return;
        var wasPlaying = index === currentMusicIndex && isPlaying;
        musicList.splice(index, 1);
        if (musicList.length === 0) {
          audio.pause(); audio.src = ''; isPlaying = false;
          disc.classList.remove('playing'); playBtn.textContent = 'â–¶';
          currentMusicIndex = 0; timeEl.textContent = '0:00';
          progressBar.style.width = '0%';
        } else {
          if (index < currentMusicIndex) currentMusicIndex--;
          else if (index === currentMusicIndex) {
            currentMusicIndex = currentMusicIndex % musicList.length;
            if (wasPlaying) playIndex(currentMusicIndex);
          }
        }
        updateUI();
        markChanged();
        triggerAutoSave();
      }
    });

    $('discCenter').addEventListener('click', function(e) {
      e.stopPropagation();
      $('discImgInput').click();
    });

    $('discImgInput').addEventListener('change', function() {
      if (this.files && this.files[0]) {
        compressImage(this.files[0], 200, 0.8, function(url) {
          $('discImg').src = url;
          $('discImg').style.display = 'block';
          $('discPlaceholder').style.display = 'none';
          markChanged();
          triggerAutoSave();
        });
      }
      this.value = '';
    });

    updateUI();
  }

  function autoPlayMusic() {
    if (musicList.length === 0) return;
    var audio = $('audioPlayer');
    audio.src = musicList[currentMusicIndex].data;
    $('musicTitle').textContent = musicList[currentMusicIndex].name;

    var tryPlay = function() {
      audio.play().then(function() {
        isPlaying = true;
        $('musicDisc').classList.add('playing');
        $('playPauseBtn').textContent = 'â¸';
      }).catch(function() {
        document.addEventListener('click', function once() {
          if (musicList.length > 0 && !isPlaying) {
            audio.play().then(function() {
              isPlaying = true;
              $('musicDisc').classList.add('playing');
              $('playPauseBtn').textContent = 'â¸';
            }).catch(function() {});
          }
          document.removeEventListener('click', once);
        }, { once: true });
      });
    };
    tryPlay();
  }
  // ===== å°é¢ =====
  function enterMainPage() {
    var cover = $('coverPage');
    cover.classList.add('hiding');
    setTimeout(function() { cover.classList.add('hidden'); stopParticles(); }, 700);
    $('mainPage').classList.add('show');
    $('topControls').classList.add('show');
    $('bottomBar').classList.add('show');
    localStorage.setItem('coverEntered', 'true');
    autoPlayMusic();
    setTimeout(checkWishNotifications, 500);
  }

  function initCover() {
    var cover = $('coverPage');
    var startY = 0, moved = false;

    if (localStorage.getItem('coverEntered') === 'true') {
      cover.classList.add('hidden');
      $('mainPage').classList.add('show');
      $('topControls').classList.add('show');
      $('bottomBar').classList.add('show');
      stopParticles();
      autoPlayMusic();
      setTimeout(checkWishNotifications, 1000);
      return;
    }

    cover.addEventListener('touchstart', function(e) { startY = e.touches[0].clientY; moved = false; }, { passive: true });
    cover.addEventListener('touchmove', function(e) {
      if (cover.classList.contains('hiding')) return;
      if (startY - e.touches[0].clientY > 55) { moved = true; enterMainPage(); }
    }, { passive: true });
    cover.addEventListener('touchend', function(e) {
      if (!moved && e.target.closest('.swipe-area')) enterMainPage();
    }, { passive: true });

    $('swipeArea').addEventListener('click', function(e) { e.stopPropagation(); enterMainPage(); });
    cover.addEventListener('click', function(e) {
      if (!e.target.closest('.particle-btn')) enterMainPage();
    });
    document.addEventListener('keydown', function(e) {
      if (!cover.classList.contains('hidden') && (e.key === 'ArrowUp' || e.key === 'Enter' || e.key === ' ')) {
        e.preventDefault(); enterMainPage();
      }
    });
    cover.addEventListener('wheel', function(e) {
      if (e.deltaY > 0 && !cover.classList.contains('hiding')) enterMainPage();
    }, { passive: true });
  }

  // ===== è®¸æ„¿ç“¶ =====
  function renderWishBottles() {
    var container = $('wishBottleContainer');
    container.innerHTML = '';

    wishList.forEach(function(wish, index) {
      var bottle = document.createElement('div');
      var now = new Date();
      var openDate = new Date(wish.openDate + 'T23:59:59');
      var isReady = now >= openDate;

      bottle.className = 'wish-bottle' + (isReady ? ' ready' : ' locked');

      if (isReady) {
        bottle.innerHTML = '<div class="bottle-icon">âœ¨</div><div class="bottle-status">å¯ä»¥æ‰“å¼€å•¦!</div>';
      } else {
        var days = Math.ceil((openDate - now) / 86400000);
        bottle.innerHTML = '<div class="bottle-icon">ğŸ¾</div><div class="bottle-status">è¿˜æœ‰' + days + 'å¤©</div>';
      }

      bottle.addEventListener('click', function() {
        if (isReady) {
          currentViewingWish = index;
          $('wishViewText').textContent = wish.text;
          $('wishViewDate').textContent = 'è®¸æ„¿äº ' + wish.createDate + ' Â· å¼€å¯äº ' + wish.openDate;
          $('wishViewModal').classList.add('open');
        } else {
          showToast('è¿˜æ²¡åˆ°å¼€å¯æ—¶é—´å“¦~');
        }
      });
      container.appendChild(bottle);
    });

    var addBtn = document.createElement('div');
    addBtn.className = 'add-wish-bottle';
    addBtn.innerHTML = '<span>+</span><p>è®¸ä¸ªæ„¿</p>';
    addBtn.addEventListener('click', function() {
      $('wishText').value = '';
      var next = new Date();
      next.setDate(next.getDate() + 7);
      $('wishOpenDate').value = next.toISOString().split('T')[0];
      $('wishOpenDate').min = getToday();
      $('wishCreateModal').classList.add('open');
    });
    container.appendChild(addBtn);
  }

  function checkWishNotifications() {
    var hasReady = wishList.some(function(w) {
      return new Date() >= new Date(w.openDate + 'T23:59:59');
    });
    $('wishNotification').classList.toggle('show', hasReady);
  }

  function initWishBottle() {
    $('wishCard').addEventListener('click', function() {
      $('wishModal').classList.add('open');
      document.body.style.overflow = 'hidden';
      renderWishBottles();
    });

    $('closeWishBtn').addEventListener('click', function() {
      $('wishModal').classList.remove('open');
      document.body.style.overflow = '';
    });

    $('cancelWishBtn').addEventListener('click', function() { $('wishCreateModal').classList.remove('open'); });

    $('saveWishBtn').addEventListener('click', function() {
      var text = $('wishText').value.trim();
      var openDate = $('wishOpenDate').value;
      if (!text) { showToast('è¯·å†™ä¸‹ä½ çš„æ„¿æœ›'); return; }
      if (!openDate) { showToast('è¯·é€‰æ‹©å¼€å¯æ—¥æœŸ'); return; }
      wishList.push({ text: text, openDate: openDate, createDate: getToday() });
      $('wishCreateModal').classList.remove('open');
      renderWishBottles();
      markChanged(); triggerAutoSave();
      showToast('æ„¿æœ›å·²å°å­˜ âœ¨');
    });

    $('closeWishViewBtn').addEventListener('click', function() {
      $('wishViewModal').classList.remove('open');
      currentViewingWish = null;
    });

    $('deleteWishBtn').addEventListener('click', function() {
      if (currentViewingWish !== null && confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªæ„¿æœ›å—?')) {
        wishList.splice(currentViewingWish, 1);
        $('wishViewModal').classList.remove('open');
        currentViewingWish = null;
        renderWishBottles();
        markChanged(); triggerAutoSave();
        checkWishNotifications();
        showToast('æ„¿æœ›å·²åˆ é™¤');
      }
    });

    $('wishNotification').addEventListener('click', function() {
      $('wishModal').classList.add('open');
      document.body.style.overflow = 'hidden';
      this.classList.remove('show');
      renderWishBottles();
    });

    renderWishBottles();
  }

  // ===== å¿ƒæƒ…æ›²çº¿ =====
  function initMoodChart() {
    function render() {
      var chart = $('moodChart');
      var pageNav = $('moodPagesNav');
      var pg = moodData.pages[moodData.currentPage] || [];

      chart.innerHTML = '';
      if (pg.length === 0) {
        chart.innerHTML = '<div style="color:#bbb;padding:30px;text-align:center;width:100%;font-size:13px;">è¿˜æ²¡æœ‰è®°å½•,ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ ~</div>';
      } else {
        pg.forEach(function(item) {
          var bar = document.createElement('div');
          bar.className = 'mood-bar';
          var h = item.mood * 28 + 22;
          bar.innerHTML = '<div class="mood-bar-fill mood-' + item.mood + '" style="height:' + h + 'px"></div>' +
            '<div class="mood-bar-date">' + item.date.slice(5) + '</div>';
          chart.appendChild(bar);
        });
      }

      $('moodPageInfo').textContent = 'ç¬¬' + (moodData.currentPage + 1) + 'é¡µ (' + pg.length + '/30)';

      pageNav.innerHTML = '';
      for (var i = 0; i < 3; i++) {
        var btn = document.createElement('button');
        btn.className = 'mood-page-btn' + (i === moodData.currentPage ? ' active' : '');
        btn.textContent = 'ç¬¬' + (i + 1) + 'é¡µ';
        btn.setAttribute('data-page', String(i));
        if (i > 0 && (!moodData.pages[i - 1] || moodData.pages[i - 1].length < 30)) {
          btn.disabled = true;
        }
        btn.addEventListener('click', function() {
          if (this.disabled) return;
          moodData.currentPage = parseInt(this.getAttribute('data-page'));
          render();
        });
        pageNav.appendChild(btn);
      }
      updateAddBtn();
    }

    function updateAddBtn() {
      var btn = $('addMoodBtn');
      var today = getToday();
      var recorded = moodData.pages.some(function(pg) {
        return pg && pg.some(function(it) { return it.date === today; });
      });
      var pgData = moodData.pages[moodData.currentPage] || [];

      if (recorded) { btn.disabled = true; btn.textContent = 'ä»Šå¤©å·²è®°å½• âœ“'; }
      else if (pgData.length >= 30) { btn.disabled = true; btn.textContent = 'æœ¬é¡µå·²æ»¡,åˆ‡æ¢ä¸‹ä¸€é¡µ'; }
      else { btn.disabled = false; btn.textContent = 'è®°å½•ä»Šå¤©çš„å¿ƒæƒ…'; }
    }

    $('moodCard').addEventListener('click', function() {
      $('moodModal').classList.add('open');
      document.body.style.overflow = 'hidden';
      render();
    });

    $('closeMoodBtn').addEventListener('click', function() {
      $('moodModal').classList.remove('open');
      document.body.style.overflow = '';
    });

    $('addMoodBtn').addEventListener('click', function() {
      if (this.disabled) return;
      selectedMood = null;
      document.querySelectorAll('.mood-option').forEach(function(o) { o.classList.remove('selected'); });
      $('moodSelectModal').classList.add('open');
    });

    document.querySelectorAll('.mood-option').forEach(function(opt) {
      opt.addEventListener('click', function() {
        document.querySelectorAll('.mood-option').forEach(function(o) { o.classList.remove('selected'); });
        this.classList.add('selected');
        selectedMood = parseInt(this.getAttribute('data-mood'));
      });
    });

    $('cancelMoodBtn').addEventListener('click', function() {
      $('moodSelectModal').classList.remove('open');
      selectedMood = null;
    });

    $('saveMoodBtn').addEventListener('click', function() {
      if (!selectedMood) { showToast('è¯·é€‰æ‹©å¿ƒæƒ…'); return; }
      if (!moodData.pages[moodData.currentPage]) moodData.pages[moodData.currentPage] = [];
      moodData.pages[moodData.currentPage].push({ date: getToday(), mood: selectedMood });
      $('moodSelectModal').classList.remove('open');
      render();
      markChanged(); triggerAutoSave();
      showToast('å¿ƒæƒ…å·²è®°å½• âœ¨');
    });

    render();
  }
  // ===== å·¥å…·å‡½æ•° =====
  function compressImage(file, maxW, q, cb) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var img = new Image();
      img.onload = function() {
        var c = document.createElement('canvas');
        var w = img.width, h = img.height;
        if (w > maxW) { h = Math.round(h * maxW / w); w = maxW; }
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        cb(c.toDataURL('image/jpeg', q));
      };
      img.onerror = function() { cb(e.target.result); };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function handleFileInput(input, maxW, q, cb) {
    if (input.files && input.files[0]) compressImage(input.files[0], maxW, q, cb);
    input.value = '';
  }

  function changeTheme() {
    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
    var t = themes[currentThemeIndex];
    document.body.setAttribute('data-theme', t);
    localStorage.setItem('currentTheme', t);
    markChanged(); triggerAutoSave();
    var n = { green:'ç»¿', red:'çº¢', yellow:'é»„', white:'ç™½', black:'é»‘', blue:'è“', purple:'ç´«' };
    showToast('ä¸»é¢˜: ' + (n[t] || t));
  }

  function loadTheme() {
    var s = localStorage.getItem('currentTheme');
    if (s && themes.indexOf(s) !== -1) {
      document.body.setAttribute('data-theme', s);
      currentThemeIndex = themes.indexOf(s);
    }
  }

  function updateDaysCount() {
    var sd = localStorage.getItem('loveStartDate');
    if (!sd) { $('daysCount').textContent = '0'; $('startDateText').textContent = 'é€‰æ‹©ç›¸é‡çš„æ—¥æœŸå¼€å§‹è®°å½•'; return; }
    var start = new Date(sd), today = new Date();
    today.setHours(0,0,0,0); start.setHours(0,0,0,0);
    var diff = Math.floor((today - start) / 86400000);
    $('daysCount').textContent = diff >= 0 ? diff : 0;
    $('startDateText').textContent = 'ä» ' + sd + ' å¼€å§‹';
    $('startDateInput').value = sd;
  }

  // ===== ç›¸å†Œ =====
  function initAlbum() {
    var container = $('albumPages');
    container.innerHTML = '';
    for (var i = 0; i < totalPages; i++) {
      var page = document.createElement('div');
      page.className = 'album-page' + (i === 0 ? ' active' : '');
      page.id = 'albumPage' + i;
      var html = '';
      for (var j = 0; j < photosPerPage; j++) {
        var id = 'album_' + i + '_' + j;
        html += '<div class="polaroid" data-img-id="' + id + '">' +
          '<img id="' + id + '" src="" data-key="' + id + '">' +
          '<div class="upload-overlay">+</div></div>' +
          '<input type="file" id="' + id + '_input" accept="image/*" style="display:none">';
      }
      page.innerHTML = html;
      container.appendChild(page);
    }
    container.addEventListener('click', function(e) {
      var p = e.target.closest('.polaroid');
      if (p) { var inp = $(p.getAttribute('data-img-id') + '_input'); if (inp) inp.click(); }
    });
    container.addEventListener('change', function(e) {
      if (e.target.type === 'file') {
        var imgId = e.target.id.replace('_input', '');
        handleFileInput(e.target, 600, 0.7, function(url) { $(imgId).src = url; markChanged(); triggerAutoSave(); });
      }
    });
    updatePageNav();
  }

  function updatePageNav() {
    $('pageInfo').textContent = (currentPage + 1) + ' / ' + totalPages;
    $('prevPageBtn').disabled = currentPage === 0;
    $('nextPageBtn').disabled = currentPage === totalPages - 1;
  }

  function goToPage(n) {
    if (n < 0 || n >= totalPages) return;
    $('albumPage' + currentPage).classList.remove('active');
    currentPage = n;
    $('albumPage' + currentPage).classList.add('active');
    updatePageNav();
  }

  // ===== æ—¶é—´çº¿ =====
  function loadTimeline() {
    var container = $('timelineContainer');
    container.innerHTML = '';
    var saved = localStorage.getItem('loveStoryTimeline');
    var data = (saved && saved !== 'null') ? JSON.parse(saved) : [
      { id: 'tl_1', date: '2024.XX.XX', title: 'åˆæ¬¡ç›¸é‡', desc: 'çˆ¶äº²è¯·æ¥çš„å¿ƒç†åŒ»ç”Ÿ,æˆä¸ºäº†æˆ‘ç”Ÿå‘½ä¸­æœ€é‡è¦çš„äººã€‚' },
      { id: 'tl_2', date: '2024.XX.XX', title: 'æ¬è¿›ä»–çš„å®¶', desc: 'ç„å…³å¤šäº†ä¸€åŒæµ…è“è‰²çš„æ‹–é‹,è¡£æŸœå³è¾¹æŒ‚ä¸Šäº†æˆ‘çš„è¡£æœã€‚' },
      { id: 'tl_3', date: '2024.XX.XX', title: 'ç¬¬ä¸€æ¬¡è¯´å–œæ¬¢', desc: 'ä»–è¯´,ä½ æ˜¯æˆ‘æœ€é‡è¦çš„äººã€‚' }
    ];
    data.forEach(function(item) { addTimelineItem(item, container); });
  }

  function addTimelineItem(item, container) {
    var el = document.createElement('div');
    el.className = 'timeline-item';
    el.setAttribute('data-id', item.id);
    el.innerHTML = '<button class="delete-item">Ã—</button>' +
      '<div class="date editable" contenteditable="true" data-field="date">' + item.date + '</div>' +
      '<div class="title editable" contenteditable="true" data-field="title">' + item.title + '</div>' +
      '<div class="desc editable" contenteditable="true" data-field="desc">' + item.desc + '</div>';
    container.appendChild(el);
    bindEditable(el);
  }

  // ===== ç¬”è®°æœ¬ =====
  function loadNotebook() {
    var container = $('notebookContainer');
    container.innerHTML = '';
    var saved = localStorage.getItem('loveStoryNotebook');
    var data = (saved && saved !== 'null') ? JSON.parse(saved) :
      [{ id: 'nb_1', date: getTodayDot(), title: 'å†™ç»™è”šå®‰', content: 'ä»Šå¤©åˆæ˜¯è¢«ä½ æ¸©æŸ”å¯¹å¾…çš„ä¸€å¤©ã€‚\n\nè°¢è°¢ä½ ä¸€ç›´åœ¨æˆ‘èº«è¾¹ã€‚' }];
    data.forEach(function(item) { addNotebookItem(item, container); });
  }

  function addNotebookItem(item, container) {
    var entry = document.createElement('div');
    entry.className = 'notebook-entry';
    entry.setAttribute('data-id', item.id);
    var len = (item.content || '').replace(/<[^>]*>/g, '').replace(/\s/g, '').length;
    entry.innerHTML = '<div class="entry-header">' +
      '<span class="entry-date editable" contenteditable="true" data-field="date">' + item.date + '</span>' +
      '<button class="delete-entry">Ã—</button></div>' +
      '<div class="entry-title editable" contenteditable="true" data-field="title">' + item.title + '</div>' +
      '<div class="entry-content editable" contenteditable="true" data-field="content">' + item.content + '</div>' +
      '<div class="word-count">å­—æ•°: ' + len + '</div>';
    container.appendChild(entry);
    bindEditable(entry);
  }

  function bindEditable(el) {
    el.querySelectorAll('[contenteditable="true"]').forEach(function(e) {
      e.addEventListener('blur', function() { markChanged(); triggerAutoSave(); });
      e.addEventListener('input', markChanged);
    });
  }
  // ===== ä¿å­˜ =====
  function saveAllData() {
    try {
      var data = {
        version: '3.1',
        savedAt: new Date().toISOString(),
        theme: document.body.getAttribute('data-theme') || 'green'
      };

      data.mainContent = {};
      document.querySelectorAll('.container [data-key]').forEach(function(el) {
        var key = el.getAttribute('data-key');
        if (key && el.tagName !== 'IMG') data.mainContent[key] = el.innerHTML;
      });

      var mi = $('mainImg');
      if (mi && mi.src && mi.src.indexOf('data:') === 0) data.mainImg = mi.src;

      var di = $('discImg');
      if (di && di.src && di.src.indexOf('data:') === 0) data.discImg = di.src;

      var bgs = ['bodyBg', 'headerBg', 'albumBg'];
      var bgEls = [document.body, $('headerBox'), $('albumContainer')];
      bgs.forEach(function(key, i) {
        var bg = bgEls[i].style.backgroundImage;
        if (bg && bg.indexOf('data:') !== -1) data[key] = bg;
      });

      data.albumImages = {};
      document.querySelectorAll('#albumPages img[data-key]').forEach(function(img) {
        var key = img.getAttribute('data-key');
        if (key && img.src && img.src.indexOf('data:') === 0) data.albumImages[key] = img.src;
      });

      data.stickies = [];
      document.querySelectorAll('.sticky-note').forEach(function(s) {
        var t = s.querySelector('.sticky-text');
        if (t) data.stickies.push({
          color: s.className.replace('sticky-note', '').trim(),
          text: t.innerHTML,
          key: t.getAttribute('data-key')
        });
      });

      data.timeline = [];
      document.querySelectorAll('#timelineContainer .timeline-item').forEach(function(item) {
        data.timeline.push({
          id: item.getAttribute('data-id'),
          date: item.querySelector('[data-field="date"]').innerHTML,
          title: item.querySelector('[data-field="title"]').innerHTML,
          desc: item.querySelector('[data-field="desc"]').innerHTML
        });
      });

      data.notebook = [];
      document.querySelectorAll('#notebookContainer .notebook-entry').forEach(function(entry) {
        data.notebook.push({
          id: entry.getAttribute('data-id'),
          date: entry.querySelector('[data-field="date"]').innerHTML,
          title: entry.querySelector('[data-field="title"]').innerHTML,
          content: entry.querySelector('[data-field="content"]').innerHTML
        });
      });

      data.musicList = musicList;
      data.currentMusicIndex = currentMusicIndex;
      data.wishList = wishList;
      data.moodData = moodData;

      var sd = localStorage.getItem('loveStartDate');
      if (sd) data.startDate = sd;

      localStorage.setItem('loveStoryData', JSON.stringify(data));
      if (data.timeline.length > 0) localStorage.setItem('loveStoryTimeline', JSON.stringify(data.timeline));
      if (data.notebook.length > 0) localStorage.setItem('loveStoryNotebook', JSON.stringify(data.notebook));
      return true;
    } catch (e) {
      console.error('ä¿å­˜å¤±è´¥:', e);
      return false;
    }
  }

  // ===== åŠ è½½ =====
  function loadAllData() {
    try {
      var saved = localStorage.getItem('loveStoryData');
      if (!saved) return;
      var data = JSON.parse(saved);

      if (data.theme) {
        document.body.setAttribute('data-theme', data.theme);
        currentThemeIndex = themes.indexOf(data.theme);
        if (currentThemeIndex === -1) currentThemeIndex = 0;
      }

      if (data.mainContent) {
        Object.keys(data.mainContent).forEach(function(key) {
          var el = document.querySelector('.container [data-key="' + key + '"]');
          if (el && el.tagName !== 'IMG') el.innerHTML = data.mainContent[key];
        });
      }

      if (data.mainImg) $('mainImg').src = data.mainImg;
      if (data.discImg) {
        $('discImg').src = data.discImg;
        $('discImg').style.display = 'block';
        $('discPlaceholder').style.display = 'none';
      }

      if (data.bodyBg) document.body.style.backgroundImage = data.bodyBg;
      if (data.headerBg) $('headerBox').style.backgroundImage = data.headerBg;
      if (data.albumBg) $('albumContainer').style.backgroundImage = data.albumBg;

      if (data.albumImages) {
        Object.keys(data.albumImages).forEach(function(key) {
          var img = $(key);
          if (img) img.src = data.albumImages[key];
        });
      }

      if (data.stickies && data.stickies.length > 0) {
        var sc = $('stickyContainer');
        var ab = $('addStickyBtn');
        data.stickies.forEach(function(s) {
          var sticky = document.createElement('div');
          sticky.className = 'sticky-note ' + s.color;
          sticky.innerHTML = '<button class="delete-sticky">Ã—</button>' +
            '<div class="sticky-text editable" contenteditable="true" data-key="' + s.key + '">' + s.text + '</div>';
          sc.insertBefore(sticky, ab);
          bindEditable(sticky);
          stickyCount++;
        });
      }

      if (data.musicList) { musicList = data.musicList; currentMusicIndex = data.currentMusicIndex || 0; }
      if (data.wishList) wishList = data.wishList;
      if (data.moodData) {
        moodData = data.moodData;
        if (!moodData.pages) moodData.pages = [[], [], []];
        if (typeof moodData.currentPage !== 'number') moodData.currentPage = 0;
      }
      if (data.startDate) localStorage.setItem('loveStartDate', data.startDate);
    } catch (e) {
      console.error('åŠ è½½å¤±è´¥:', e);
    }
  }

  // ===== å¯¼å‡ºå¯¼å…¥ =====
  function exportData() {
    saveAllData();
    setTimeout(function() {
      try {
        var saved = localStorage.getItem('loveStoryData');
        if (!saved) { showToast('æ²¡æœ‰æ•°æ®'); return; }
        var blob = new Blob([saved], { type: 'application/json;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'æˆ‘ä»¬çš„æ•…äº‹_' + getToday() + '.json';
        document.body.appendChild(a);
        a.click();
        setTimeout(function() { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
        showToast('æ•°æ®å·²å¯¼å‡º â™¥');
      } catch (e) { showToast('å¯¼å‡ºå¤±è´¥'); }
    }, 300);
  }

  function importData(input) {
    if (!input.files || !input.files[0]) return;
    showLoading();
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = JSON.parse(e.target.result);
        if (!data.version) { hideLoading(); showToast('æ— æ•ˆæ•°æ®æ–‡ä»¶'); return; }
        localStorage.setItem('loveStoryData', e.target.result);
        if (data.startDate) localStorage.setItem('loveStartDate', data.startDate);
        if (data.timeline) localStorage.setItem('loveStoryTimeline', JSON.stringify(data.timeline));
        if (data.notebook) localStorage.setItem('loveStoryNotebook', JSON.stringify(data.notebook));
        if (data.theme) localStorage.setItem('currentTheme', data.theme);
        setTimeout(function() { location.reload(); }, 1500);
      } catch (err) { hideLoading(); showToast('æ•°æ®æ ¼å¼é”™è¯¯'); }
    };
    reader.onerror = function() { hideLoading(); showToast('è¯»å–å¤±è´¥'); };
    reader.readAsText(input.files[0]);
    input.value = '';
  }
  // ===== äº‹ä»¶ç›‘å¬ =====
  function initEvents() {
    $('themeBtn').addEventListener('click', changeTheme);

    $('bgBtn').addEventListener('click', function() { $('bgInput').click(); });
    $('bgInput').addEventListener('change', function() {
      handleFileInput(this, 1200, 0.7, function(url) {
        document.body.style.backgroundImage = 'url(' + url + ')';
        markChanged(); triggerAutoSave();
      });
    });

    $('headerBgBtn').addEventListener('click', function() { $('headerBgInput').click(); });
    $('headerBgInput').addEventListener('change', function() {
      handleFileInput(this, 800, 0.7, function(url) {
        $('headerBox').style.backgroundImage = 'url(' + url + ')';
        markChanged(); triggerAutoSave();
      });
    });

    $('mainPhotoWrapper').addEventListener('click', function() { $('mainPhotoInput').click(); });
    $('mainPhotoInput').addEventListener('change', function() {
      handleFileInput(this, 800, 0.8, function(url) {
        $('mainImg').src = url;
        markChanged(); triggerAutoSave();
      });
    });

    $('startDateInput').addEventListener('change', function() {
      if (this.value) {
        localStorage.setItem('loveStartDate', this.value);
        updateDaysCount();
        markChanged(); triggerAutoSave();
      }
    });

    $('albumBook').addEventListener('click', function() {
      $('albumModal').classList.add('open');
      document.body.style.overflow = 'hidden';
    });
    $('closeAlbumBtn').addEventListener('click', function() {
      $('albumModal').classList.remove('open');
      document.body.style.overflow = '';
    });
    $('albumBgBtn').addEventListener('click', function() { $('albumBgInput').click(); });
    $('albumBgInput').addEventListener('change', function() {
      handleFileInput(this, 800, 0.7, function(url) {
        $('albumContainer').style.backgroundImage = 'url(' + url + ')';
        markChanged(); triggerAutoSave();
      });
    });
    $('prevPageBtn').addEventListener('click', function() { goToPage(currentPage - 1); });
    $('nextPageBtn').addEventListener('click', function() { goToPage(currentPage + 1); });

    // æ—¶é—´çº¿
    $('timelineCard').addEventListener('click', function() {
      $('timelineModal').classList.add('open');
      document.body.style.overflow = 'hidden';
      loadTimeline();
    });
    $('closeTimelineBtn').addEventListener('click', function() {
      $('timelineModal').classList.remove('open');
      document.body.style.overflow = '';
      if (hasUnsavedChanges) { saveAllData(); showAutoSave(); hasUnsavedChanges = false; }
    });
    $('addTimelineBtn').addEventListener('click', function() {
      addTimelineItem({ id: 'tl_' + Date.now(), date: getTodayDot(), title: 'æ–°çš„æ—¶åˆ»', desc: 'è®°å½•è¿™ä¸€å¤©...' }, $('timelineContainer'));
      markChanged(); triggerAutoSave();
    });
    $('timelineContainer').addEventListener('click', function(e) {
      if (e.target.classList.contains('delete-item')) {
        if (confirm('ç¡®å®šåˆ é™¤?')) { e.target.parentElement.remove(); markChanged(); triggerAutoSave(); }
      }
    });

    // ç¬”è®°æœ¬
    $('notebookCard').addEventListener('click', function() {
      $('notebookModal').classList.add('open');
      document.body.style.overflow = 'hidden';
      loadNotebook();
    });
    $('closeNotebookBtn').addEventListener('click', function() {
      $('notebookModal').classList.remove('open');
      document.body.style.overflow = '';
      if (hasUnsavedChanges) { saveAllData(); showAutoSave(); hasUnsavedChanges = false; }
    });
    $('addNotebookBtn').addEventListener('click', function() {
      var container = $('notebookContainer');
      var item = { id: 'nb_' + Date.now(), date: getTodayDot(), title: 'æ— é¢˜', content: 'åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å¿ƒæƒ…...' };
      var entry = document.createElement('div');
      entry.className = 'notebook-entry';
      entry.setAttribute('data-id', item.id);
      entry.innerHTML = '<div class="entry-header">' +
        '<span class="entry-date editable" contenteditable="true" data-field="date">' + item.date + '</span>' +
        '<button class="delete-entry">Ã—</button></div>' +
        '<div class="entry-title editable" contenteditable="true" data-field="title">' + item.title + '</div>' +
        '<div class="entry-content editable" contenteditable="true" data-field="content">' + item.content + '</div>' +
        '<div class="word-count">å­—æ•°: 12</div>';
      container.insertBefore(entry, container.firstChild);
      bindEditable(entry);
      markChanged(); triggerAutoSave();
    });
    $('notebookContainer').addEventListener('click', function(e) {
      if (e.target.classList.contains('delete-entry')) {
        if (confirm('ç¡®å®šåˆ é™¤?')) { e.target.closest('.notebook-entry').remove(); markChanged(); triggerAutoSave(); }
      }
    });
    $('notebookContainer').addEventListener('input', function(e) {
      if (e.target.getAttribute('data-field') === 'content') {
        var len = (e.target.innerText || '').replace(/\s/g, '').length;
        var wc = e.target.parentElement.querySelector('.word-count');
        if (wc) wc.textContent = 'å­—æ•°: ' + len;
      }
    });

    // ä¾¿ç­¾
    $('addStickyBtn').addEventListener('click', function() {
      var sc = $('stickyContainer');
      var color = stickyColors[stickyCount % 4];
      stickyCount++;
      var sticky = document.createElement('div');
      sticky.className = 'sticky-note ' + color;
      sticky.innerHTML = '<button class="delete-sticky">Ã—</button>' +
        '<div class="sticky-text editable" contenteditable="true" data-key="sticky_' + Date.now() + '">å†™ç‚¹ä»€ä¹ˆ...</div>';
      sc.insertBefore(sticky, this);
      bindEditable(sticky);
      markChanged(); triggerAutoSave();
    });
    $('stickyContainer').addEventListener('click', function(e) {
      if (e.target.classList.contains('delete-sticky')) {
        if (confirm('åˆ é™¤ä¾¿ç­¾?')) { e.target.parentElement.remove(); markChanged(); triggerAutoSave(); }
      }
    });

    // å¯¼å…¥å¯¼å‡º
    $('exportBtn').addEventListener('click', exportData);
    $('importBtn').addEventListener('click', function() { $('importInput').click(); });
    $('importInput').addEventListener('change', function() { importData(this); });

    // ä¸»é¡µå¯ç¼–è¾‘åŒºåŸŸ
    document.querySelectorAll('.container [contenteditable="true"]').forEach(function(el) {
      el.addEventListener('blur', function() { markChanged(); triggerAutoSave(); });
      el.addEventListener('input', markChanged);
    });

    // è®¸æ„¿ç“¶å®šæ—¶æ£€æŸ¥
    setInterval(checkWishNotifications, 60000);
  }

  // ===== åˆå§‹åŒ– =====
  function init() {
    loadTheme();
    initParticles();
    initCover();
    initAlbum();
    loadAllData();
    updateDaysCount();
    initMusicPlayer();
    initWishBottle();
    initMoodChart();
    initEvents();
    setInterval(updateDaysCount, 60000);
  }

  window.addEventListener('beforeunload', function() {
    if (hasUnsavedChanges) saveAllData();
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>